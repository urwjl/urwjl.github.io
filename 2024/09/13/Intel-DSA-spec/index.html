<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="1. 介绍本文档介绍了英特尔® 数据流加速器 (英特尔® DSA) 的架构，包括第二代英特尔 DSA 中的扩展。英特尔 DSA 是一款高性能数据复制和转换加速器，将集成到未来的英特尔® 处理器中，旨在优化高性能存储、网络、持久内存和各种数据处理应用中常见的流数据移动和转换操作。英特尔 DSA 取代了英特尔® QuickData 技术，后者是英特尔® I&#x2F;O 加速技术的一部分。 1.1 受">
<meta property="og:type" content="article">
<meta property="og:title" content="intel-data-streaming-accelerator-spec">
<meta property="og:url" content="http://example.com/2024/09/13/Intel-DSA-spec/index.html">
<meta property="og:site_name" content="WJL&#39;s Blog">
<meta property="og:description" content="1. 介绍本文档介绍了英特尔® 数据流加速器 (英特尔® DSA) 的架构，包括第二代英特尔 DSA 中的扩展。英特尔 DSA 是一款高性能数据复制和转换加速器，将集成到未来的英特尔® 处理器中，旨在优化高性能存储、网络、持久内存和各种数据处理应用中常见的流数据移动和转换操作。英特尔 DSA 取代了英特尔® QuickData 技术，后者是英特尔® I&#x2F;O 加速技术的一部分。 1.1 受">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726210851924.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240415193624263-0.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726211241453.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726211265893.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726211524055.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726213805355.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726278790175.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726279498210.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726279686703.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726279698135.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726279716416.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280116203.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280146197.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280172156.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280203522.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280233191.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280244152.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280470945.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280482020.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280516092.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280536974.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280602575.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280617553.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726280637047.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726281062859.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240914104553708.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726708411986.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726708506596.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726708769213.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726709151406.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726709372204.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919093136233.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919093229885.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919093430977.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919093450213.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919093920311.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919094400832.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919094417644.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101000326.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101357394.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101524033.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101546165.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101713566.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101722698.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101814894.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101845895.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101857936.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101930835.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919101946986.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102021301.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102102609.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102232395.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102320112.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102327719.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102344449.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102413944.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102446116.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102453572.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102537533.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102614846.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102623729.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102816563.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102845652.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919102940807.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103023322.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103044376.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103059588.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103106277.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103146793.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103214698.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103227943.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103300471.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103319123.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103630388.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103708244.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103744076.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103753656.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103824939.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103832405.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103905812.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919103912256.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104125634.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104134633.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104213711.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104225252.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104306156.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104316353.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104327669.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104340085.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104458048.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104508760.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919104832619.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919105431089.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919105628122.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919105737220.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919105816519.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919105906256.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110214953.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110231094.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110246581.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110310341.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110318210.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110335289.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110355435.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110417459.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110441286.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110503166.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110521775.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110539006.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919110558930.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111006252.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111023634.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111051529.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111141229.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111214732.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111226654.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111342909.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111405334.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111425525.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111518450.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111538299.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111607576.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111629911.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111655942.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111718412.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111744301.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111831651.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111851352.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919111911459.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112002823.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112031251.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112052089.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112126932.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112146810.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112224989.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112327298.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112342413.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112351466.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112414461.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112441641.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112500461.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112519226.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112538641.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112603309.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112619601.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112647434.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112658625.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919112756928.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919113009871.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919113045068.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919113224863.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919113244601.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919113321434.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919113340382.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919134157449.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919134745366.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919134804392.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919135328217.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919135455518.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919135640458.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240919135736701.png">
<meta property="og:image" content="http://example.com/2024/09/13/Intel-DSA-spec/image-20240925125819209.png">
<meta property="article:published_time" content="2024-09-13T07:30:00.000Z">
<meta property="article:modified_time" content="2024-09-26T05:46:07.065Z">
<meta property="article:author" content="Wu JInlin">
<meta property="article:tag" content="intel">
<meta property="article:tag" content="DSA">
<meta property="article:tag" content="PCIe">
<meta property="article:tag" content="DMA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/09/13/Intel-DSA-spec/QQ_1726210851924.png">


<link rel="canonical" href="http://example.com/2024/09/13/Intel-DSA-spec/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2024/09/13/Intel-DSA-spec/","path":"2024/09/13/Intel-DSA-spec/","title":"intel-data-streaming-accelerator-spec"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>intel-data-streaming-accelerator-spec | WJL's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">WJL's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">1. 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%8F%97%E4%BC%97"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 受众</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 参考文献</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E6%A6%82%E8%BF%B0"><span class="nav-number">2.</span> <span class="nav-text">2. 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 高级用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E8%8B%B1%E7%89%B9%E5%B0%94%C2%AE-DSA-%E7%89%B9%E6%80%A7"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 英特尔® DSA 特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E7%89%B9%E7%82%B9"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 基础设施特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 数据操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link"><span class="nav-number">2.2.2.0.1.</span> <span class="nav-text">Table 2-1： Intel DSA Data Operations </span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-%E6%8E%A7%E5%88%B6%E6%93%8D%E4%BD%9C"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.2.3 控制操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link"><span class="nav-number">2.2.3.0.1.</span> <span class="nav-text">Table 2-2: Intel® DSA Control Operations</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E8%8B%B1%E7%89%B9%E5%B0%94%C2%AE-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%8A%A0%E9%80%9F%E5%99%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">3 英特尔® 数据流加速器架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%AF%84%E5%AD%98%E5%99%A8%E5%92%8C%E8%BD%AF%E4%BB%B6%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 寄存器和软件编程接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 描述符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 工作队列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E5%85%B1%E4%BA%AB%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%EF%BC%88SWQ%EF%BC%89"><span class="nav-number">3.3.1.</span> <span class="nav-text">3.3.1 共享工作队列（SWQ）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E4%B8%93%E7%94%A8%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%EF%BC%88DWQ%EF%BC%89"><span class="nav-number">3.3.2.</span> <span class="nav-text">3.3.2 专用工作队列（DWQ）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E5%BC%95%E6%93%8E%E5%92%8C%E7%BB%84"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 引擎和组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%A4%84%E7%90%86"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 描述符处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%AE%8C%E6%88%90"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 描述符完成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E4%B8%AD%E6%96%AD"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 中断</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-%E6%89%B9%E9%87%8F%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%A4%84%E7%90%86"><span class="nav-number">3.8.</span> <span class="nav-text">3.8 批量描述符处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-%E6%8E%92%E5%BA%8F%E5%92%8C%E9%9A%94%E7%A6%BB"><span class="nav-number">3.9.</span> <span class="nav-text">3.9 排序和隔离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-10-%E6%8C%81%E4%B9%85%E5%86%85%E5%AD%98%E6%94%AF%E6%8C%81"><span class="nav-number">3.10.</span> <span class="nav-text">3.10 持久内存支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-11-%E7%BC%93%E5%AD%98%E6%8E%A7%E5%88%B6"><span class="nav-number">3.11.</span> <span class="nav-text">3.11 缓存控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-12-Drain-%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-number">3.12.</span> <span class="nav-text">3.12 Drain 描述符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-13-%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="nav-number">3.13.</span> <span class="nav-text">3.13 地址转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-13-1-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E6%8E%A7%E5%88%B6"><span class="nav-number">3.13.1.</span> <span class="nav-text">3.13.1 工作队列地址转换控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-13-2-%E5%90%AF%E7%94%A8-PRS-%E7%9A%84%E9%A1%B5%E9%9D%A2%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">3.13.2.</span> <span class="nav-text">3.13.2 启用 PRS 的页面错误处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-13-3-PRS-%E7%A6%81%E7%94%A8%E6%97%B6%E7%9A%84%E9%A1%B5%E9%9D%A2%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">3.13.3.</span> <span class="nav-text">3.13.3 PRS 禁用时的页面错误处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-14-%E5%9F%9F%E9%97%B4%E6%93%8D%E4%BD%9C"><span class="nav-number">3.14.</span> <span class="nav-text">3.14 域间操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-14-1-%E5%9F%9F%E9%97%B4%E6%9D%83%E9%99%90%E8%A1%A8%EF%BC%88IDPT%EF%BC%89"><span class="nav-number">3.14.1.</span> <span class="nav-text">3.14.1 域间权限表（IDPT）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-14-2-%E6%8F%90%E4%BA%A4%E8%80%85%E4%BD%8D%E5%9B%BE"><span class="nav-number">3.14.2.</span> <span class="nav-text">3.14.2 提交者位图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-14-3-%E5%86%85%E5%AD%98%E7%AA%97%E5%8F%A3"><span class="nav-number">3.14.3.</span> <span class="nav-text">3.14.3 内存窗口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-14-4-%E5%86%85%E5%AD%98%E7%AA%97%E5%8F%A3%E4%BF%AE%E6%94%B9"><span class="nav-number">3.14.4.</span> <span class="nav-text">3.14.4 内存窗口修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-15-%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4"><span class="nav-number">3.15.</span> <span class="nav-text">3.15 管理命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E7%A9%BA%E5%92%8C%E4%B8%AD%E6%AD%A2%E5%91%BD%E4%BB%A4"><span class="nav-number">3.15.0.1.</span> <span class="nav-text">排空和中止命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E7%A9%BA%E5%92%8C%E4%B8%AD%E6%AD%A2%E5%91%BD%E4%BB%A4%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8"><span class="nav-number">3.15.0.2.</span> <span class="nav-text">排空和中止命令的软件使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-16-%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">3.16.</span> <span class="nav-text">3.16 虚拟化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-number">4.</span> <span class="nav-text">4 服务质量控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E5%B7%A5%E4%BD%9C%E6%B4%BE%E9%81%A3%E4%BC%98%E5%85%88"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 工作派遣优先</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E6%B5%81%E9%87%8F%E7%B1%BB%E5%88%AB"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 流量类别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E8%AF%BB%E5%8F%96%E7%BC%93%E5%86%B2%E5%8C%BA%E5%88%86%E9%85%8D"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 读取缓冲区分配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E5%BB%B6%E8%BF%9F%E6%8E%A7%E5%88%B6"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 延迟控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-%E4%BD%8E%E5%B8%A6%E5%AE%BD%E5%86%85%E5%AD%98"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 低带宽内存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">5 错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E8%AE%BE%E5%A4%87%E5%90%AF%E7%94%A8%E6%A3%80%E6%9F%A5"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 设备启用检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-WQ-%E5%90%AF%E7%94%A8%E6%A3%80%E6%9F%A5"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 WQ 启用检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%8F%90%E4%BA%A4%E6%A3%80%E6%9F%A5"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 描述符提交检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%A3%80%E6%9F%A5"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 描述符检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%BF%9D%E7%95%99%E5%AD%97%E6%AE%B5%E6%A3%80%E6%9F%A5"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 描述符保留字段检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-%E5%9F%9F%E9%97%B4%E6%9D%83%E9%99%90%E8%A1%A8%E6%9D%A1%E7%9B%AE%E6%A3%80%E6%9F%A5"><span class="nav-number">5.6.</span> <span class="nav-text">5.6 域间权限表条目检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-7-%E8%AE%BE%E5%A4%87%E6%9A%82%E5%81%9C%E7%8A%B6%E6%80%81"><span class="nav-number">5.7.</span> <span class="nav-text">5.7 设备暂停状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-8-%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81"><span class="nav-number">5.8.</span> <span class="nav-text">5.8 错误代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-8-1-%E6%93%8D%E4%BD%9C%E7%8A%B6%E6%80%81%E4%BB%A3%E7%A0%81"><span class="nav-number">5.8.1.</span> <span class="nav-text">5.8.1 操作状态代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-8-2-%E5%85%B6%E4%BB%96%E8%BD%AF%E4%BB%B6%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81"><span class="nav-number">5.8.2.</span> <span class="nav-text">5.8.2 其他软件错误代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-9-%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97"><span class="nav-number">5.9.</span> <span class="nav-text">5.9 事件日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-9-1-%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E6%9D%A1%E7%9B%AE"><span class="nav-number">5.9.1.</span> <span class="nav-text">5.9.1 事件日志条目</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="nav-number">6.</span> <span class="nav-text">6 性能监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-Perfmon-%E5%8F%91%E7%8E%B0%E5%92%8C%E6%9E%9A%E4%B8%BE"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 Perfmon 发现和枚举</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-Perfmon-%E9%85%8D%E7%BD%AE%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 Perfmon 配置寄存器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-%E4%BA%8B%E4%BB%B6%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 事件计数器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-%E8%AE%A1%E6%95%B0%E5%99%A8%E6%BA%A2%E5%87%BA"><span class="nav-number">6.3.1.</span> <span class="nav-text">6.3.1 计数器溢出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-%E8%AE%A1%E6%95%B0%E5%99%A8%E5%81%9C%E6%AD%A2%E5%92%8C%E6%81%A2%E5%A4%8D"><span class="nav-number">6.3.2.</span> <span class="nav-text">6.3.2 计数器停止和恢复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%94%AF%E6%8C%81"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 过滤器支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-%E4%BA%8B%E4%BB%B6%E7%BC%96%E7%A8%8B%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">6.5.</span> <span class="nav-text">6.5 事件编程注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6-%E4%B8%AD%E6%96%AD%E4%BA%A7%E7%94%9F"><span class="nav-number">6.6.</span> <span class="nav-text">6.6 中断产生</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E5%8F%82%E8%80%83%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="nav-number">7.</span> <span class="nav-text">7 参考软件架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%BC%8F%E9%A9%B1%E5%8A%A8"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 内核模式驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-%E7%94%A8%E6%88%B7%E6%80%81%E9%A9%B1%E5%8A%A8"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 用户态驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-%E5%A4%84%E7%90%86%E9%9D%9E%E9%98%BB%E5%A1%9E%E9%A1%B5%E9%9D%A2%E9%94%99%E8%AF%AF%E7%9A%84%E8%BD%AF%E4%BB%B6%E8%A6%81%E6%B1%82"><span class="nav-number">7.3.</span> <span class="nav-text">7.3 处理非阻塞页面错误的软件要求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-%E8%B7%A8%E5%9F%9F%E4%BD%9C%E6%88%98%E7%9A%84%E8%BD%AF%E4%BB%B6%E8%A6%81%E6%B1%82"><span class="nav-number">7.4.</span> <span class="nav-text">7.4 跨域作战的软件要求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5-%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BD%AF%E4%BB%B6"><span class="nav-number">7.5.</span> <span class="nav-text">7.5 虚拟化软件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-1-%E8%99%9A%E6%8B%9F%E8%8B%B1%E7%89%B9%E5%B0%94%C2%AE-DSA-%E8%AE%BE%E5%A4%87"><span class="nav-number">7.5.1.</span> <span class="nav-text">7.5.1 虚拟英特尔® DSA 设备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-2-%E9%97%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">7.5.2.</span> <span class="nav-text">7.5.2 门户虚拟化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-3-SVM-%E5%92%8C-PASID-%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">7.5.3.</span> <span class="nav-text">7.5.3 SVM 和 PASID 虚拟化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-4-%E4%B8%AD%E6%96%AD%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">7.5.4.</span> <span class="nav-text">7.5.4 中断虚拟化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-5-Capability-%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">7.5.5.</span> <span class="nav-text">7.5.5 Capability 虚拟化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-6-%E5%9F%9F%E9%97%B4%E7%89%B9%E5%BE%81%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">7.5.6.</span> <span class="nav-text">7.5.6 域间特征虚拟化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-7-VM%E8%BF%81%E7%A7%BB%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E7%8A%B6%E6%80%81%E8%BF%81%E7%A7%BB"><span class="nav-number">7.5.7.</span> <span class="nav-text">7.5.7 VM迁移过程中的状态迁移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-8-%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">7.5.8.</span> <span class="nav-text">7.5.8 事件日志虚拟化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E8%AE%BF%E5%AE%A2%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E5%B7%B2%E6%BB%A1%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">7.5.8.1.</span> <span class="nav-text">处理访客事件日志已满的情况</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%A0%BC%E5%BC%8F"><span class="nav-number">8.</span> <span class="nav-text">8 描述符格式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E9%80%9A%E7%94%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%AD%97%E6%AE%B5"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 通用描述符字段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-%E5%8F%AF%E4%BF%A1%E5%AD%97%E6%AE%B5"><span class="nav-number">8.1.1.</span> <span class="nav-text">8.1.1 可信字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-%E6%93%8D%E4%BD%9C"><span class="nav-number">8.1.2.</span> <span class="nav-text">8.1.2 操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-3-%E6%A0%87%E5%BF%97"><span class="nav-number">8.1.3.</span> <span class="nav-text">8.1.3 标志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-4-%E5%AE%8C%E6%88%90%E8%AE%B0%E5%BD%95%E5%9C%B0%E5%9D%80"><span class="nav-number">8.1.4.</span> <span class="nav-text">8.1.4 完成记录地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-5-%E6%BA%90%E5%9C%B0%E5%9D%80"><span class="nav-number">8.1.5.</span> <span class="nav-text">8.1.5 源地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-6-%E7%9B%AE%E6%A0%87%E5%9C%B0%E5%9D%80"><span class="nav-number">8.1.6.</span> <span class="nav-text">8.1.6 目标地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-7-%E4%BC%A0%E8%BE%93%E5%A4%A7%E5%B0%8F"><span class="nav-number">8.1.7.</span> <span class="nav-text">8.1.7 传输大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-8-%E5%AE%8C%E6%88%90%E4%B8%AD%E6%96%AD%E5%8F%A5%E6%9F%84"><span class="nav-number">8.1.8.</span> <span class="nav-text">8.1.8 完成中断句柄</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-%E5%AE%8C%E6%88%90%E8%AE%B0%E5%BD%95"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 完成记录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1-%E7%8A%B6%E6%80%81"><span class="nav-number">8.2.1.</span> <span class="nav-text">8.2.1 状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-2-%E7%BB%93%E6%9E%9C"><span class="nav-number">8.2.2.</span> <span class="nav-text">8.2.2 结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-3-%E6%95%85%E9%9A%9C%E4%BF%A1%E6%81%AF"><span class="nav-number">8.2.3.</span> <span class="nav-text">8.2.3 故障信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-4-%E5%AE%8C%E6%88%90%E7%9A%84%E5%AD%97%E8%8A%82%E6%95%B0"><span class="nav-number">8.2.4.</span> <span class="nav-text">8.2.4 完成的字节数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-5-%E6%95%85%E9%9A%9C%E5%9C%B0%E5%9D%80"><span class="nav-number">8.2.5.</span> <span class="nav-text">8.2.5 故障地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-6-%E6%97%A0%E6%95%88%E6%A0%87%E5%BF%97"><span class="nav-number">8.2.6.</span> <span class="nav-text">8.2.6 无效标志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%B1%BB%E5%9E%8B"><span class="nav-number">8.3.</span> <span class="nav-text">8.3 描述符类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-1-%E6%97%A0%E6%93%8D%E4%BD%9C"><span class="nav-number">8.3.1.</span> <span class="nav-text">8.3.1 无操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-2-%E6%89%B9%E5%A4%84%E7%90%86"><span class="nav-number">8.3.2.</span> <span class="nav-text">8.3.2 批处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-3-%E6%8E%92%E7%A9%BA"><span class="nav-number">8.3.3.</span> <span class="nav-text">8.3.3 排空</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-4-%E5%86%85%E5%AD%98%E7%A7%BB%E5%8A%A8"><span class="nav-number">8.3.4.</span> <span class="nav-text">8.3.4 内存移动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-5-%E5%A1%AB%E5%85%85"><span class="nav-number">8.3.5.</span> <span class="nav-text">8.3.5 填充</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-6-%E6%AF%94%E8%BE%83"><span class="nav-number">8.3.6.</span> <span class="nav-text">8.3.6 比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-7-%E6%AF%94%E8%BE%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">8.3.7.</span> <span class="nav-text">8.3.7 比较模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-8-%E5%88%9B%E5%BB%BA%E5%A2%9E%E9%87%8F%E8%AE%B0%E5%BD%95"><span class="nav-number">8.3.8.</span> <span class="nav-text">8.3.8 创建增量记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-9-%E5%BA%94%E7%94%A8%E5%A2%9E%E9%87%8F%E8%AE%B0%E5%BD%95"><span class="nav-number">8.3.9.</span> <span class="nav-text">8.3.9 应用增量记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-10-%E5%8F%8C%E6%92%AD%E5%86%85%E5%AD%98%E5%A4%8D%E5%88%B6"><span class="nav-number">8.3.10.</span> <span class="nav-text">8.3.10 双播内存复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-11-%E7%BF%BB%E8%AF%91%E8%8E%B7%E5%8F%96"><span class="nav-number">8.3.11.</span> <span class="nav-text">8.3.11 翻译获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-12-CRC-%E7%94%9F%E6%88%90"><span class="nav-number">8.3.12.</span> <span class="nav-text">8.3.12 CRC 生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-13-%E5%B8%A6-CRC-%E7%94%9F%E6%88%90%E7%9A%84%E5%A4%8D%E5%88%B6"><span class="nav-number">8.3.13.</span> <span class="nav-text">8.3.13 带 CRC 生成的复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-14-DIF-%E6%A3%80%E6%9F%A5"><span class="nav-number">8.3.14.</span> <span class="nav-text">8.3.14 DIF 检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-15-DIF-%E6%8F%92%E5%85%A5"><span class="nav-number">8.3.15.</span> <span class="nav-text">8.3.15 DIF 插入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-16-DIF-Strip"><span class="nav-number">8.3.16.</span> <span class="nav-text">8.3.16 DIF Strip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-17-DIF-%E6%9B%B4%E6%96%B0"><span class="nav-number">8.3.17.</span> <span class="nav-text">8.3.17 DIF 更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-17-1-DIF-%E6%A0%87%E5%BF%97"><span class="nav-number">8.3.17.1.</span> <span class="nav-text">8.3.17.1 DIF 标志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-17-2-%E6%BA%90-DIF-%E6%A0%87%E5%BF%97"><span class="nav-number">8.3.17.2.</span> <span class="nav-text">8.3.17.2 源 DIF 标志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-17-3-%E7%9B%AE%E6%A0%87-DIF-%E6%A0%87%E5%BF%97"><span class="nav-number">8.3.17.3.</span> <span class="nav-text">8.3.17.3 目标 DIF 标志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-17-4-DIF-%E7%8A%B6%E6%80%81"><span class="nav-number">8.3.17.4.</span> <span class="nav-text">8.3.17.4 DIF 状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-18-DIX-%E7%94%9F%E6%88%90"><span class="nav-number">8.3.18.</span> <span class="nav-text">8.3.18 DIX 生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-19-%E7%BC%93%E5%AD%98%E5%88%B7%E6%96%B0"><span class="nav-number">8.3.19.</span> <span class="nav-text">8.3.19 缓存刷新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-20-%E8%B7%A8%E5%9F%9F%E6%93%8D%E4%BD%9C"><span class="nav-number">8.3.20.</span> <span class="nav-text">8.3.20 跨域操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-1-%E9%80%9A%E7%94%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%A0%BC%E5%BC%8F"><span class="nav-number">8.3.20.1.</span> <span class="nav-text">8.3.20.1 通用描述符格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-2-%E5%AE%8C%E6%88%90%E8%AE%B0%E5%BD%95"><span class="nav-number">8.3.20.2.</span> <span class="nav-text">8.3.20.2 完成记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-3-%E5%9F%9F%E9%97%B4%E5%A4%8D%E5%88%B6"><span class="nav-number">8.3.20.3.</span> <span class="nav-text">8.3.20.3 域间复制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-4-%E5%9F%9F%E9%97%B4%E5%A1%AB%E5%85%85"><span class="nav-number">8.3.20.4.</span> <span class="nav-text">8.3.20.4 域间填充</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-5-%E5%9F%9F%E9%97%B4%E6%AF%94%E8%BE%83"><span class="nav-number">8.3.20.5.</span> <span class="nav-text">8.3.20.5 域间比较</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-6-%E5%9F%9F%E9%97%B4%E6%AF%94%E8%BE%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">8.3.20.6.</span> <span class="nav-text">8.3.20.6 域间比较模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-7-%E5%9F%9F%E9%97%B4%E7%BC%93%E5%AD%98%E5%88%B7%E6%96%B0"><span class="nav-number">8.3.20.7.</span> <span class="nav-text">8.3.20.7 域间缓存刷新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-20-8-%E6%9B%B4%E6%96%B0%E7%AA%97%E5%8F%A3"><span class="nav-number">8.3.20.8.</span> <span class="nav-text">8.3.20.8 更新窗口</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-%E5%AF%84%E5%AD%98%E5%99%A8%E8%AF%B4%E6%98%8E"><span class="nav-number">9.</span> <span class="nav-text">9 寄存器说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-PCI-%E9%85%8D%E7%BD%AE%E7%A9%BA%E9%97%B4%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">9.1.</span> <span class="nav-text">9.1 PCI 配置空间寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-1-%E5%9F%BA%E5%9C%B0%E5%9D%80%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88BAR%EF%BC%89"><span class="nav-number">9.1.1.</span> <span class="nav-text">9.1.1 基地址寄存器（BAR）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-1-1-BAR0%EF%BC%88%E8%AE%BE%E5%A4%87%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%89"><span class="nav-number">9.1.1.1.</span> <span class="nav-text">9.1.1.1 BAR0（设备控制寄存器）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-1-2-BAR2%EF%BC%88Portals%EF%BC%89"><span class="nav-number">9.1.1.2.</span> <span class="nav-text">9.1.1.2 BAR2（Portals）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-2-MSI-X-%E5%8A%9F%E8%83%BD"><span class="nav-number">9.1.2.</span> <span class="nav-text">9.1.2 MSI-X 功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-3-%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E5%8A%9F%E8%83%BD"><span class="nav-number">9.1.3.</span> <span class="nav-text">9.1.3 地址转换功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-3-1-PASID-%E8%83%BD%E5%8A%9B"><span class="nav-number">9.1.3.1.</span> <span class="nav-text">9.1.3.1 PASID 能力</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-3-2-ATS-%E8%83%BD%E5%8A%9B"><span class="nav-number">9.1.3.2.</span> <span class="nav-text">9.1.3.2 ATS 能力</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-3-3-PRS-%E8%83%BD%E5%8A%9B"><span class="nav-number">9.1.3.3.</span> <span class="nav-text">9.1.3.3 PRS 能力</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-4-%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84-I-O-%E8%99%9A%E6%8B%9F%E5%8C%96%E8%83%BD%E5%8A%9B"><span class="nav-number">9.1.4.</span> <span class="nav-text">9.1.4 可扩展的 I&#x2F;O 虚拟化能力</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-5-VC-%E8%83%BD%E5%8A%9B"><span class="nav-number">9.1.5.</span> <span class="nav-text">9.1.5 VC 能力</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-%E9%85%8D%E7%BD%AE%E5%92%8C%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88BAR0%EF%BC%89"><span class="nav-number">9.2.</span> <span class="nav-text">9.2 配置和控制寄存器（BAR0）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-1-%E7%89%88%E6%9C%AC%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88VERSION%EF%BC%89"><span class="nav-number">9.2.1.</span> <span class="nav-text">9.2.1 版本寄存器（VERSION）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-2-%E9%80%9A%E7%94%A8%E5%8A%9F%E8%83%BD%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88GENCAP%EF%BC%89"><span class="nav-number">9.2.2.</span> <span class="nav-text">9.2.2 通用功能寄存器（GENCAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-3-WQ-%E5%8A%9F%E8%83%BD%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88WQCAP%EF%BC%89"><span class="nav-number">9.2.3.</span> <span class="nav-text">9.2.3 WQ 功能寄存器（WQCAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-4-%E7%BB%84%E8%83%BD%E5%8A%9B%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88GRPCAP%EF%BC%89"><span class="nav-number">9.2.4.</span> <span class="nav-text">9.2.4 组能力寄存器（GRPCAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-5-%E5%8F%91%E5%8A%A8%E6%9C%BA%E8%83%BD%E5%8A%9B%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88ENGCAP%EF%BC%89"><span class="nav-number">9.2.5.</span> <span class="nav-text">9.2.5 发动机能力寄存器（ENGCAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-6-%E6%93%8D%E4%BD%9C%E8%83%BD%E5%8A%9B%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88OPCAP%EF%BC%89"><span class="nav-number">9.2.6.</span> <span class="nav-text">9.2.6 操作能力寄存器（OPCAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-7-%E8%A1%A8%E5%81%8F%E7%A7%BB%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88OFFSETS%EF%BC%89"><span class="nav-number">9.2.7.</span> <span class="nav-text">9.2.7 表偏移寄存器（OFFSETS）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-8-%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88GENCFG%EF%BC%89"><span class="nav-number">9.2.8.</span> <span class="nav-text">9.2.8 通用配置寄存器（GENCFG）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-9-%E9%80%9A%E7%94%A8%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88GENCTRL%EF%BC%89"><span class="nav-number">9.2.9.</span> <span class="nav-text">9.2.9 通用控制寄存器（GENCTRL）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-10-%E9%80%9A%E7%94%A8%E7%8A%B6%E6%80%81%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88GENSTS%EF%BC%89"><span class="nav-number">9.2.10.</span> <span class="nav-text">9.2.10 通用状态寄存器（GENSTS）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-11-%E4%B8%AD%E6%96%AD%E5%8E%9F%E5%9B%A0%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88INTCAUSE%EF%BC%89"><span class="nav-number">9.2.11.</span> <span class="nav-text">9.2.11 中断原因寄存器（INTCAUSE）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-12-%E5%91%BD%E4%BB%A4%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88CMD%EF%BC%89"><span class="nav-number">9.2.12.</span> <span class="nav-text">9.2.12 命令寄存器（CMD）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-13-%E5%91%BD%E4%BB%A4%E7%8A%B6%E6%80%81%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88CMDSTATUS%EF%BC%89"><span class="nav-number">9.2.13.</span> <span class="nav-text">9.2.13 命令状态寄存器（CMDSTATUS）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-14-%E5%91%BD%E4%BB%A4%E5%8A%9F%E8%83%BD%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88CMDCAP%EF%BC%89"><span class="nav-number">9.2.14.</span> <span class="nav-text">9.2.14 命令功能寄存器（CMDCAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-15-%E8%BD%AF%E4%BB%B6%E9%94%99%E8%AF%AF%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88SWERROR%EF%BC%89"><span class="nav-number">9.2.15.</span> <span class="nav-text">9.2.15 软件错误寄存器（SWERROR）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-16-%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88EVLCFG%EF%BC%89"><span class="nav-number">9.2.16.</span> <span class="nav-text">9.2.16 事件日志配置寄存器（EVLCFG）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-17-%E4%BA%8B%E4%BB%B6%E6%97%A5%E5%BF%97%E7%8A%B6%E6%80%81%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88EVLSTATUS%EF%BC%89"><span class="nav-number">9.2.17.</span> <span class="nav-text">9.2.17 事件日志状态寄存器（EVLSTATUS）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-18-%E5%9F%9F%E9%97%B4%E8%83%BD%E5%8A%9B%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88IDCAP%EF%BC%89"><span class="nav-number">9.2.18.</span> <span class="nav-text">9.2.18 域间能力寄存器（IDCAP）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-19-%E5%9F%9F%E9%97%B4%E4%BD%8D%E5%9B%BE%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88IDBR%EF%BC%89"><span class="nav-number">9.2.19.</span> <span class="nav-text">9.2.19 域间位图寄存器（IDBR）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-20-%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88CMDPARAM%EF%BC%89"><span class="nav-number">9.2.20.</span> <span class="nav-text">9.2.20 命令参数寄存器（CMDPARAM）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-21-%E8%99%9A%E6%8B%9F%E9%97%A8%E6%88%B7%EF%BC%88DUMMY%EF%BC%89"><span class="nav-number">9.2.21.</span> <span class="nav-text">9.2.21 虚拟门户（DUMMY）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-22-MSI-X-%E6%9D%83%E9%99%90%E8%A1%A8-MSIXPERM"><span class="nav-number">9.2.22.</span> <span class="nav-text">9.2.22 MSI-X 权限表 (MSIXPERM)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-23-%E7%BB%84%E9%85%8D%E7%BD%AE%E8%A1%A8%EF%BC%88GRPCFG%EF%BC%89"><span class="nav-number">9.2.23.</span> <span class="nav-text">9.2.23 组配置表（GRPCFG）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-24-WQ%E9%85%8D%E7%BD%AE%E8%A1%A8%EF%BC%88WQCFG%EF%BC%89"><span class="nav-number">9.2.24.</span> <span class="nav-text">9.2.24 WQ配置表（WQCFG）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-25-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">9.2.25.</span> <span class="nav-text">9.2.25 性能监控寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-1-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E8%83%BD%E5%8A%9B%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88PERFCAP%EF%BC%89"><span class="nav-number">9.2.25.1.</span> <span class="nav-text">9.2.25.1 性能监控能力寄存器（PERFCAP）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-2-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6%E5%8A%9F%E8%83%BD%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88EVNTCAP%EF%BC%89"><span class="nav-number">9.2.25.2.</span> <span class="nav-text">9.2.25.2 性能监控事件功能寄存器（EVNTCAP）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-3-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E8%AE%A1%E6%95%B0%E5%99%A8%E5%8A%9F%E8%83%BD%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88CNTRCAP%EF%BC%89"><span class="nav-number">9.2.25.3.</span> <span class="nav-text">9.2.25.3 性能监控计数器功能寄存器（CNTRCAP）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-4-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%A4%8D%E4%BD%8D%E6%8E%A7%E5%88%B6%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88PERFRST%EF%BC%89"><span class="nav-number">9.2.25.4.</span> <span class="nav-text">9.2.25.4 性能监控复位控制寄存器（PERFRST）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-5-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E6%BA%A2%E5%87%BA%E7%8A%B6%E6%80%81%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88OVFSTATUS%EF%BC%89"><span class="nav-number">9.2.25.5.</span> <span class="nav-text">9.2.25.5 性能监控溢出状态寄存器（OVFSTATUS）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-6-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%86%BB%E7%BB%93%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88PERFFRZ%EF%BC%89"><span class="nav-number">9.2.25.6.</span> <span class="nav-text">9.2.25.6 性能监控冻结寄存器（PERFFRZ）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-7-%E8%AE%A1%E6%95%B0%E5%99%A8%E9%85%8D%E7%BD%AE%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88CNTRCFG%EF%BC%89"><span class="nav-number">9.2.25.7.</span> <span class="nav-text">9.2.25.7 计数器配置寄存器（CNTRCFG）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-8-%E6%BB%A4%E6%B3%A2%E5%99%A8%E9%85%8D%E7%BD%AE%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88FLTCFG%EF%BC%89"><span class="nav-number">9.2.25.8.</span> <span class="nav-text">9.2.25.8 滤波器配置寄存器（FLTCFG）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-25-9-%E8%AE%A1%E6%95%B0%E5%99%A8%E6%95%B0%E6%8D%AE%E5%AF%84%E5%AD%98%E5%99%A8%EF%BC%88CNTRDATA%EF%BC%89"><span class="nav-number">9.2.25.9.</span> <span class="nav-text">9.2.25.9 计数器数据寄存器（CNTRDATA）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-26-MSI-X-%E8%A1%A8"><span class="nav-number">9.2.26.</span> <span class="nav-text">9.2.26 MSI-X 表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-27-MSI-X-%E5%BE%85%E5%A4%84%E7%90%86%E4%BD%8D%E9%98%B5%E5%88%97"><span class="nav-number">9.2.27.</span> <span class="nav-text">9.2.27 MSI-X 待处理位阵列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-28-%E4%B8%AD%E6%96%AD%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="nav-number">9.2.28.</span> <span class="nav-text">9.2.28 中断消息存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-29-%E5%9F%9F%E9%97%B4%E6%9D%83%E9%99%90%E8%A1%A8%EF%BC%88IDPT%EF%BC%89"><span class="nav-number">9.2.29.</span> <span class="nav-text">9.2.29 域间权限表（IDPT）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-Portals%EF%BC%88BAR2%EF%BC%89"><span class="nav-number">9.3.</span> <span class="nav-text">9.3 Portals（BAR2）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95-A-CRC-%E8%AE%A1%E7%AE%97"><span class="nav-number">10.</span> <span class="nav-text">附录 A CRC 计算</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95-B-%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7%E5%AD%97%E6%AE%B5-DIF"><span class="nav-number">11.</span> <span class="nav-text">附录 B 数据完整性字段 (DIF)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference-Tag"><span class="nav-number">11.1.</span> <span class="nav-text">Reference Tag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Application-Tag"><span class="nav-number">11.2.</span> <span class="nav-text">Application Tag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Guard-Tag"><span class="nav-number">11.3.</span> <span class="nav-text">Guard Tag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#B-1-DIF-%E6%A3%80%E6%9F%A5"><span class="nav-number">11.4.</span> <span class="nav-text">B.1 DIF 检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#B-2-DIF-%E6%8F%92%E5%85%A5"><span class="nav-number">11.5.</span> <span class="nav-text">B.2 DIF 插入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#B-3-DIF-Strip"><span class="nav-number">11.6.</span> <span class="nav-text">B.3 DIF Strip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#B-4-DIF-%E6%9B%B4%E6%96%B0"><span class="nav-number">11.7.</span> <span class="nav-text">B.4 DIF 更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#B-5-DIX-%E7%94%9F%E6%88%90"><span class="nav-number">11.8.</span> <span class="nav-text">B.5 DIX 生成</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95-C-PCIe-%E9%85%8D%E7%BD%AE%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">12.</span> <span class="nav-text">附录 C PCIe 配置寄存器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95-D-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6"><span class="nav-number">13.</span> <span class="nav-text">附录 D 性能监控事件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95-E-%E5%85%B3%E9%94%AE%E6%9E%B6%E6%9E%84%E6%89%A9%E5%B1%95%E6%91%98%E8%A6%81"><span class="nav-number">14.</span> <span class="nav-text">附录 E 关键架构扩展摘要</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">15.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Wu JInlin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/13/Intel-DSA-spec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Wu JInlin">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJL's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="intel-data-streaming-accelerator-spec | WJL's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          intel-data-streaming-accelerator-spec
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-13 15:30:00" itemprop="dateCreated datePublished" datetime="2024-09-13T15:30:00+08:00">2024-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-09-26 13:46:07" itemprop="dateModified" datetime="2024-09-26T13:46:07+08:00">2024-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/intel/" itemprop="url" rel="index"><span itemprop="name">intel</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/intel/DSA/" itemprop="url" rel="index"><span itemprop="name">DSA</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/intel/DSA/PCIe/" itemprop="url" rel="index"><span itemprop="name">PCIe</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h1><p>本文档介绍了英特尔® 数据流加速器 (英特尔® DSA) 的架构，包括第二代英特尔 DSA 中的扩展。英特尔 DSA 是一款高性能数据复制和转换加速器，将集成到未来的英特尔® 处理器中，旨在优化高性能存储、网络、持久内存和各种数据处理应用中常见的流数据移动和转换操作。<br>英特尔 DSA 取代了英特尔® QuickData 技术，后者是英特尔® I&#x2F;O 加速技术的一部分。</p>
<h2 id="1-1-受众"><a href="#1-1-受众" class="headerlink" title="1.1 受众"></a>1.1 受众</h2><p>本规范的目标受众是构建兼容硬件实现的硬件工程师和 SoC 架构师、对设备进行编程的设备驱动软件开发人员、有效实现设备共享和虚拟化的虚拟化软件提供商，以及利用英特尔 DSA 操作的应用程序或库开发人员。</p>
<h2 id="1-2-参考文献"><a href="#1-2-参考文献" class="headerlink" title="1.2 参考文献"></a>1.2 参考文献</h2><p>Description<br>Intel® 64 and IA-32 Architectures Software Developer’s Manuals<br><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html">https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html</a><br>Intel® Architecture Instruction Set Extensions Programming Reference<br><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/download/intel-architecture-instruction-setextensions-programming-reference.html">https://software.intel.com/content/www/us/en/develop/download/intel-architecture-instruction-setextensions-programming-reference.html</a><br>PCI Express Base Specification 4.0<br><a target="_blank" rel="noopener" href="http://www.pcisig.com/specifications/pciexpress">http://www.pcisig.com/specifications/pciexpress</a><br>Intel® Virtualization Technology for Directed I&#x2F;O Specification<br><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/download/intel-virtualization-technology-fordirected-io-architecture-specification.html">https://software.intel.com/content/www/us/en/develop/download/intel-virtualization-technology-fordirected-io-architecture-specification.html</a><br>Intel® Scalable I&#x2F;O Virtualization Technical Specification<br><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/download/intel-scalable-io-virtualizationtechnical-specification.html">https://software.intel.com/content/www/us/en/develop/download/intel-scalable-io-virtualizationtechnical-specification.html</a><br>Intel® I&#x2F;O Acceleration Technology<br><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/wireless-network/accel-technology.html">https://www.intel.com/content/www/us/en/wireless-network/accel-technology.html</a><br>RFC 3720, Internet Small Computer Systems Interface<br><a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc3720.txt">http://www.ietf.org/rfc/rfc3720.txt</a></p>
<h1 id="2-概述"><a href="#2-概述" class="headerlink" title="2. 概述"></a>2. 概述</h1><p>Intel DSA 的目标是为数据移动和转换操作提供更高的整体系统性能，同时释放 CPU 周期以用于更高级的功能。Intel DSA 硬件支持高性能数据移动功能，可从易失性内存、持久性内存、内存映射 I&#x2F;O 移动数据，并通过 SoC 中的非透明桥 (NTB) 从集群中另一个节点上的远程易失性和持久性内存移动数据。它为操作系统提供了与 PCI Express 兼容的编程接口，可通过设备驱动程序进行控制。</p>
<p>除了执行基本的数据移动操作外，Intel DSA 还旨在对内存执行一些更高级的转换操作。例如，它可以在内存区域生成和测试 CRC 校验和或数据完整性字段 (DIF)，以支持存储和网络应用程序的典型用法。它支持内存比较操作以确定相等性，生成增量记录，并将增量记录应用于缓冲区。比较这些差异，VM 迁移、VM 快速检查点和软件管理内存重复数据删除等应用程序可以利用增量生成&#x2F;合并功能。</p>
<p>英特尔 DSA 还可用于通过设备的域间功能在不同地址空间之间移动数据。这可能适用于网络，例如使用虚拟交换机实现在虚拟机之间高效复制数据，或加速 OS 或 VMM 中的进程间通信 (IPC) 原语。它还可用于 HPC 和机器学习等应用领域中进程之间的消息和数据传递。</p>
<h2 id="2-1-高级用法"><a href="#2-1-高级用法" class="headerlink" title="2.1 高级用法"></a>2.1 高级用法</h2><p>本节总结了英特尔 DSA 的一些设想数据移动和转换用途。</p>
<ul>
<li>数据中心：作为数据移动卸载引擎，减少数据中心内存复制、归零等的负担，从而将 CPU 周期从单调的基础设施工作中解放出来。</li>
<li>存储：用于存储设备中的数据移动，包括使用非透明桥 (NTB) 在节点内和跨节点移动；以及用于 CRC 生成和数据完整性字段 (DIF) 生成，无论是否同时移动数据。</li>
<li>网络：用于数据包处理管道中的数据复制。一个示例用法是用于虚拟机间数据包交换的虚拟交换机卸载。</li>
<li>重复数据删除：用于比较内存页面是否相等以支持内存重复数据删除。</li>
<li>VM 迁移和快速检查点：VM 快速检查点和 VM 迁移流程需要 VMM 识别 VM 的已修改页面并有效地将它们发送到目标计算机，同时将网络流量和延迟降至最低。 Intel DSA 增量操作生成页面差异，使 VMM 能够仅将修改后的数据发送到目标，从而减少网络流量。</li>
<li>对等设备之间的数据移动：可用于对等加速器设备与主机内存之间或两个对等设备之间的数据移动，以从此类基础设施工作中释放 CPU 周期。</li>
<li>虚拟机之间的数据移动：释放 CPU 核心以执行常规基础架构任务，包括在虚拟机、容器和裸机主机之间移动数据。</li>
</ul>
<h2 id="2-2-英特尔®-DSA-特性"><a href="#2-2-英特尔®-DSA-特性" class="headerlink" title="2.2 英特尔® DSA 特性"></a>2.2 英特尔® DSA 特性</h2><p>英特尔 DSA 功能包括 </p>
<ol>
<li>基础设施功能，这是帮助实现可编程性、性能和效率的基本功能；</li>
<li>数据操作，这是实际的数据 DMA 和其他转换操作；</li>
<li>控制操作。以下部分概述了这些功能。</li>
</ol>
<h3 id="2-2-1-基础设施特点"><a href="#2-2-1-基础设施特点" class="headerlink" title="2.2.1 基础设施特点"></a>2.2.1 基础设施特点</h3><p>英特尔 DSA 支持以下基础设施功能</p>
<ul>
<li>共享虚拟内存 (SVM)：SVM 允许用户级应用程序直接向设备提交命令，并在描述符中使用虚拟地址。它支持使用 IOMMU 将虚拟地址转换为物理地址，包括处理页面错误。描述符引用的虚拟地址范围可能跨越多个页面。英特尔 DSA 还支持使用物理地址，只要描述符中指定的每个数据缓冲区在物理内存中是连续的。</li>
<li>部分描述符完成：使用 SVM，操作可能会在地址转换期间遇到页面错误。软件可以控制设备是在等待页面错误解决后继续处理，还是终止遇到页面错误的描述符的处理并继续处理下一个描述符。如果描述符的处理终止，完成记录会向软件指示已完成的工作量和有关页面错误的信息，以便软件可以解决故障并从停止点重新启动操作。</li>
<li>故障时阻塞：作为部分描述符完成的替代方法，当设备遇到页面错误时，它可以与系统软件协调以解决错误并继续操作，这对提交描述符的软件来说是透明的。</li>
<li>批处理：批处理描述符指向工作描述符数组（即具有实际数据操作的描述符）。处理批处理描述符时，设备从指定的虚拟内存地址获取工作描述符并对其进行处理。</li>
<li>无状态设备：描述符的设计使得处理描述符所需的所有信息都来自描述符本身。这允许设备存储少量客户端特定状态，从而提高其可扩展性。唯一的例外是完成中断消息（使用时），因为它必须由受信任的软件进行配置。</li>
<li>缓存分配控制：这允许应用程序指定输出数据是在缓存中分配还是在没有缓存分配的情况下发送到内存。完成记录始终在缓存中分配。</li>
<li>共享工作队列 (SWQ) 支持：共享工作队列 (SWQ) 使用可延迟内存写入事务实现可扩展的工作提交，这表明工作是否被接受进入 WQ。</li>
<li>专用工作队列 (DWQ) 支持：专用工作队列 (DWQ) 使用 64 字节内存写入事务实现高吞吐量的工作提交。</li>
<li>QoS 支持：英特尔 DSA 支持多种功能，允许内核驱动程序分别控制不同客户机和应用程序对设备资源的访问。 </li>
<li>英特尔® 可扩展 IOV 支持：英特尔可扩展 IO 虚拟化提高了设备分配的可扩展性，允许 VMM 在比使用 SR-IOV 更多的 VM 之间共享设备。 </li>
<li>持久内存功能：配置寄存器和描述符标志允许软件指示对持久内存（如英特尔® 傲腾™ DC 持久内存）的写入，并指定 SoC 的耐用性和排序语义。 </li>
<li>域间支持：英特尔 DSA 支持允许单个描述符跨不同地址空间域执行某些数据操作的功能。</li>
</ul>
<h3 id="2-2-2-数据操作"><a href="#2-2-2-数据操作" class="headerlink" title="2.2.2 数据操作"></a>2.2.2 数据操作</h3><p>Intel DSA 支持以下数据操作。有关这些操作的详细信息，请参阅第 8 章。</p>
<table border="1" cellpadding="5" cellspacing="0">
  <thead>
    <tr>
      <th>Operation</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="5">Move</td>
      <td>Memory Move</td>
      <td>Transfer data from a source address to destination address. Source and destination ranges can be either in main memory or MMIO.</td>
    </tr>
    <tr>
      <td>CRC Generation</td>
      <td>Generate CRC checksum on the transferred data.</td>
    </tr>
    <tr>
      <td>DIF/DIX</td>
      <td>Data Integrity Field (DIF) check. Insert, strip, or update while transferring data. Compute DIF for each block of source data and write to the destination address.</td>
    </tr>
    <tr>
      <td>Dualcast</td>
      <td>Copy data simultaneously to two destination locations.</td>
    </tr>
    <tr>
      <td>Memory Fill</td>
      <td>Fill memory range with a fixed pattern.</td>
    </tr>
    <tr>
      <td rowspan="4">Compare</td>
      <td>Memory Compare</td>
      <td>Compare two source buffers and return whether the buffers are identical.</td>
    </tr>
    <tr>
      <td>Delta Record Create</td>
      <td>Create a delta record containing the differences between the original and modified buffers. The size of the delta record is bounded, and the device signals an overflow if the differences exceed the bound.</td>
    </tr>
    <tr>
      <td>Delta Record Merge</td>
      <td>Merge a delta record with the original source buffer to produce a copy of the modified buffer at the destination location.</td>
    </tr>
    <tr>
      <td>Pattern/Zero Detect</td>
      <td>Special case of compare where instead of the second input buffer, an 8-byte pattern is specified. Pattern may be zero.</td>
    </tr>
    <tr>
      <td>Flush</td>
      <td>Cache Flush</td>
      <td>Evict all lines in a given address range from all levels of CPU caches.</td>
    </tr>
    <tr>
      <td rowspan="2">Inter-Domain</td>
      <td>Data Operations</td>
      <td>Data operations across address domains initiated by privileged or unprivileged software.</td>
    </tr>
    <tr>
      <td>Update Window</td>
      <td>Control parameters of memory windows used by inter-domain operations.</td>
    </tr>
  </tbody>
</table>
<h5 align = "center">Table 2-1： Intel DSA Data Operations </h5>

<table border="1" cellpadding="5" cellspacing="0">
  <thead>
    <tr>
      <th>Operation</th>
      <th>Type</th>
      <th>Description (描述)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="5">Move</td>
      <td>Memory Move</td>
      <td>将数据从源地址传输到目标地址。源和目标范围可以在主存储器或MMIO中。</td>
    </tr>
    <tr>
      <td>CRC Generation</td>
      <td>生成传输数据的CRC校验和。</td>
    </tr>
    <tr>
      <td>DIF/DIX</td>
      <td>数据完整性字段 (DIF) 校验。在传输数据时插入、剥离或更新DIF。为每个源数据块计算DIF并写入目标地址。</td>
    </tr>
    <tr>
      <td>Dualcast</td>
      <td>同时将数据复制到两个目标位置。</td>
    </tr>
    <tr>
      <td>Memory Fill</td>
      <td>用固定模式填充内存范围。</td>
    </tr>
    <tr>
      <td rowspan="4">Compare</td>
      <td>Memory Compare</td>
      <td>比较两个源缓冲区并返回缓冲区是否相同。</td>
    </tr>
    <tr>
      <td>Delta Record Create</td>
      <td>创建包含原始缓冲区与修改后缓冲区之间差异的增量记录。增量记录的大小是有限的，当差异超出范围时，设备会发出溢出信号。</td>
    </tr>
    <tr>
      <td>Delta Record Merge</td>
      <td>将增量记录与原始源缓冲区合并，以在目标位置生成修改后的缓冲区副本。</td>
    </tr>
    <tr>
      <td>Pattern/Zero Detect</td>
      <td>比较的特殊情况，其中代替第二个输入缓冲区的是一个8字节的模式。该模式可以为零。</td>
    </tr>
    <tr>
      <td>Flush</td>
      <td>Cache Flush</td>
      <td>从所有级别的CPU缓存中清除给定地址范围内的所有缓存行。</td>
    </tr>
    <tr>
      <td rowspan="2">Inter-Domain</td>
      <td>Data Operations</td>
      <td>由特权或非特权软件发起的跨地址域的数据操作。</td>
    </tr>
    <tr>
      <td>Update Window</td>
      <td>控制用于跨域操作的内存窗口参数。</td>
    </tr>
  </tbody>
</table>

<h3 id="2-2-3-控制操作"><a href="#2-2-3-控制操作" class="headerlink" title="2.2.3 控制操作"></a>2.2.3 控制操作</h3><p>Intel DSA 支持以下控制操作。其中一些命令使用<strong>描述符</strong>发出，一些使用<strong>命令寄存器</strong>发出。有关详细信息，请参阅第 9.2.12 节和第 8.3 节。</p>
<table border="1" cellpadding="5" cellspacing="0">
  <thead>
    <tr>
      <th>Operation</th>
      <th>Type</th>
      <th>Description (描述)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="2">Enable / Disable / Reset</td>
      <td>Device</td>
      <td>管理整个设备。</td>
    </tr>
    <tr>
      <td>WQ</td>
      <td>管理单个工作队列 (WQs)。</td>
    </tr>
    <tr>
      <td>Drain</td>
      <td>Current client</td>
      <td>清空当前客户端的所有进行中的工作请求。</td>
    </tr>
    <tr>
      <td rowspan="3">Drain / Abort</td>
      <td>Specified client</td>
      <td>清空或中止指定客户端的所有进行中的工作请求。</td>
    </tr>
    <tr>
      <td>Work Queue</td>
      <td>清空或中止指定工作队列中的所有进行中的工作请求。</td>
    </tr>
    <tr>
      <td>All</td>
      <td>清空设备中所有进行中的工作请求。</td>
    </tr>
    <tr>
      <td>No-op</td>
      <td>Null operation</td>
      <td>不执行任何操作，但可以发出完成信号。</td>
    </tr>
  </tbody>
</table>
<h5 align = "center" >Table 2-2: Intel® DSA Control Operations</h5>

<h1 id="3-英特尔®-数据流加速器架构"><a href="#3-英特尔®-数据流加速器架构" class="headerlink" title="3 英特尔® 数据流加速器架构"></a>3 英特尔® 数据流加速器架构</h1><p>本章详细介绍了英特尔 DSA 架构。每个 SoC 可能支持任意数量的英特尔 DSA 设备实例。多插槽服务器平台可能支持多个这样的 SoC。从软件角度来看，每个实例都作为 单个 <code>根复合体集成端点</code>  (<strong>RCiEP</strong>) 公开。每个实例都属于 DMA 重映射硬件单元（也称为 IOMMU）的范围。每个英特尔 DSA 实例都位于单个 DMA 重映射硬件单元后面，但根据 SoC 设计，不同的设备实例可以位于相同或不同的 DMA 重映射硬件单元后面。</p>
<hr>
<p>Root Complex Integrated Endpoint 规则</p>
<p>RCiEP 的应用场景是集成在RC内部，专门用于访问存储器。</p>
<ul>
<li>Root Complex Integrated Endpoint (RCiEP) 在包含Root Port的RC的内部逻辑上实现。</li>
<li>RCiEP 必须是具有Type 00h Configuration Space header的一个Function。</li>
<li>RCiEP 作为Completer必须支持Configuration Requests。</li>
<li>RCiEP 不得通过 BAR 声明的 I&#x2F;O 资源。</li>
<li>RCiEP 不得生成 I&#x2F;O 请求。</li>
<li>RCiEP 作为Completer不支持Locked Requests或作为Requester生成它们。 必须编写符合 PCI Express 的软件驱动程序和应用程序，以防止在访问 RCiEP 时使用lock语义。</li>
<li>RCiEP 作为Memory Transaction Requester需要能够生成不小于主机作为Completer处理的地址。</li>
<li>如果请求中断资源，则需要 RCiEP 来支持 MSI 或 MSI-X 或两者。 如果实施了 MSI，则允许 RCiEP 支持 MSI Capability结构的 32 位或 64 位Message Address版本。</li>
<li>RCiEP 支持请求内存资源的Base Address Registers的 32 位寻址。</li>
<li>RCiEP 不得在 PCI Express Extended Capability中实现Link Capabilities, Link Status, Link Control, Link Capabilities 2, Link Status 2,和Link Control 2 registers。</li>
<li>如果 RCiEP 与可选的 Root Complex Event Collector相关联，它必须通过 Root Complex Event Collector通知 PME 和 错误条件。</li>
<li>一个RCiEP 不得与多个Root Complex Event Collector相关联。</li>
<li>RCiEP 不实施Active State Power Management。</li>
<li>RCiEP 不能独立于整个Root Complex进行热插拔。</li>
<li>RCiEP 不得出现在Root Complex公开的任何层次结构域中。</li>
<li>RCiEP 不得出现在Switch中。</li>
</ul>
<hr>
<p>Intel DSA 支持地址转换缓存 (<strong>ATC</strong>)，并使用 PCI-SIG 定义的地址转换服务 (<strong>ATS</strong>)、进程地址空间 ID (<strong>PASID</strong>) 和页面请求服务 (<strong>PRS</strong>) 功能与 DMA 重映射硬件交互。PASID TLP 前缀添加到上游请求以支持共享虚拟内存 (<strong>SVM</strong>) 和 Intel 可扩展 I&#x2F;O 虚拟化 (<strong>Intel 可扩展 IOV</strong>)。该设备利用 DMA 重映射硬件将 DMA 地址转换为主机物理地址。根据用途，DMA 地址可以是主机虚拟地址 (HVA)、客户机虚拟地址 (GVA)、客户机物理地址 (GPA) 或 I&#x2F;O 虚拟地址 (IOVA)。Intel DSA 支持其他 PCI Express 功能，包括高级错误报告 (<strong>AER</strong>) 和 <strong>MSI-X</strong>。</p>
<p>Intel DSA 架构旨在支持 Intel 可扩展 I&#x2F;O 虚拟化。该设备可以以安全且隔离的方式直接与多个 VM 共享，以实现高吞吐量。第 3.16 节和第 7.3 节更详细地描述了虚拟化功能。</p>
<p>图 3-1 从概念层面说明了 Intel DSA 设备中的高级模块。</p>
<p>客户端的下游工作请求在 I&#x2F;O fabric 接口上接收。上游读取、写入和地址转换操作在该接口上发送。<br>    该设备包括<strong>配置寄存器</strong>、用于保存软件提交的<strong>描述符的工作队列</strong> (WQ)、用于实施 QoS 和公平性策略的<strong>仲裁器</strong>、<strong>处理引擎</strong>、<strong>地址转换和缓存接口</strong>以及<strong>内存读&#x2F;写接口</strong>。<br>    <strong>批处理单元</strong>通过从内存中读取描述符数组来处理批处理描述符。<strong>工作描述符处理单元</strong>具有<code>读取内存</code>、<code>对数据执行请求的操作</code>、<code>生成输出数据</code>以及<code>写入输出数据</code>、<code>完成记录</code>和<code>中断消息</code>的阶段。</p>
<p><strong>WQ configuration</strong> 允许软件将每个 WQ 配置为可由多个软件组件共享的共享工作队列 (SWQ)，或配置为每次分配给单个软件组件的专用工作队列 (DWQ)。该配置还允许软件控制哪些 WQ 馈送到哪些引擎以及馈送到每个引擎的 WQ 的相对优先级。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726210851924.png" class="" title="QQ_1726210851924">



<img src="/2024/09/13/Intel-DSA-spec/image-20240415193624263-0.png" class="" title="图像-20240415193624263">

<h2 id="3-1-寄存器和软件编程接口"><a href="#3-1-寄存器和软件编程接口" class="headerlink" title="3.1 寄存器和软件编程接口"></a>3.1 寄存器和软件编程接口</h2><p>Intel DSA 在软件上与标准 PCI Express 配置机制兼容，并在其配置映射寄存器组中实现了 PCI 头和扩展空间。</p>
<p>内存映射 I&#x2F;O 寄存器提供设备操作的状态和控制。</p>
<p>功能、配置和工作提交寄存器（portals）可通过第 9.1.1 节中描述的 BAR0 和 BAR2 寄存器定义的 MMIO 区域访问。</p>
<p>每个通道都在单独的 4K 页面上，因此可以使用 CPU 页表将它们独立映射到不同的地址空间（客户端）</p>
<h2 id="3-2-描述符"><a href="#3-2-描述符" class="headerlink" title="3.2 描述符"></a>3.2 描述符</h2><p>软件使用描述符为设备指定工作。描述符指定设备要执行的操作类型、数据和状态缓冲区的地址、立即操作数、完成属性等。<br>有关描述符格式和详细信息，请参阅第 8 章。完成属性指定写入完成记录的地址，以及生成完成中断所需的信息（可选）。</p>
<p>Intel DSA 避免在设备上维护客户端特定状态。处理描述符的所有信息都来自描述符本身。这提高了设备在用户模式应用程序之间以及虚拟化系统中不同虚拟机或机器容器之间的可共享性。</p>
<p>描述符可能包含操作和相关参数（称为工作描述符），也可以包含工作描述符数组的地址（称为批处理描述符）。软件在内存中准备描述符，并将描述符提交给设备的工作队列 (WQ)。设备将描述符从工作队列分派到引擎进行处理。</p>
<p>当引擎<strong>完成描述符</strong>或遇到导致中止的某些<strong>故障或错误</strong>时，它会通过在<strong>主机内存中写入完成记录</strong>、<strong>发出中断</strong>或两者来通知主机软件。</p>
<h2 id="3-3-工作队列"><a href="#3-3-工作队列" class="headerlink" title="3.3 工作队列"></a>3.3 工作队列</h2><p>工作队列 (WQs) 是<strong>设备上的存储空间</strong>，用于<strong>保存已提交给设备的描述符</strong>。 </p>
<p><strong>WQ <code>Capability 寄存器</code>指示工作队列的数量以及设备上可用的工作队列存储空间</strong>。软件配置启用的工作队列数量，并在活动 WQ 之间分配可用的 WQ 空间。</p>
<p><strong><code>WQ 配置表</code>用于配置 WQ</strong>。在启用设备之前，软件会配置每个 WQ 的大小。未使用的 WQ 的大小为 0。每个 WQ 的其他参数可以在启用 WQ 之前稍后配置。在某些配置中，WQ 大小和 WQ 配置的其他方面是只读的。有关配置 WQ 的更多详细信息，请参阅第 9.2.24 节。</p>
<p><strong>每个工作队列都可以配置为以两种模式之一运行</strong>，即专用或共享。**WQ <code>Capability 寄存器</code>**指示对专用和共享模式的支持。<code>WQ 配置表</code>允许软件配置每个 WQ 的模式。 <u><strong>只有在 WQ 被禁用时才能更改 WQ 的模式</strong></u> 。</p>
<p>有关配置和启用工作队列的详细信息，请参阅第 9.2 节中 WQ 功能寄存器、WQ 配置表和命令寄存器的规范。</p>
<p>描述符通过称为 <code>portals</code> 的特殊寄存器提交到工作队列。每个 <code>portals</code> 位于设备 MMIO 空间中单独的 4 KB 页面中。每个 WQ 有四个<code>portals</code>：</p>
<ul>
<li>无限 MSI-X portals</li>
<li>无限 IMS portals</li>
<li>有限 MSI-X portals</li>
<li>有限 IMS portals</li>
</ul>
<p>用于提交描述符的<code>portals</code>的地址允许设备确定将描述符放在哪个 WQ 中、通道是受限的还是无限制的、以及完成中断要使用哪个中断表。</p>
<p>有关有限和无限<code>portals</code>的使用，请参阅第 3.3.1 节“共享工作队列”。<strong>对于专用 WQ，有限和无限<code>portals</code>之间没有区别。</strong></p>
<p>有关 MSI-X 和 IMS <code>portals</code>的使用，请参阅第 3.7 节“中断”。对于不请求中断的描述符，无论将其提交给 MSI-X 通道还是 IMS 通道都无关紧要。如果不支持 IMS，则 IMS 通道不存在，因此写入通常对应于 IMS 通道的地址的描述符将被丢弃而不报告错误。如果使用 DMWr 提交了描述符，则返回重试响应。</p>
<h3 id="3-3-1-共享工作队列（SWQ）"><a href="#3-3-1-共享工作队列（SWQ）" class="headerlink" title="3.3.1 共享工作队列（SWQ）"></a>3.3.1 共享工作队列（SWQ）</h3><p>共享工作队列使用 PCIe 定义的可延迟内存写入请求 (DMWr) 接受工作提交。DMWr 是一个 64 字节的非发布写入，它会等待设备的响应才能完成。<br>如果描述符被接受到工作队列中，设备将返回 Success，如果由于 WQ 容量或 QoS 而未接受描述符，设备将返回 Retry。这允许多个客户端直接同时将描述符提交到同一个工作队列。由于设备提供了此反馈，因此客户端可以判断其描述符是否被接受。在 Intel CPU 上，DMWr 是使用 ENQCMD 或 ENQCMDS 指令生成的。ENQCMD 和 ENQCMDS 指令在 EFLAGS.ZF 标志中返回命令提交的状态；0 表示成功，1 表示重试。</p>
<p>可以通过设置 WQCFG 寄存器中的 WQ Threshold 字段来配置共享 WQ 以保留部分 WQ 容量。通过受限通道提交的工作会被接受，直到 SWQ 中的描述符数量达到配置的阈值。通过无限通道提交的工作会被接受，除非 SWQ 已完全填满。当向相应的受限通道提交的工作返回重试时，无限通道仅供特权软件使用。用户模式和客户软件通常只能访问受限通道。</p>
<p>如果 DMWr 返回 Success，则表示描述符已被设备接受并排队等待处理。如果 DMWr 返回 Retry，则软件可以尝试将描述符重新提交给 SWQ，或者如果它是使用受限通道的用户模式客户端，它可以请求内核模式驱动程序使用无限通道代表它提交描述符。这有助于避免拒绝服务并提供向前进展保证。有关软件使用有限和无限通道的更多信息，请参阅第 7 章。</p>
<p>设备使用称为进程地址空间 ID (PASID) 的 20 位 ID 来识别客户端。<strong>必须启用 PASID 功能才能使用 SWQ</strong>。设备使用 PASID 在地址转换缓存中查找地址并向 IOMMU 发送地址转换或页面请求。在共享模式下，每个描述符要使用的 PASID 包含在每个描述符的 PASID 字段中。 ENQCMD 指令将当前线程的 PASID 从 IA32_PASID MSR 复制到描述符中，而 ENQCMDS 允许监控模式软件将 PASID 复制到描述符中。有关 PASID 以及 ENQCMD 和 ENQCMDS 指令使用的更多详细信息，请参阅英特尔® 架构指令集扩展编程参考，列于第 1.2 节的参考资料中。</p>
<h3 id="3-3-2-专用工作队列（DWQ）"><a href="#3-3-2-专用工作队列（DWQ）" class="headerlink" title="3.3.2 专用工作队列（DWQ）"></a>3.3.2 专用工作队列（DWQ）</h3><p>要将工作提交到专用工作队列，软件使用具有写入<strong>原子性</strong>的 64 字节内存写入事务。由于写入操作的发布性质，此事务可能比 DMWr 完成得更快。</p>
<p><strong>设备依靠软件根据工作队列中的插槽数量提供流量控制。</strong></p>
<p>软件负责跟踪<strong>已提交</strong>和<strong>已完成</strong>的描述符数量，以检测工作队列是否已满。如果软件在工作队列中没有空间时错误地将描述符提交给专用 WQ，则该描述符将被丢弃。（错误在软件错误寄存器中报告。）</p>
<p>在 Intel CPU 上，使用 MOVDIR64B 指令将工作提交到 DWQ，该指令生成非撕裂的 64 字节写入。有关 MOVDIR64B 指令的信息，请参阅第 1.2 节参考资料中列出的 Intel® 64 和 IA32 架构软件开发人员手册。</p>
<p>对于专用 WQ，PASID 的使用是可选的。如果未启用 PCI Express PASID 功能，则不使用 PASID。如果启用了 PASID 功能，WQ 配置寄存器的 WQ PASID 启用字段控制是否为每个 DWQ 使用 PASID。由于 MOVDIR64B 指令不会像 ENQCMD 或 ENQCMDS 指令那样填写 PASID，因此描述符中的 PASID 字段将被忽略。当为 DWQ 启用 PASID 时，设备使用 WQ 配置寄存器的 WQ PASID 字段进行地址转换。在专用模式下启用工作队列之前，驱动程序必须设置 WQ PASID 字段。</p>
<p>虽然专用模式不支持多个客户端共享单个 DWQ，但可以将 Intel DSA 配置为具有多个 DWQ，并且可以将每个 DWQ 独立分配给客户端。</p>
<p>可以将 DWQ 配置为具有相同或不同的 QoS 级别</p>
<h2 id="3-4-引擎和组"><a href="#3-4-引擎和组" class="headerlink" title="3.4 引擎和组"></a>3.4 引擎和组</h2><p>引擎是 Intel DSA 设备中的操作单元。组是一组工作队列和引擎。</p>
<p>软件使用组配置寄存器将 WQ 和引擎配置成组。每个组包含一个或多个 WQ 和一个或多个引擎。组中的任何引擎都可用于处理发布到组中任何 WQ 的描述符。每个 WQ 和每个引擎只能属于一个组。</p>
<p>尽管英特尔 DSA 架构在配置工作队列、组和引擎方面具有极大的灵活性，但硬件的设计意图是用于特定配置。示例配置如图 3-2 和 3-3 所示。</p>
<p>在图 3-2 所示的配置中，<strong>硬件使用组中的任一引擎来处理来自组中任何工作队列的描述符</strong>。如果一个引擎由于高延迟内存地址转换或页面错误而停顿，另一个引擎可以继续运行并最大化整个设备的吞吐量。</p>
<p>图 3-2 显示了两个组的示例流量类别 (TC) 值。在组 0 中，两个 TC 值均为 0，而在组 1 中，TC-B 为 1。当组 0 仅用于访问 DRAM 的操作，而组 1 用于访问 DRAM 和持久内存的操作时，可以使用此示例配置。提交给组 1 的描述符中的 TC 选择器标志指示描述符中的每个地址是指 DRAM 还是持久内存。有关流量类别及其如何用于控制 QoS 的信息，请参阅第 4 章。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726211241453.png" class="" title="QQ_1726211241453">

<p>图 3-2 中每组有两个工作队列，但实际数量可以是任意的，直至达到所支持的最大 WQ 数量。组中的 WQ 可以是具有不同优先级的共享 WQ，也可以是一个共享 WQ 和其它专用 WQ，还可以是多个具有相同或不同优先级的专用 WQ。</p>
<p>图 3-3 显示了另一个示例配置，其中每个引擎都放置在单独的组中。<br>当软件想要降低延迟敏感操作被其他操作阻塞的可能性时，可以选择此配置。在此配置中，软件将延迟敏感操作提交到连接到一个引擎的工作队列，将其他操作提交到连接到另一个引擎的工作队列。如果在提交描述符时用于延迟敏感操作的组处于空闲状态，则将立即将该描述符分派给引擎。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726211265893.png" class="" title="QQ_1726211265893">

<p>软件还可以将两者混合，将一些引擎放在一个组中，将其他引擎放在单独的组中。</p>
<h2 id="3-5-描述符处理"><a href="#3-5-描述符处理" class="headerlink" title="3.5 描述符处理"></a>3.5 描述符处理</h2><p>当每个描述符到达工作队列的头部时，<code>组仲裁器</code>便可将其分派到组中的可用引擎。每个组的<code>仲裁器</code>根据优先级从组中的 WQ 分派描述符，同时确保优先级较高的 WQ 不会使优先级较低的 WQ 挨饿。</p>
<p>有关工作分派优先级的信息，请参阅第 4.1 节。</p>
<p>对于引用内存中的工作描述符的批处理描述符，引擎从内存中获取工作描述符数组。每个工作描述符都传递给工作描述符处理单元。工作描述符处理单元使用<code>地址转换缓存</code>和 <code>IOMMU</code> 进行<strong>完成记录</strong>、<strong>源和目标地址转换</strong>；<strong>读取源数据</strong>；<strong>执行指定的操作</strong>；<strong>并将目标数据写回内存</strong>。</p>
<p>操作完成后，引擎将<strong>完成记录</strong>写入<strong>预转换的完成地址</strong>并生成中断（如果工作描述符请求）。</p>
<h2 id="3-6-描述符完成"><a href="#3-6-描述符完成" class="headerlink" title="3.6 描述符完成"></a>3.6 描述符完成</h2><p>描述符包含<strong>三个标志</strong>和<strong>两个其他字段</strong>，允许软件控制完成通知。</p>
<p>这三个标志是：</p>
<ol>
<li><strong>完成记录地址有效</strong>（Completion Record Address Valid）</li>
<li><strong>请求完成记录</strong>（Request Completion Record）</li>
<li><strong>请求完成中断</strong> （Request Completion Interrupt）。</li>
</ol>
<p>这两个字段是</p>
<ol>
<li><strong>完成记录地址</strong>（Completion Record Address）</li>
<li><strong>完成中断句柄</strong> （Completion Interrupt Handle）。</li>
</ol>
<p><strong>完成记录</strong>是**<u>内存中 32 字节对齐的结构</u>**，设备在操作完成或遇到错误时会将其写入。完成记录包含完成状态。如果操作成功完成，完成记录可能包含操作结果（如果有），具体取决于操作类型。如果操作未成功完成，完成记录包含故障或错误信息。</p>
<p>通常，所有描述符都应具有有效的完成记录地址，并且完成记录地址有效标志应为 1。（此规则的例外情况将在后面介绍。）</p>
<p>完成记录的第一个字节是状态字节。设备写入的状态值均为非零值。软件应在提交描述符之前将完成记录的状态字段初始化为 0，以便能够判断设备何时写入完成记录。（初始化完成记录还可确保它被映射，因此设备在访问它时不太可能遇到页面错误。）</p>
<p><strong>请求完成记录标志</strong>指示设备即使操作成功完成也应写入完成记录。如果未设置此标志，则设备仅在出现错误时才写入完成记录。</p>
<p>软件可以使用以下任一方法检测描述符完成：</p>
<ol>
<li>轮询完成记录，等待状态字段变为非零值。</li>
<li>使用完成记录地址上的 <a target="_blank" rel="noopener" href="https://cloud.tencent.com.cn/developer/information/%E6%88%91%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%93%AA%E4%BA%9B%E8%8B%B1%E7%89%B9%E5%B0%94CPU%E4%B8%8A%E4%BD%BF%E7%94%A8umonitor%E5%92%8Cumwait%E6%8C%87%E4%BB%A4%EF%BC%9F">UMONITOR&#x2F;UMWAIT</a> 指令进行阻塞，直到写入或超时。然后，软件应检查状态字段是否为非零，以确定操作是否已完成。</li>
<li>操作完成时请求中断。对于用户模式描述符，此方法要求内核将通知转发给应用程序。</li>
<li>如果描述符在批处理中，则在同一批处理中的后续描述符中设置 Fence 标志。<br>具有 Fence 的描述符或同一批处理中的任何后续描述符的描述符的完成表示 Fence 之前的所有描述符的完成。</li>
<li>如果描述符在批处理中，则启动该批处理的批处理描述符的完成表示该批处理中的所有描述符的完成。</li>
<li>发出 Drain 描述符或 Drain 命令并等待其完成。</li>
</ol>
<p>如果完成状态指示由于页面错误而部分完成，则完成记录指示在遇到错误之前完成了多少处理（如果有）以及遇到错误的虚拟地址。软件可以选择修复错误（通过从 CPU 接触错误地址）并在新的描述符中重新提交其余工作或在软件中完成其余工作。描述符列表和完成记录地址上的错误处理方式不同，第 3.13 节中有更详细的描述。</p>
<h2 id="3-7-中断"><a href="#3-7-中断" class="headerlink" title="3.7 中断"></a>3.7 中断</h2><p>Intel DSA 仅支持消息信号中断。它提供两种类型的中断消息存储：(1) MSI-X 表，通过 MSI-X 功能枚举；(2) 设备特定的中断消息存储 (IMS) 表，如 Intel 可扩展 IOV 架构规范所述。有关 IMS 的更多信息，请参阅第 9.2.28 节和第 1.2 节参考资料中列出的 Intel® 可扩展 I&#x2F;O 虚拟化技术规范。</p>
<p>六种类型的事件可生成中断：</p>
<ol>
<li><p><strong>描述符完成</strong>；</p>
</li>
<li><p>WQ 占用率低于编程限制；</p>
</li>
<li><p>管理命令完成；</p>
</li>
<li><p>软件错误寄存器 ( SWERROR）中发布错误 或 内存中的事件日志中写入错误 <a href="#SWERROR">^1^</a>；</p>
</li>
<li><p>性能监控计数器溢出；</p>
</li>
<li><p>中断句柄撤销。</p>
</li>
</ol>
<p>每种类型的事件都有单独的中断启用。使用 MSI-X 表中的条目 0 生成类型 3-6 的中断。软件可以读取<strong>中断原因寄存器</strong>来确定中断的原因。</p>
<blockquote>
<p><a id = "SWERROR">^1^</a>  对 SWERROR 寄存器的任何后续引用都应被视为适用于 SWERROR 寄存器或启用时的事件日志。</p>
</blockquote>
<p>对于<strong>描述符完成</strong>的中断请求，其<strong>中断消息</strong>的生成取决于**<u>描述符提交的门户（portal）类型</u><strong>以及描述符中的</strong><u>完成中断句柄</u>**（Completion Interrupt Handle）。</p>
<p>如第 3.3 节所述，每个工作队列（WQ）都有 MSI-X 门户和 IMS 门户。</p>
<ul>
<li>对于通过 <strong>MSI-X</strong> 门户提交的描述符，描述符中的<strong>完成中断句柄</strong>字段选择 <strong>MSI-X 表</strong> 中的一个条目。</li>
<li>对于通过 <strong>IMS</strong> 门户提交的描述符，描述符中的<strong>完成中断句柄</strong>字段选择 <strong>Interrupt Message Storage (IMS)</strong> 中的一个条目。</li>
</ul>
<p>批处理中的描述符被视为通过与批处理描述符相同的门户提交。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726211524055.png" class="" title="QQ_1726211524055">

<table>
<thead>
<tr>
<th>Event</th>
<th>提交寄存器</th>
<th>使用的中断消息</th>
</tr>
</thead>
<tbody><tr>
<td>错误记录在  SWERROR 寄存器中或写入事件日志</td>
<td>N&#x2F;A</td>
<td>MSI-X table entry 0</td>
</tr>
<tr>
<td>完成管理命令</td>
<td>命令寄存器</td>
<td>MSI-X table entry 0</td>
</tr>
<tr>
<td>Perfmon  计数器溢出</td>
<td>N&#x2F;A</td>
<td>MSI-X table entry 0</td>
</tr>
<tr>
<td>WQ  使用率低于限制</td>
<td>WQ 占用中断寄存器</td>
<td>在 WQ 占用中断寄存器中编程的 MSI-X 或 IMS 条目。</td>
</tr>
<tr>
<td>描述符完成</td>
<td>MSI-X 门户</td>
<td>描述符中的完成中断处理字段指定的 MSI-X 表条目。</td>
</tr>
<tr>
<td>描述符完成</td>
<td>IMS门户</td>
<td>描述符中的完成中断句柄字段指定的 IMS 条目。</td>
</tr>
<tr>
<td>中断句柄撤销</td>
<td>N&#x2F;A</td>
<td>MSI-X table entry 0</td>
</tr>
</tbody></table>
<p>当不支持“<strong>请求中断句柄</strong>”(Request Interrupt Handle)命令时（如命令功能寄存器所示），<strong>完成中断句柄</strong>是 MSI-X 表或 IMS 中所需条目的索引。</p>
<p>当支持“<strong>请求中断句柄</strong>”命令时，软件必须使用该命令获取用于中断的句柄。软件在“<strong>请求中断句柄</strong>”命令中指定它想要哪个中断表条目的句柄。对命令的响应包含软件应放置在描述符的<strong>完成中断句柄</strong>字段中以请求该中断的句柄</p>
<p>使用<strong>请求中断句柄</strong>命令获取的中断句柄可能会被撤销。撤销中断句柄后，使用该句柄将导致无效中断句柄错误。撤销一个或多个中断句柄时，设备会设置中断原因寄存器中的中断句柄已撤销位，并使用 MSI-X 表条目 0 生成中断。</p>
<p>仅当已使用<strong>请求中断句柄</strong>命令获取中断句柄时，才会发生此中断原因。</p>
<p>软件应使用<strong>请求中断句柄</strong>命令获取所有正在使用的 MSI-X 和&#x2F;或 IMS 条目的新句柄。然后，软件应使用新句柄重新提交因无效中断句柄错误而失败的任何描述符。</p>
<p>有关中断虚拟化的描述（包括软件应执行的步骤的详细信息以支持中断句柄撤销），请参见第 7.5.4 节。</p>
<p>在Intel DSA中，PCIe规范定义的MSI-X表被扩展了一个MSI-X权限表，详细信息见第9.2.22节。每个 MSI-X 权限表条目都有几个字段，用于控制使用该表条目生成中断。每个 IMS 条目都包含相同的控制字段。</p>
<p><strong>在执行描述符之前，将检查所选中断表条目的 PASID Enable 和 PASID 字段</strong>，如第 5.4 节所述。</p>
<p><strong>描述符完成时，将检查 Ignore 和 Mask 字段</strong>。</p>
<ul>
<li>如果 Ignore 字段为 1，则不会生成中断。</li>
<li>如果 Ignore 字段为 0，则 Mask 和 Pending 字段的行为与 PCIe 指定的行为一致。<ul>
<li>如果 Mask 字段为 1，则 Pending 字段设置为 1，不会生成中断。</li>
<li>如果 Ignore 和 Mask 均为 0，则生成中断。</li>
</ul>
</li>
</ul>
<p><strong>对于描述符完成以外的中断，不使用 PASID Enable、PASID 和 Ignore 字段。</strong></p>
<p>英特尔 DSA 生成的中断通过内核或 VMM 软件配置的中断<strong>重映射</strong>和<strong>委派</strong>（Posting）硬件进行处理。</p>
<h2 id="3-8-批量描述符处理"><a href="#3-8-批量描述符处理" class="headerlink" title="3.8 批量描述符处理"></a>3.8 批量描述符处理</h2><p>Intel DSA 支持一次提交多个描述符。批处理描述符包含&#x3D;&#x3D;<strong>主机内存</strong>&#x3D;&#x3D;中工作描述符<strong>数组的地址</strong>和<strong>数组中的元素数量</strong>。工作描述符数组称为“批处理”。使用批处理描述符允许软件使用单个工作提交操作提交多个工作描述符，并且可以潜在地提高整体吞吐量，尤其是在使用传输大小较小的描述符时。</p>
<p>Intel DSA 对批处理中的工作描述符数量实施限制。存在总体限制，由<strong>通用功能寄存器</strong>中的<strong>最大支持批处理大小</strong>字段指示，并且每个工作队列也有单独的限制，由 WQ 配置表中每个 WQ 的 <strong>WQ 最大批处理大小</strong>字段设置。</p>
<p><u>批处理必须至少包含 2 个工作描述符。</u></p>
<p>批处理描述符以与其他工作描述符相同的方式提交到工作队列。当设备处理批次描述符时，设备会从内存中读取工作描述符数组，然后处理每个工作描述符。<strong>工作描述符不一定按顺序处理</strong>。（有关软件如何控制批次中描述符的排序的信息，请参阅第 3.9 节。）</p>
<p>批处理描述符的 PASID 和 Priv 字段用于批次中的所有描述符。^1^ 批次中描述符中的 PASID 和 Priv 字段将被忽略。</p>
<blockquote>
<p>对于提交到专用工作队列的 Batch 描述符，该 Batch 描述符以及该批次中的所有工作描述符的 PASID 和 Priv 字段均来自 WQ 配置寄存器。</p>
</blockquote>
<p>批次中的每个工作描述符都可以指定 <strong>完成记录地址</strong> 和&#x2F;或 <strong>完成中断</strong>，就像直接提交的工作描述符一样。批次描述符的完成记录和完成中断（如果请求）是在批次中的所有描述符完成并生成其完成记录（如果请求）之后生成的。在生成批次描述符完成记录之前不执行任何读回。为了保持批次的完成记录在批次中描述符的所有写入之后的顺序，批次描述符应该对其完成记录使用与先前写入相同的 TC，或者应该在批次中的每个描述符中设置目标读回标志。为了在批次中的描述符的完成记录之后保持批次的完成记录的顺序，应该对所有完成记录使用相同的 TC。</p>
<p>批次描述符的完成记录包含批次中是否有任何描述符以不等于“成功”的状态完成的指示。这允许软件避免检查批次中描述符的所有完成记录，通常情况下批次中的所有描述符都已成功完成。</p>
<p>在某些情况下，如果批次中的描述符在完成记录地址上遇到页面错误，即使完成记录页面错误已成功解决，硬件也可能指示可能存在错误。软件可以检查批次中描述符的完成记录，以确定是否确实存在任何故障。</p>
<p>批次描述符可能不包含在批次中。</p>
<p><strong>不支持嵌套或链接的描述符数组。</strong></p>
<p>有关批次描述符格式的详细信息，请参阅第 8.3.2 节。</p>
<h2 id="3-9-排序和隔离"><a href="#3-9-排序和隔离" class="headerlink" title="3.9 排序和隔离"></a>3.9 排序和隔离</h2><p>设备通常可以按任意顺序处理描述符。但是，当满足以下所有条件时，可以保证按照设备接收的顺序执行描述符：</p>
<ul>
<li>描述符提交给只有一个引擎的组。</li>
<li>所有描述符都使用相同的门户地址提交给同一个 WQ。</li>
<li>所有描述符都是批处理描述符，或者它们都不是批处理描述符。</li>
<li>所有描述符都使用相同的目标 TC 选择器。</li>
</ul>
<p>只保证写入顺序。后续描述符的读取可以传递来自前一个描述符的写入。如果描述符中发生错误，后续描述符将继续执行。因此，软件不能一定依赖来自较早描述符的数据传输在来自较晚描述符的数据传输之前完成。完成记录对软件可见的顺序无法保证。</p>
<p>即使满足这些条件，除非设置了 Fence 标志（如下所述），否则批处理中的描述符顺序也无法保证。</p>
<p>如果需要对描述符的排序进行更多控制，软件可以使用以下方法之一：</p>
<ul>
<li>提交一个描述符，等待来自描述符的完成记录或中断以确保完成，然后提交下一个描述符。</li>
<li>使用 Drain 描述符或 Drain 命令等待前面的描述符完成，然后提交后面的描述符。</li>
<li>在批处理中使用 Fence 标志。</li>
</ul>
<p><strong>强制排序可能会增加提交描述符所用的 CPU 时间以及描述符在设备内开始执行的延迟。</strong></p>
<p>为了控制由批次描述符指定的批次中描述符的排序，每个工作描述符都有一个 Fence 标志。设置后，Fence 可确保在同一批次中的所有先前描述符完成之前不会开始处理该描述符。这允许具有 Fence 的描述符使用同一批次中先前描述符生成的数据。使用批次中先前描述符数据的描述符应使用与生成数据的描述符相同的流量类别。如果软件无法确保这一点，则软件必须在生成数据的描述符中设置目标读回标志，以确保所需的排序。</p>
<p>如果批处理中的任何描述符完成时状态不等于成功（例如，如果由于页面错误而部分完成），则 Fence 标志等于 1 的后续描述符以及批处理中的任何后续描述符都将被放弃。用于提交批处理的批处理描述符的完成记录指示在 Fence 之前处理了多少个描述符。</p>
<p>如果满足以下条件，则描述符的完成记录写入将在该描述符生成的所有数据写入之后进行：</p>
<ul>
<li>描述符已完全完成；或 </li>
<li>描述符中的完成记录 TC 选择器与目标 TC 选择器相同。</li>
</ul>
<p>否则，软件可能会在描述符生成的某些数据写入之前观察到完成记录。完成中断（如果请求）将在完成记录写入之后进行。</p>
<p>如果批次描述符未请求完成记录（例如，完成记录地址有效为 0 或请求完成记录为 0），则如果完成记录写入指定选择非零 TC 的 TC 选择器，则批次描述符的完成中断（如果已请求）相对于批次中描述符的完成记录写入的顺序无法保证。在这种情况下，软件可以设置批次描述符中的请求完成记录标志，以确保批次描述符的完成中断的正确排序。</p>
<p>目标读回标志使 Intel DSA 在写入完成记录之前使用描述符的最终目标地址执行零长度读取。如果目标目标与完成记录目标不同，则可以设置目标读回标志以确保在写入完成记录之前写入已传播到目标。例如，此标志可用于以 NTB 为目标的描述符，以确保描述符写入的数据已传播到 NTB 链路。仅当描述符成功完成时才执行目标读回。如果描述符部分完成，则不执行读回。如果完成操作的后续描述符使用相同的 TC 写入同一目标，设置目标读回标志并成功完成，则后续描述符执行的读回还可确保先前描述符执行的内存写入完成。</p>
<h2 id="3-10-持久内存支持"><a href="#3-10-持久内存支持" class="headerlink" title="3.10 持久内存支持"></a>3.10 持久内存支持</h2><p>Intel DSA 提供了多种功能，旨在提高其与持久内存（如 Intel® Optane™ DC 持久内存）的实用性。当描述符的目标地址位于持久内存中时，软件应使用以下标志来确保数据在描述符完成时已变为持久的。</p>
<ul>
<li>• 描述符中的缓存控制标志控制写入是定向到缓存还是内存。对于持久内存的使用，缓存控制标志应为 0。</li>
<li>• 目标读回标志应为 1，以确保描述符写入的数据在描述符完成时已变为持久的。</li>
</ul>
<p>如第 2.2.1 节所述，由于完成记录写入始终定向到缓存，因此没有设备支持的机制来确保完成记录写入的持久性。<br>严格排序标志不保证写入按顺序变为持久的。</p>
<h2 id="3-11-缓存控制"><a href="#3-11-缓存控制" class="headerlink" title="3.11 缓存控制"></a>3.11 缓存控制</h2><p>描述符中的<strong>缓存控制标志</strong>是一个提示，指示描述符所针对的<strong>目标地址</strong>是否应写入最后一级缓存或内存。</p>
<ul>
<li>如果标志为 0，则提示描述符写入的数据应定向到内存。如果写入操作针对缓存中存在的缓存行，则可能会将其从缓存中删除。</li>
<li>如果标志为 1，则提示应分配缓存条目以包含描述符写入的数据。</li>
</ul>
<p><u>实现可能会忽略此提示。由于处理器可以随时自由地将数据提取到缓存中或从缓存中逐出数据，因此即使支持此标志，也无法保证其效果。</u></p>
<p>缓存控制标志保留用于不写入内存的操作，包括缓存刷新和域间缓存刷新。如果 GENCAP 中的缓存控制支持字段为 0，则缓存控制标志保留用于所有操作类型。</p>
<h2 id="3-12-Drain-描述符"><a href="#3-12-Drain-描述符" class="headerlink" title="3.12 Drain 描述符"></a>3.12 Drain 描述符</h2><p>Drain 描述符等待其所提交的 WQ 中某些先前描述符的完成。</p>
<ul>
<li><p>如果将Drain 描述符提交给专用 WQ，则它会等待 WQ 中所有描述符的完成。</p>
</li>
<li><p>如果将Drain 描述符提交给共享 WQ，则它会等待 WQ 中与Drain 描述符使用相同 PASID 提交的描述符。</p>
</li>
<li><p>要等待具有特定 PASID 的所有描述符，软件应向使用该 PASID 的每个 WQ 提交单独的Drain 描述符。</p>
</li>
<li><p>要等待 WQ 中的所有描述符（无论 PASID 如何），软件可以使用第 3.13.3 节中描述的Drain  WQ 命令。</p>
</li>
</ul>
<p>正在使用设备的进程可以在正常关机期间使用 Drain 描述符。它可以像整个 PASID 的 Fence 操作一样使用。它可用于请求单个完成记录和&#x2F;或中断以完成多个描述符。批处理中不能包含 Drain 描述符。（批处理中可以使用 Fence 标志来等待批处理中的先前描述符完成。）软件应在提交 Drain 描述符之前执行隔离指令（例如 SFENCE 或 MFENCE），以确保设备在要Drain 的描述符之后收到 Drain 描述符。</p>
<p>对于 Drain 而言，在操作生成的所有写入都全局可观察之后完成前一个描述符；在目标读回之后（如果请求）；在对完成记录的写入全局可观察之后（如果需要）；以及在生成完成中断之后（如果请求）。为确保这一点，在 Drain 描述符完成之前，硬件通常使用硬件确定的地址为每个支持的流量类发出隐式读回。隐式读回确保之前对根复合体的所有写入都已完成。</p>
<p>软件可以通过在 Drain 描述符中设置读回标志来控制默认行为，这些标志可用于抑制隐式读回和&#x2F;或请求对软件控制的地址进行显式读回。<br>之前对对等设备（即非根复合体）的写入可能无法通过 Drain 描述符隐式读回刷新，但可以使用显式读回刷新。Drain 描述符允许软件在描述符中指定最多 2 个显式读回地址。如果指定，硬件将使用描述符中相应 TC 选择器标志指定的流量类向每个显式读回地址发出读回。<br>有关 Drain 描述符的详细信息，请参阅第 8.3.3 节。</p>
<h2 id="3-13-地址转换"><a href="#3-13-地址转换" class="headerlink" title="3.13 地址转换"></a>3.13 地址转换</h2><p>Intel DSA 支持使用物理或虚拟地址。与 CPU 上运行的进程共享的虚拟地址的使用称为共享虚拟内存 (SVM)。为了支持 SVM，设备在执行地址转换时提供 PASID，并处理当地址没有转换时发生的页面错误。但是，设备本身并不区分虚拟地址和物理地址；这种区别由 IOMMU 的编程控制。</p>
<p><strong>Intel DSA 支持 PCI Express 地址转换服务 (ATS) 和页面请求服务 (PRS) 功能。</strong></p>
<p>ATS 描述了地址转换期间的设备行为。当描述符进入描述符处理单元时，设备会请求对描述符中的地址进行转换。如果地址转换缓存中有命中，设备将使用相应的 HPA。如果出现未命中或权限错误，设备将向 IOMMU 发送地址转换请求以进行转换。IOMMU 通过遍历适当的页表来找到转换，并返回包含转换地址和有效权限的地址转换响应。设备将转换存储在地址转换缓存中，并使用相应的 HPA 进行操作。如果 IOMMU 在页表中找不到转换，它会返回地址转换响应，表示没有可用的转换。当 IOMMU 响应指示没有转换或指示有效权限不包含操作所需的权限时，则被视为页面错误。</p>
<h3 id="3-13-1-工作队列地址转换控制"><a href="#3-13-1-工作队列地址转换控制" class="headerlink" title="3.13.1 工作队列地址转换控制"></a>3.13.1 工作队列地址转换控制</h3><p>某些实现支持控制设备中每个启用的工作队列的 ATS 和 PRS 功能。WQCAP 中的 WQ ATS 支持和 WQ PRS 支持字段指示对工作队列细粒度 ATS 和 PRS 控制的支持。如果支持，软件可以使用 WQCFG 中的 WQ ATS 禁用和 WQ PRS 禁用控制来禁用每个工作队列的相应功能。对于提交到工作队列的描述符，如果其中任何一个功能被禁用，设备操作与相应的 PCI Express 控制为 0 时相同。</p>
<p>如果 ATS 被禁用（无论是通过 PCIe ATS 控制寄存器还是 WQCFG 中的 WQ ATS 禁用标志），英特尔 DSA 不会收到任何有关内存写入事务的地址转换故障的通知。即使写入事务发生页面错误，操作的完成记录也可能指示成功。如果 ATS 被禁用，软件应确保描述符访问的任何内存地址都不会导致页面错误。软件可以使用目标读回标志来检测写入目标地址的一些错误。</p>
<h3 id="3-13-2-启用-PRS-的页面错误处理"><a href="#3-13-2-启用-PRS-的页面错误处理" class="headerlink" title="3.13.2 启用 PRS 的页面错误处理"></a>3.13.2 启用 PRS 的页面错误处理</h3><p>当 PCI Express PRS 启用控制为 1 并且 WQCAP 中的 WQ PRS 支持为 0 或 WQCFG 中的 WQ PRS 禁用为 0 时，PRS 处于启用状态。此外，每个描述符都有一个 Block On Fault 标志，用于指定是否为描述符中的源和目标缓冲区地址启用 PRS。</p>
<p>当发生页面错误并且启用了 PRS 时，错误将作为 PRS 请求报告给 IOMMU，以便由 OS 页面错误处理程序提供服务。IOMMU 通过中断通知 OS。OS 验证地址，并在检查成功后在页表中创建映射并通过 IOMMU 返回 PRS 响应。遇到错误的描述符将被阻止，直到收到 PRS 响应。发生错误的描述符后面的其他操作也可能被阻止。如果 OS 无法创建映射，它将返回错误响应，并且描述符以错误完成。错误报告与 PRS 禁用时的页面错误报告相同，下一节将对此进行介绍。</p>
<p>当 Block On Fault 为 0 且在源或目标缓冲区地址上遇到页面错误时，设备将停止操作并将部分完成状态以及错误地址和进度信息写入完成记录。（有关更多详细信息，请参阅第 8.1 和 8.2 节。）通用功能寄存器 (GENCAP) 中的 Block On Fault Support 字段表示设备支持为源和目标缓冲区启用 PRS，而 WQ 配置表中每个 WQ 的 Block On Fault Enable 字段允许 VMM 或内核驱动程序控制哪些应用程序可以启用源和目标缓冲区的 PRS。这些寄存器在第 9.1.4 节中描述。</p>
<p>设备页面错误的成本相对较高，高于处理 CPU 页面错误的成本。因此，为了获得最佳性能，软件最好尽量减少设备页面错误，而不会产生固定和取消固定的开销。</p>
<p>批处理描述符列表和源数据缓冲区通常在提交给设备之前由软件生成。因此，由于时间局部性，这些地址不太可能发生故障。但是，如果在提交给设备之前软件没有触碰完成记录和目标数据缓冲区，则更有可能发生故障。通过在提交之前明确“写入触碰”这些页面，软件可以最大限度地减少此类故障。</p>
<h3 id="3-13-3-PRS-禁用时的页面错误处理"><a href="#3-13-3-PRS-禁用时的页面错误处理" class="headerlink" title="3.13.3 PRS 禁用时的页面错误处理"></a>3.13.3 PRS 禁用时的页面错误处理</h3><p>当 PCI Express PRS 启用控制为 0 或 WQCFG 中的 WQ PRS 禁用字段为 1 时，将禁用所有地址转换的 PRS。当描述符中的 Block on Fault 标志为 0 时，仅对描述符中的源和目标缓冲区地址禁用 PRS</p>
<p>当完成记录地址发生页面错误时，错误将在事件日志（如果已启用）或 SWERROR 寄存器中报告。事件日志中报告的完成记录错误是可恢复的。描述符已完成，事件日志条目包含完成记录地址和完成记录的内容。处理页面错误后，系统软件应将完成记录复制到完成记录地址。有关事件日志的信息，请参见第 5.9 节；有关软件处理事件日志中报告的完成记录错误的信息，请参见第 7.3 节。SWERROR 中报告的完成记录错误可能无法恢复：由于只能记录单个错误，因此错误可能会丢失；并且描述符未完成，必须重新启动，因为未记录部分完成信息。</p>
<p>当描述符中除完成记录地址之外的地址发生页面错误时，设备将停止操作并将部分完成状态以及错误地址和进度信息写入完成记录。有关更多详细信息，请参阅第 8.1 节和第 8.2 节。当客户端软件收到指示部分完成的完成记录时，它可以选择修复 CPU 上的错误（例如，通过触摸页面）并提交包含剩余工作的新工作描述符。或者，软件可以完成 CPU 上的剩余工作。</p>
<p>在禁用 PRS 并启用事件日志的情况下运行，可使使用英特尔 DSA 的应用程序避免在出现页面错误时对其他应用程序产生重大影响。即使禁用 PRS，设备页面错误也可能代价高昂，因为它们需要软件干预来处理页面错误并重新提交工作。软件最好尽量减少设备页面错误，如上一节所述。</p>
<h2 id="3-14-域间操作"><a href="#3-14-域间操作" class="headerlink" title="3.14 域间操作"></a>3.14 域间操作</h2><p>提交给英特尔 DSA 的每个工作描述符都与一个默认地址空间相关联，该地址空间对应于工作提交者的地址空间。启用 PASID 功能后，默认地址空间将明确指定，要么由提交给共享工作队列的工作描述符中携带的 PASID 指定，要么由 WQCFG 寄存器中为专用工作队列配置的 PASID 指定（如第 9.2.24 节所述）。内存访问和 IOMMU 请求使用此 PASID 值标记。禁用 PASID 功能后，默认地址空间将通过设备的 PCIe 请求者 ID（总线、设备、功能）隐式指定给 IOMMU。我们将工作提交者的这个默认地址空间称为描述符 PASID，这是该提交者的描述符通常用于内存访问和来自设备的 IOMMU 请求的地址空间。启用 PASID 功能后，某些操作允许提交者为工作描述符中指定的源地址、目标地址或源地址和目标地址选择备用地址空间。备用地址空间通常属于一个协作进程 1 。从今以后，我们将此进程称为该备用地址空间的所有者。术语“域”用于表示地址空间，我们将允许选择备用地址空间的一组操作称为域间操作。</p>
<p>域间操作需要启用 PASID 功能。GENCAP 寄存器中的域间支持字段指示对域间操作的支持（如第 9.2.2 节所述）。当此字段为 1 时，IDCAP 寄存器中会报告域间功能（如第 9.2.18 节所述）。OPCAP 寄存器中会报告实现所支持的域间操作集，并且只有在支持域间功能时才可使用。使用适当的描述符字段来选择每个操作中使用的 PASID。支持的域间操作的详细信息以及相应描述符字段的描述可在第 8.3.20 节中找到。</p>
<p>如果工作提交者未明确选择描述符中地址的备用 PASID，则描述符 PASID 将用于与该地址相关的内存访问和 IOMMU 请求。如果描述符为地址选择了备用 PASID，则如果提交者具有适当的权限，则使用该 PASID 代替描述符 PASID。当以这种方式使用时，我们将备用 PASID 称为描述符中相应地址的访问 PASID。设备使用访问 PASID 执行与该地址相关的内存访问和 IOMMU 请求。描述符 PASID 始终用于写入完成记录、生成中断以及验证提交者是否具有对指定访问 PASID 的足够权限，如下所述。</p>
<p>根据用例，域间操作可能涉及两个或三个 PASID。下面列出了一些典型用例。</p>
<ol>
<li>一个或多个用户模式提交者从用户模式所有者导出的内存区域读取或写入数据。</li>
<li>内核模式提交者从用户模式进程的内存区域读取或写入数据。</li>
<li>内核模式提交者在两个不同用户模式进程的内存区域之间读取或写入数据。</li>
<li>内核模式提交者从另一个内核模式进程的内存区域读取或写入数据。</li>
<li>特权提交者在两个不同客户操作系统的内存区域之间读取或写入数据。</li>
<li>在客户操作系统内执行上述任何操作。</li>
</ol>
<blockquote>
<p>术语“进程”用于指代可与 PASID 关联的操作系统进程、虚拟机、容器或其他类似的软件实体。</p>
</blockquote>
<p>上述用例 (1) 要求所有者明确授予一个或多个提交者对其部分内存空间的访问权限。所有者授予访问权限的内存区域称为内存窗口。内存窗口只能使用所有者的 PASID 作为访问 PASID 来访问。用例 (2) 至 (6) 涉及特权软件访问该操作系统域内其他用户模式或内核模式进程的内存区域。</p>
<h3 id="3-14-1-域间权限表（IDPT）"><a href="#3-14-1-域间权限表（IDPT）" class="headerlink" title="3.14.1 域间权限表（IDPT）"></a>3.14.1 域间权限表（IDPT）</h3><p>如果支持域间操作，英特尔 DSA 将实施域间权限表，以允许软件管理 1) 描述符 PASID 与工作提交者可以访问的访问 PASID 之间的关联；2) 提交者可以访问的访问 PASID 内存空间中的内存区域的属性；3) 控制以管理此类关联的生命周期。域间权限表由主机内核模式驱动程序管理，可以配置为支持主机或客户机操作系统中的内核模式和用户模式应用程序的使用。</p>
<p>IDPT 中的每个条目包含以下内容：</p>
<ol>
<li><p>如下所述的条目类型。</p>
</li>
<li><p>允许使用该条目的一个或多个提交者 PASID 值以及验证它们的机制。</p>
</li>
<li><p>根据条目类型，用于内存访问的访问 PASID。</p>
</li>
<li><p>内存窗口地址范围和属性。</p>
</li>
<li><p>权限和其他控制信息。</p>
</li>
</ol>
<p>每个域间权限表条目 (IDPTE) 可以按照以下类型字段指示的方式之一进行配置（如下所述并在第 9.2.29 节中总结）：</p>
<p>• <strong>类型 0</strong> — 单次访问、单次提交者 (SASS)：IDPTE 指定单次访问 PASID 和单次提交者 PASID。例如，想要向对等进程公开内存窗口的进程可能会请求驱动程序设置一个 SASS 条目，将其自己的 PASID 作为访问 PASID，将其对等进程的 PASID 作为提交者 PASID。</p>
<p>• <strong>类型 1</strong> — 单次访问、多提交者 (SAMS)：IDPTE 指定单次访问 PASID。条目中的提交者 PASID 字段未使用。相反，IDPTE 指向内存中的位图，该位图指定允许使用该条目的提交者 PASID 集。位图中设置为 1 的位表示允许相应的 PASID 使用 IDPTE 提交域间操作。例如，想要允许多个提交者访问其地址空间中的窗口的进程请求设置 SAMS 条目。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726213805355.png" class="" title="QQ_1726213805355">

<p>描述符使用描述符中的句柄引用 IDPTE 条目。IDCAP 中的域间权限表大小字段指定设备支持的 IDPT 表的最大大小。软件分配索引小于此最大大小的 IDPT 条目。此外，如果 CMDCAP 中的请求 IDPT 句柄字段为 0，则句柄是 IDPT 中所需条目的索引。如果 CMDCAP 中的请求 IDPT 句柄字段为 1，则软件必须使用请求 IDPT 句柄命令来获取与 IDPT 中分配的索引相对应的要使用的句柄。软件在请求 IDPT 句柄命令中指定它想要句柄的 PASID 表条目的索引，并且对该命令的响应包含软件应放置在描述符中的句柄。有关 IDPT 虚拟化的描述，请参阅第 7.5.6 节。</p>
<p>域间描述符可能包含多个句柄，具体取决于操作类型。可以为描述符中每个不同的源和&#x2F;或目标地址指定单独的句柄。硬件使用描述符中的每个句柄来查找相应的 IDPTE，以 1) 验证提交者的访问权限，2) 识别用于内存访问的访问 PASID 和特权，3) 计算有效内存地址，以及 4) 验证访问是否符合 IDPTE 授予的内存窗口和权限。</p>
<p>IDPTE 可能被以下对象引用：<br>    • 当 IDPTE 中的可用位为 1 时，域间描述符。硬件检查描述符 PASID 是否与指定 IDPTE 中的提交者 PASID 值匹配。<br>    • 当 IDPTE 中的允许更新位为 1 时，更新窗口描述符。硬件检查描述符 PASID 是否与指定 IDPTE 中的访问 PASID 值匹配。<br>如果 PASID 值不匹配，则不允许使用该条目对该描述符进行内存访问，并且描述符以错误完成。<br>操作的详细信息在第 8.3.20 节中描述。</p>
<h3 id="3-14-2-提交者位图"><a href="#3-14-2-提交者位图" class="headerlink" title="3.14.2 提交者位图"></a>3.14.2 提交者位图</h3><p>如上所述，类型 1 SAMS IDPTE 指向内存中的提交者位图，每个可能的 PASID 值对应一个位。位图由要与位图进行检查的 PASID 值索引。仅当位图中与已检查的 PASID 对应的位为 1 时才允许访问。对于 SAMS IDPTE，硬件在允许使用表条目进行任何内存访问之前，会根据位图检查描述符 PASID。<br>类型 1 SAMS 条目指定 4KB 对齐的虚拟或物理地址，称为提交者位图地址。特权软件（如内核模式驱动程序）负责设置和维护内存中的位图。提交者位图的最大大小为 220 位，即 128KB。每个需要位图的 IDPTE 都可以指向内存中的不同提交者位图。如果合适，软件还可以选择在多个 IDPTE 之间共享提交者位图。</p>
<p>IDBR（在第 9.2.19 节中描述）控制硬件是否应使用 PASID 值进行提交者位图读取。如果启用，IDBR 将指定用于位图读取的 PASID 值和权限。<br>虽然每个提交者位图都映射到相应 PASID 空间中的连续虚拟地址范围，但它可能会映射到系统内存中不连续的物理页面。软件也不需要一次将位图完全映射到系统内存中；可以根据需要映射不同的位图页面。如果位图的某个页面无法访问，则该页面上的所有位都被视为 0^1^。 IDBR 还指定用于位图读取的流量类别</p>
<blockquote>
<p>根据 IOMMU 配置，未映射的页面可能会报告故障。为了避免这些故障，软件可以固定与位图对应的所有内存页面。</p>
</blockquote>
<p>位图读取可以由硬件以特定于实现的方式完成。实现可以将位图读取作为转换或未转换访问发出。硬件可以读取与要检查的 PASID 相对应的单个字节或双字或缓存行或位图的更大区域。例如，对于要根据位图检查的 PASID 值 p，使用位图缓存行读取的实现将读取 (PPBA + ((p &gt;&gt; 3) &amp; 0xFFFFFFC0)) 处的缓存行并检查与要检查的 PASID 相对应的位。</p>
<p>允许实现缓存位图的某些部分，以避免重复读取内存。如果支持此功能，则由 CMDCAP 中的“使提交者位图缓存无效”字段指示。如果此功能为 1，则软件必须在修改内存中的位图的任何部分或修改位图的任何页面的映射后发出“使提交者位图缓存无效”命令（如第 9.2.12 节所述）。在后一种情况下，软件必须在执行通常与页面映射修改相关的任何必需的无效操作后执行位图无效操作。</p>
<h3 id="3-14-3-内存窗口"><a href="#3-14-3-内存窗口" class="headerlink" title="3.14.3 内存窗口"></a>3.14.3 内存窗口</h3><p>内存窗口是所有者地址空间中的内存区域，允许一个或多个提交者访问。它由 IDPTE 中的窗口基址、窗口大小、窗口模式和访问权限字段定义。窗口属性在内核模式驱动程序将 IDPTE 分配给所有者或特权提交者的同时初始化。IDPTE 中的窗口启用字段控制内存窗口是否对该 IDPTE 处于活动状态。</p>
<p>如果窗口启用为 0，则硬件在使用该条目时不会执行地址范围检查。经过验证的提交者可以访问地址空间中的任何地址，并且窗口模式、窗口基址和窗口大小字段被保留。</p>
<p>如果窗口启用为 1，则硬件检查引用 IDPTE 的描述符中的内存区域是否位于内存窗口内。内存窗口不得绕过 264 地址边界。窗口模式字段控制引用 IDPTE 的描述符中的地址的解释。</p>
<p>支持两种窗口模式：</p>
<ul>
<li><p>地址模式：硬件检查引用 IDPTE 的描述符中的内存区域是否位于窗口内，即位于窗口基址与窗口基址和窗口大小之和之间。</p>
</li>
<li><p>偏移模式：描述符中内存区域的地址被视为与窗口基址的偏移量。内存区域的有效起始位置计算为窗口基址与引用该 IDPTE 的描述符中的地址之和。内存区域的有效结束位置是有效起始地址和区域大小之和。内存区域的有效起始位置和结束位置必须位于窗口内。</p>
</li>
</ul>
<p>IDPTE 指定使用该条目进行内存访问的读写权限。如果请求的权限与授予的权限不匹配，则访问被拒绝。</p>
<blockquote>
<p>即使 IDPTE 授予读写权限，如果 IOMMU 地址转换不允许，内存访问仍可能失败。</p>
</blockquote>
<h3 id="3-14-4-内存窗口修改"><a href="#3-14-4-内存窗口修改" class="headerlink" title="3.14.4 内存窗口修改"></a>3.14.4 内存窗口修改</h3><p>对于 SASS 或 SAMS IDPTE，如果 IDPTE 中的允许更新位为 1，则所有者可以使用更新窗口描述符修改内存窗口属性（第 8.3.20.8 节）。只有其 PASID 与 IDPTE 中的访问 PASID 匹配的进程才被允许发出更新窗口。如果描述符 PASID 与访问 PASID 不匹配，则更新窗口描述符将以错误完成。</p>
<p>当 IDPTE 的允许更新为 0 时，内核模式驱动程序可能会在 IDPTE 不可用时使用 MMIO 写入修改该条目。有关何时可以修改 IDPTE 中的不同字段的详细信息，请参阅第 9.2.29 节。</p>
<p>更新窗口描述符仅以原子方式更改 IDPTE 中的窗口基数、窗口大小、窗口模式、读写权限以及窗口启用字段的值。由于更新是由硬件以原子方式完成的，因此任何同时引用 IDPTE 的域间描述符都保证可以看到窗口属性的旧值或新值。完成原子更新后，更新窗口描述符还会执行隐式耗尽以清除仍在使用该 IDPTE 的更新前窗口属性的任何正在运行的描述符。这可确保当更新窗口操作完成时，引用该 IDPTE 的任何描述符也已完成。如第 8.3.20.8 节所述，更新窗口描述符还允许在必要时抑制隐式耗尽。</p>
<h2 id="3-15-管理命令"><a href="#3-15-管理命令" class="headerlink" title="3.15 管理命令"></a>3.15 管理命令</h2><p>通过写入命令寄存器，将管理命令提交给设备。管理命令用于启用和禁用设备、启用和禁用 WQ 以及耗尽和中止描述符。</p>
<p>一次只能提交一个命令。软件必须等待前一个命令完成后才能提交另一个命令。要确定命令何时完成，软件可以轮询命令状态寄存器或在发出命令时通过将请求完成中断字段设置为 1 来请求中断。</p>
<p>如果 GENCAP 中的命令功能支持为 1，则命令功能寄存器（如第 9.2.14 节所述）指示支持哪些管理命令。</p>
<p>有关如何提交这些命令的详细信息，请参阅第 9.2.12 节中命令寄存器的描述。有关支持哪些管理命令的信息，请参阅第 9.2.14 节中命令功能寄存器的描述。</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Enable Device</td>
<td>检查设备配置并启用设备。在启用任何 WQ 之前，必须先启用设备。</td>
</tr>
<tr>
<td>Disable Device</td>
<td>停止接受所有 WQ 的描述符，等待所有描述符完成，禁用所有 WQ，然后禁用设备。</td>
</tr>
<tr>
<td>Enable WQ</td>
<td>检查 WQ 配置并启用 WQ。命令成功完成后，可以将描述符提交给 WQ。</td>
</tr>
<tr>
<td>Disable WQ</td>
<td>停止接受指定 WQ 的描述符，等待所有排队到 WQ 的描述符完成，然后禁用 WQ。</td>
</tr>
<tr>
<td>Drain All</td>
<td>等待所有 WQ 和所有引擎中在 Drain All 命令之前提交的所有描述符。设备可能会在命令等待先前描述符完成时开始处理新描述符；因此，在命令完成时，命令之后提交的描述符可能正在进行中。</td>
</tr>
<tr>
<td>Abort All</td>
<td>放弃和&#x2F;或等待在 Abort All 命令之前提交的所有 WQ 和所有引擎中的所有描述符。软件必须确保在提交命令之后和完成之前没有将任何描述符提交给任何 WQ；否则，行为是未定义的。</td>
</tr>
<tr>
<td>Drain WQ <br />Abort WQ</td>
<td>等待所有描述符提交到指定的 WQ。软件必须确保在命令提交后且在命令完成之前没有描述符提交到任何指定的 WQ；否则，行为未定义。中止 WQ 可能会放弃 WQ 中的部分或全部描述符，而不是完成它们</td>
</tr>
<tr>
<td>Drain PASID<br/>Abort PASID</td>
<td>等待所有 WQ 和所有引擎中与指定 PASID 关联的所有描述符。命令完成后，设备中不再有该 PASID 的描述符。软件必须确保在提交命令之后和完成之前没有将具有指定 PASID 的描述符提交给设备；否则，行为未定义。中止 PASID 可能会放弃部分或全部描述符，而不是完成它们。</td>
</tr>
<tr>
<td>Reset Device</td>
<td>停止接受所有 WQ 上的描述符，中止设备中的所有描述符，等待任何正在进行的操作，禁用所有 WQ，禁用设备，并将整个设备配置清除为开机值，命令、命令状态和软件错误寄存器、MSI-X 表和 IMS 除外。如果设备已禁用，则仅清除设备配置。有关设备寄存器的初始值，请参阅表 9-3。</td>
</tr>
<tr>
<td>Reset WQ</td>
<td>停止接受指定 WQ 的描述符，中止 WQ 中的所有描述符，等待任何正在进行的操作，并禁用 WQ。然后将指定 WQ 的 WQ 配置寄存器重置为初始值，但未修改的 WQ Size 字段除外。对于任何已禁用的指定 WQ，仅重置 WQ 配置寄存器。此命令允许指定多个工作队列。有关设备寄存器的初始值，请参阅表 9-3。</td>
</tr>
<tr>
<td>Request Interrupt Handle</td>
<td>请求一个中断句柄，该句柄可在描述符中用于请求完成中断。如果支持此命令（如命令功能寄存器所示），软件必须使用此命令来获取中断句柄。<br/>如果没有其他可用的中断句柄，则此命令的结果可能是错误。有关更多信息，请参阅第 3.7 节。</td>
</tr>
<tr>
<td>Release Interrupt Handle</td>
<td>释放先前由请求中断句柄命令返回的中断句柄。此命令可用于释放不再需要的句柄。一旦发出此命令，已释放的句柄就不能用于请求中断。如果任何之前使用已释放句柄提交的描述符尚未完成，则行为未定义。</td>
</tr>
<tr>
<td>Request IDPT Handle</td>
<td>请求一个句柄，该句柄可用于描述符中，以引用域间权限表中的指定 IDPT 条目。如果 CMDCAP 中的请求 IDPT 句柄字段为 1，则软件必须使用此命令来获取 IDPT 句柄。<br/>如果 CMDCAP 中的请求 IDPT 句柄字段为 0，则此命令代码被保留，软件使用域间权限表中条目的索引作为句柄。</td>
</tr>
<tr>
<td>Release IDPT Handle</td>
<td>释放先前由请求 IDPT 句柄命令返回的 IDPT 句柄。<br/>软件可以使用此命令释放域间权限表中不再使用的条目的句柄。当支持请求 IDPT 句柄命令时，硬件可以随时撤销 IDPT 句柄。在获取 IDPT 条目的新句柄后，软件应使用此命令释放过期的句柄。有关更多信息，请参阅第 7.5.6 节。</td>
</tr>
<tr>
<td>Invalidate Submitter Bitmap Cache</td>
<td>使提交者位图缓存的全部或部分失效。如果 CMDCAP 中的“使提交者位图缓存失效”字段为 1，则软件必须在更新提交者位图的任何部分或修改位图的任何页面的地址映射后发出此命令。<br/>如果 CMDCAP 中的“使提交者位图缓存失效”字段为 0，则此命令代码保留，不需要使位图缓存失效。</td>
</tr>
</tbody></table>
<h4 id="排空和中止命令"><a href="#排空和中止命令" class="headerlink" title="排空和中止命令"></a>排空和中止命令</h4><p>完成任何等待或放弃描述符的命令后，硬件保证不会因任何受影响的描述符而生成进一步的地址转换、内存读取、内存写入或中断。根据实现方式，任何耗尽命令除了需要等待的描述符外，还可能等待其他描述符的完成。</p>
<p>发出任何类型的中止命令时，硬件可能会放弃或完成任何受影响的描述符。一些描述符可能已完成，而其他描述符则被放弃。如果描述符已完成，则将执行所有相关的内存访问、完成记录和完成中断。如果描述符被放弃，则不会写入完成记录，也不会为该描述符生成完成中断，但可能会发生部分或全部其他内存访问。由于中止和重置命令不能保证放弃已经开始的操作，因此它们对于终止花费时间超过预期的操作无效。可以使用 WQ 最大传输大小和 WQ 最大批处理大小配置寄存器来限制操作的最大大小。</p>
<h4 id="排空和中止命令的软件使用"><a href="#排空和中止命令的软件使用" class="headerlink" title="排空和中止命令的软件使用"></a>排空和中止命令的软件使用</h4><p>当使用英特尔 DSA 的应用程序或虚拟机被暂停时，它可能有未完成的描述符提交给设备。必须完成这项工作，以便客户端处于一致状态，以便稍后恢复。操作系统或 VMM 使用 Drain PASID 和 Drain All 命令来等待任何未完成的描述符。Drain PASID 命令用于使用单个 PASID 的应用程序或虚拟机。Drain All 命令用于使用多个 PASID 的虚拟机。</p>
<p>当使用该设备的应用程序退出或被操作系统终止时，操作系统需要确保没有未完成的描述符，然后才能释放或重新使用地址空间、分配的内存和 PASID。为了清除任何未完成的描述符，操作系统使用 Abort PASID 命令，其中包含要终止的客户端的 PASID。收到此命令后，设备将丢弃属于指定 PASID 的所有描述符，而无需进一步处理。</p>
<h2 id="3-16-虚拟化"><a href="#3-16-虚拟化" class="headerlink" title="3.16 虚拟化"></a>3.16 虚拟化</h2><p>英特尔 DSA 架构旨在实现轻松高效的虚拟化。英特尔 DSA 支持英特尔可扩展 I&#x2F;O 虚拟化模型。有关英特尔可扩展 IOV 架构的更多详细信息，请参阅第 1.2 节参考资料中列出的英特尔® 可扩展 I&#x2F;O 虚拟化技术规范。</p>
<p>本节介绍旨在支持高效虚拟化的英特尔 DSA 功能。第 7.3 节介绍了使用这些功能的软件设计。</p>
<ul>
<li>可直接访问的 MMIO 寄存器：MMIO 空间将性能关键寄存器（即通道）布置在单独的 4K 页中，以允许使用 CPU 扩展页表 (EPT) 直接映射到虚拟机。</li>
<li>最小化客户端特定状态：该架构旨在在设备上存储最少的客户端特定状态以提高可扩展性。例如，描述符的设计使得处理描述符所需的信息包含在描述符本身中。</li>
<li>功能：软件读取功能寄存器以检测对故障块等功能的支持。<br>  通过功能虚拟化，VMM 可以将设备功能的一个子集公开给虚拟机，这有助于在具有不同功能的多代英特尔 DSA 设备之间部署虚拟机映像和迁移虚拟机。</li>
<li>英特尔可扩展 IOV：英特尔可扩展 IO 虚拟化架构降低了虚拟化复杂性，并允许在大量虚拟机之间共享设备。</li>
<li>客户机操作系统中断：英特尔 DSA 为客户机定义了一个命令，用于请求完成中断句柄，并在其描述符中使用完成中断句柄来请求完成中断。每个句柄表示中断消息存储中的一个条目，该条目已配置为该客户的中断。设备使用 IMS 条目将中断发送到 VM。</li>
</ul>
<h1 id="4-服务质量控制"><a href="#4-服务质量控制" class="headerlink" title="4 服务质量控制"></a>4 服务质量控制</h1><h2 id="4-1-工作派遣优先"><a href="#4-1-工作派遣优先" class="headerlink" title="4.1 工作派遣优先"></a>4.1 工作派遣优先</h2><p>Intel DSA 提供 WQ 优先级来控制从同一组中的多个 WQ 调度工作时的服务质量。每个 WQ 的优先级在其 WQ 配置寄存器中指定，如 9.2.24 中所述。WQ 优先级范围从 1 到 15。WQ 优先级相对于同一组中的其他 WQ。组中的工作队列可以具有相同或不同的优先级。</p>
<p>每个组的仲裁器根据优先级使用以下过程从组中的 WQ 调度描述符：每个 WQ 都有一个计数器，该计数器初始化为 WQ 的优先级，并且每次从 WQ 调度描述符时都会递减。每个组的仲裁器遍历组中的 WQ，从每个具有可用描述符且计数器非零的 WQ 调度一个描述符。一旦 WQ 的计数器达到零，就不会再从该 WQ 调度描述符，直到计数器重置。一旦组中所有具有待处理描述符的 WQ 的所有计数器都达到零，组中所有 WQ 的计数器将重新初始化为各自 WQ 的优先级。</p>
<p>因此，例如，优先级为 6 的 WQ 将向引擎发出 3 倍于优先级为 2 的 WQ 的描述符（假设两个 WQ 始终都有可用的描述符）。</p>
<p>当软件将描述符提交给之前为空的 WQ 时，如果 WQ 的计数器不为零，则无论 WQ 的优先级如何，都将在下一个 WQ 轮到时处理该描述符。</p>
<p>仲裁器检查空 WQ 以查看它们是否有可用的描述符不会造成延迟。<br>可以按照引擎可以处理的速率向组中的引擎发出描述符，即使唯一具有可用描述符的 WQ 具有低优先级。</p>
<h2 id="4-2-流量类别"><a href="#4-2-流量类别" class="headerlink" title="4.2 流量类别"></a>4.2 流量类别</h2><p>如果存在 PCIe VC 功能，Intel DSA 将支持 PCIe 中定义的流量类别。设备外部的平台可以使用流量类别来控制设备发起的内存事务的 QoS。</p>
<p>流量类别还用于设备内部，以隔离发往低带宽内存的流量。每个平台都有一个或多个指定的流量类别值，应用于访问低带宽内存。有关配置流量类别以用于低带宽内存的信息，请参阅第 4.5 节。</p>
<p>每个组配置寄存器中有两个流量类别寄存器。每个描述符都有标志，用于选择对描述符引用的每个缓冲区使用两个流量类别中的哪一个。为了获得最佳效果，软件应确保将具有不同 QoS 特征的操作发送给不同的组。</p>
<h2 id="4-3-读取缓冲区分配"><a href="#4-3-读取缓冲区分配" class="headerlink" title="4.3 读取缓冲区分配"></a>4.3 读取缓冲区分配</h2><p>Intel DSA 设备使用读取缓冲区来隐藏内存读取延迟。软件可以控制这些读取缓冲区的分配方式，从而影响某些客户机或应用程序可用的读取带宽。</p>
<p>读取缓冲区是英特尔 DSA 实现中的资源，分配给引擎以支持内存读取操作。支持的读取缓冲区总数由实现固定，并在 GRPCAP 寄存器中报告。限制组可用的读取缓冲区数量可以限制组中引擎可用的读取带宽。读取缓冲区与实际带宽之间的关系取决于瞬时系统内存延迟，并随着系统利用率的变化而动态变化。读取缓冲区是英特尔 DSA 设计的内部资源，与 SoC 中也会影响设备可用带宽的其他资源无关。</p>
<p>读取缓冲区分配给组的策略基于组配置寄存器中的两个字段。读取缓冲区保留字段表示为组中的引擎专用而预留的读取缓冲区数量。读取缓冲区允许字段表示组中所有引擎可以同时使用的读取缓冲区的最大数量。（分配给组的读取缓冲区也可能受全局读取缓冲区限制的限制，如第 9.2.8 节所述。）</p>
<p>将读取缓冲区保留字段设置为非零值可确保组中的引擎能够获取读取缓冲区，而不会被其他组中的引擎抢占。但是，为组保留读取缓冲区会限制其他组可用的读取缓冲区数量，从而可能限制它们有效利用设备带宽能力的能力。为所有组保留的读取缓冲区总数不得大于可用的读取缓冲区总数（如 GRPCAP 中报告的那样）。</p>
<p>对于每个组，允许的读取缓冲区字段必须大于或等于组中引擎数量的 4 倍。它还必须不大于该组的保留读取缓冲区字段的值加上非保留读取缓冲区的数量。非保留读取缓冲区的数量定义为支持的读取缓冲区总数减去为所有组保留的读取缓冲区数量。例如，如果设备支持 74 个读取缓冲区，并且为四个组中的每个组保留 3 个，则 62 个读取缓冲区保持非保留，并且每个组的允许读取缓冲区的最大值为 65。</p>
<p>允许读取缓冲区字段有一个系统特定的值（取决于系统的读取延迟），允许组利用设备的全部带宽。此值可以通过软件校准。将允许读取缓冲区字段设置为较大的值没有任何好处。将此字段设置为较小的值会限制可分配给组中引擎的读取缓冲区，从而限制它们对其他组中引擎性能的影响。</p>
<h2 id="4-4-延迟控制"><a href="#4-4-延迟控制" class="headerlink" title="4.4 延迟控制"></a>4.4 延迟控制</h2><p>Intel DSA 为软件提供控制，以减少设备中多个未完成描述符正在处理时对延迟的影响。在引擎中，可以以流水线方式同时处理多个描述符。如果 GRPCAP 中的“支持的描述符处理限制”字段为 1，则 ENGCAP 中的“最大处理中的工作描述符”和“最大处理中的批处理描述符”字段指定在给定时间内引擎中可以同时处理的最大数量。软件可以使用 GRPCFG 中的“工作描述符处理限制”和“处理中的批处理描述符限制”字段将其限制为小于实现支持的最大值的值。</p>
<p>GRPFLAGS 寄存器允许软件将“处理中的描述符限制”和“处理中的批处理描述符限制”字段配置为相应最大允许值的一小部分。指定的值适用于组中的每个引擎。</p>
<p>根据系统延迟条件，指定小于最大值的值有时会导致可实现的带宽较低。软件可以明智地设置限制字段，以在峰值性能和服务质量考虑之间实现适当的平衡。</p>
<p>每个组的仲裁器将 WQ 中的描述符分派到组中的引擎，直到达到为引擎配置的最大值。一旦分派到引擎的描述符数量达到最大值，则停止进一步分派到引擎，直到完成一个或多个描述符。</p>
<p>在此期间，其他描述符可能会在 WQ 中排队，最终导致软件尝试提交其他描述符时产生背压。软件可以使用此控件以及 WQ 配置中的 WQ 大小、最大传输大小和最大批处理大小控件来限制描述符可能因先前的描述符而经历的最大延迟。实际可实现的延迟优势取决于实现和系统。根据现行的系统延迟值，使用此控件可能会导致引擎的有效内存带宽降低。</p>
<h2 id="4-5-低带宽内存"><a href="#4-5-低带宽内存" class="headerlink" title="4.5 低带宽内存"></a>4.5 低带宽内存</h2><p>英特尔 DSA 包含一些功能，可在访问带宽较低或延迟高于 DRAM 的内存（如英特尔® 傲腾™ 数据中心级持久内存）时提高系统性能。当使用英特尔 DSA 读取和&#x2F;或写入这些类型的内存时，软件应采取这些步骤来限制对设备内和整个平台内其他操作吞吐量的影响。</p>
<ol>
<li>将 GENCFG 中的“全局读取缓冲区限制”字段设置为适合可用带宽的值。<br>  （此值取决于平台，可以通过软件校准。）</li>
<li>创建一个或多个将与访问低带宽内存的描述符一起使用的组。</li>
<li>将这些组的组配置寄存器中的“使用全局读取缓冲区限制”字段设置为 1。</li>
<li>将这些组中的 TC-B 字段设置为指定用于低带宽内存的流量类值。</li>
<li>每个描述符都应设置 TC 选择器标志，以指示其源地址和目标地址中的哪一个引用低带宽内存。</li>
</ol>
<p>软件必须小心地将工作提交给合适的组，并正确分类描述符中的每个缓冲区地址并设置 TC 选择器标志。如果将引用低带宽内存的描述符提交给未配置为支持低带宽内存的组，或者描述符中的 TC 选择器标志错误地指示相应地址不在低带宽内存中，则平台可能会阻止内存事务。如果内存事务是写入操作，则不会通知软件</p>
<p>如果软件无法正确分类其缓冲区，例如，如果系统软件的内存分配策略混合了正常和低带宽内存，以至于应用程序无法分辨它收到了哪种类型的内存，那么 GRPCFG 的 TC-A 和 TC-B 字段都应设置为适合低带宽内存的 TC 值</p>
<p>由“全局读取缓冲区限制”指定的读取缓冲区数量由所有在使用全局读取缓冲区限制为 1 的组内执行的所有描述符共享。执行描述符的引擎也受到 GRPCFG 中的“允许读取缓冲区”字段的限制。</p>
<h1 id="5-错误处理"><a href="#5-错误处理" class="headerlink" title="5 错误处理"></a>5 错误处理</h1><p>Intel DSA 错误检测和处理的主要目标是：</p>
<ul>
<li>• 避免写入不正确的数据或写入不正确的地址。</li>
<li>• 避免一个客户端的错误影响其他客户端的工作。</li>
<li>• 避免误解错误的操作描述符。</li>
<li>• 尽可能向提交工作的客户端报告错误。</li>
<li>• 提供足够的信息以继续部分完成的操作。</li>
<li>• 提供足够的信息以帮助诊断错误的原因。</li>
</ul>
<p>与描述符处理相关的错误在描述符的完成记录中报告（如果完成记录地址有效）。</p>
<p>硬件错误通过 PCI Express 高级错误报告报告。硬件错误包括结构中的错误和设备内部的错误。如果硬件错误与描述符相关，并且描述符中的完成记录地址有效，则该错误也会在完成记录中报告。</p>
<p>描述符的完成记录上的错误或在处理没有有效完成记录地址的描述符期间的错误将在软件错误寄存器或事件日志中报告。表 5-1 显示了软件错误处理概要。</p>
<h2 id="5-1-设备启用检查"><a href="#5-1-设备启用检查" class="headerlink" title="5.1 设备启用检查"></a>5.1 设备启用检查</h2><p>在向命令寄存器发出启用设备命令时，设备会执行以下检查：</p>
<ul>
<li>总线主控启用为 1。</li>
<li>所有 WQCFG 寄存器的 WQ 大小字段之和不大于总 WQ 大小。</li>
<li>对于每个 GRPCFG 寄存器：o WQ 和引擎字段要么都为零，要么都为非零。</li>
<li>WQ 字段中超出 WQ 数量的位为 0。</li>
<li>引擎字段中超出引擎数量的位为 0。</li>
<li>对于超出组数的组配置寄存器，所有字段均为零。</li>
<li>WQCFG 寄存器中大小字段非零的每个 WQ 都恰好属于一个组。</li>
<li>WQCFG 寄存器中大小字段为零的每个 WQ 都不属于任何组。</li>
<li>每个引擎不超过一个组。</li>
<li>如果 GRPCAP 中的全局读取缓冲区限制支持字段为 0，则每个 GRPCFG 寄存器中的使用全局读取缓冲区限制字段均为 0。</li>
<li>如果 GRPCAP 中的“全局读取缓冲区限制支持”字段为 1，则 GENCFG 中的“全局读取缓冲区限制”小于或等于 GRPCAP 中的“总读取缓冲区”字段。</li>
<li>如果任何 GRPCFG 寄存器中的“使用全局读取缓冲区限制”字段为 1，则 GENCFG 中的“全局读取缓冲区限制”至少是所有将“使用全局读取缓冲区限制”设置为 1 的组中引擎总数的 4 倍。</li>
<li>如果 GRPCAP 中的“读取缓冲区控制支持”字段为 1，则对于所有已分配引擎的组，“读取缓冲区保留”字段的总和小于或等于 GRPCAP 中的“总读取缓冲区”字段。</li>
<li>如果 GRPCAP 中的“读取缓冲区控制支持”字段为 1，则对于每个已分配引擎的组，“允许的读取缓冲区”为：</li>
<li>大于或等于组内发动机数量的4倍；</li>
<li>大于或等于该组的“读取缓冲区保留”字段；并且</li>
<li>小于或等于读取缓冲区保留字段与非保留读取缓冲区数量的总和。</li>
<li>如果 PRSCTL 中的启用位为 1，则 PRSREQALLOC 中允许的未完成页面请求数不为零，并且小于或等于 PRSREQCAP 中支持的最大页面请求数</li>
<li>如果 GENCFG 中的事件日志启用为 1：<ul>
<li>GENCAP 中的事件日志支持不为 0。</li>
<li>事件日志大小 ≥ 64</li>
<li>事件日志基地址 + 事件日志大小 × 事件日志条目大小 ≤ 2^64^</li>
</ul>
</li>
<li>当平台指示需要使用 ATS 或者不使用 ATS 时，ATS Enable 的设置将与要求相匹配。</li>
<li>如果 EVLCFG 中的 PASID 启用位为 1，则 PASIDCTL 中的 PASID 启用位也必须为 1。</li>
<li>如果 IDBR 中的 PASID 使能位为 1，则 PASIDCTL 中的 PASID 使能位也必须为 1。</li>
</ul>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726278790175.png" class="" title="QQ_1726278790175">

<blockquote>
<p>^1^在一些实现中，完成记录中报告的无效中断句柄错误不会在 SWERROR 中报告。</p>
</blockquote>
<p>如果任何设备启用检查失败，则不会启用该设备，并在命令状态寄存器中报告错误。这些检查可以按任何顺序执行。因此，一种错误类型的指示并不意味着没有其他错误。相同的配置错误可能会在不同时间或不同版本的设备中导致不同的错误代码。</p>
<p>如果所有检查均未失败，则启用该设备，并设置命令状态寄存器以指示成功完成启用设备命令。如果 GENCFG 中的事件日志启用为 1，则事件日志状态寄存器设置为 0。</p>
<h2 id="5-2-WQ-启用检查"><a href="#5-2-WQ-启用检查" class="headerlink" title="5.2 WQ 启用检查"></a>5.2 WQ 启用检查</h2><p>在向命令寄存器发出启用 WQ 命令时，设备会执行以下检查：</p>
<ul>
<li>• 设备已启用。</li>
<li>• WQ 参数小于工作队列数。</li>
<li>• WQ 已禁用。</li>
<li>• WQ 大小字段非零。</li>
<li>• WQ 模式字段选择支持的模式。也就是说，如果 WQCAP 中的共享模式支持字段为 0，则 WQ 模式为 1；或者如果 WQCAP 中的专用模式支持字段为 0，则 WQ 模式为 0。如果共享模式支持和专用模式支持字段均为 1，则允许 WQ 模式的任一值。</li>
<li>• 如果 WQ 优先级支持为 1，则 WQ 优先级字段非零。</li>
<li>• 如果 GENCAP 中的“故障时块支持”字段为 0 或 PCIe 页面请求控制寄存器的“启用”字段为 0，则“WQ 故障时块启用”字段为 0。<br>• 如果 WQ 模式字段为 0，则“WQ PASID 启用”字段为 1。</li>
<li>• 如果 PCI Express PASID 功能的“PASID 启用”字段为 0，则“WQ PASID 启用”字段为 0。</li>
<li>（此规则与上述规则结合使用，意味着在禁用 PASID 功能时无法使用共享 WQ。）• 如果 WQ 模式字段为 1，WQ PASID 启用为 1，并且 PCI Express PASID 功能的“特权模式启用”字段为 0，则 WQ Priv 字段必须为 0。</li>
<li>• WQ 最大传输大小字段不大于 GENCAP 中的最大支持传输大小字段。</li>
<li>• WQ 最大批处理大小字段大于 0 且不大于 GENCAP 中的最大支持批处理大小字段。</li>
<li>• 如果 SIOV 功能中的 IMS 支持字段为 0，或者如果不存在 SIOV 功能，则 WQ 占用中断表为 0。</li>
<li>• 如果不支持请求中断句柄命令，则 WQ 占用中断句柄小于所选中断表的大小（如果 WQ 占用中断表为 0，则为 MSI-X 表；如果 WQ 占用中断表为 1，则为 IMS 表）^1^。</li>
<li>• 如果支持请求中断句柄命令，则 WQ 占用中断句柄必须是该命令返回的句柄。</li>
<li>• 如果 WQCAP 中的 WQ 操作配置支持为 1，则 WQCFG 中的 OPCFG 字段不得将 OPCAP 中未设置为 1 的任何位设置为 1。也就是说，WQOPCFG 和 ~OPCAP 必须为 0。</li>
<li>• 如果 WQCAP 中的 WQ ATS 支持为 0，则 WQ ATS 禁用为 0。</li>
<li>• 如果 WQCAP 中的 WQ PRS 支持为 0 或 GENCFG 中的事件日志启用为 0 或 WQ 故障阻止启用为 1，则 WQ PRS 禁用为 0。</li>
</ul>
<blockquote>
<p>^1^在执行此检查之前，设备可能会丢弃 WQ 占用中断句柄的高位。</p>
</blockquote>
<p>如果任何 WQ 启用检查失败，则不会启用 WQ，并在命令状态寄存器中报告错误。这些检查可以按任何顺序执行。因此，指示一种类型的错误并不意味着没有其他错误。相同的配置错误可能会在不同时间或不同版本的设备中导致不同的错误代码。</p>
<p>如果所有检查均未失败，则启用 WQ，并设置命令状态寄存器以指示启用 WQ 命令成功完成。</p>
<h2 id="5-3-描述符提交检查"><a href="#5-3-描述符提交检查" class="headerlink" title="5.3 描述符提交检查"></a>5.3 描述符提交检查</h2><p>收到描述符后，设备将按顺序执行以下检查。除非另有说明，如果任何一项检查失败，则将丢弃该描述符；如果描述符是使用 DMWr 提交的，则将返回重试响应。</p>
<ul>
<li>提交描述符所用的portal地址所标识的WQ为Enabled</li>
<li>如果描述符被提交到共享WQ：<ul>
<li>它是使用 DMWr 提交的（例如，使用 ENQCMD 或 ENQCMDS 指令）。</li>
<li>如果描述符是通过受限通道提交的，则当前队列占用率小于 WQ 阈值。<a href="#jump">^1^</a></li>
<li>如果描述符是通过无限制通道提交的，则当前队列占用率小于 WQ 大小。</li>
</ul>
</li>
<li>如果描述符被提交到专用的WQ：<ul>
<li>它是通过已发布的、对齐的 64 字节写入提交的（例如，使用 MOVDIR64B 指令）。</li>
<li>队列占用率小于WQ Size。如果此检查失败，则描述符被丢弃，并将错误记录在SWERROR中。</li>
</ul>
</li>
</ul>
<p>请注意，如果使用 MOVDIR64B 写入已禁用的 WQ、共享的 WQ 或无效的通道地址，则该写入将被丢弃，而不会通知软件</p>
<blockquote>
<p><span id="jump">^1^</span>如果 WQ Threshold 大于 WQ Size，则视为等于 WQ Size。</p>
</blockquote>
<h2 id="5-4-描述符检查"><a href="#5-4-描述符检查" class="headerlink" title="5.4 描述符检查"></a>5.4 描述符检查</h2><p>设备在处理每个描述符时会执行以下检查：</p>
<ul>
<li>如果完成记录地址有效标志为 1，则完成记录地址是 32 字节对齐的。</li>
<li>操作码字段中的值对应于所支持的操作（如 OPCAP 中所示）</li>
<li>该操作在提交的上下文中有效。批处理和排空操作在批处理中不受支持，并被视为无效操作代码</li>
<li>未设置保留标志。这包括 GENCAP 寄存器中相应功能位为 0 的标志。</li>
<li>Flags 字段中未设置任何不支持的标志。这包括为某些操作保留的标志。例如，Fence 位在直接入队而不是作为批处理的一部分入队的描述符中保留。它还包括在配置中禁用的标志，例如 Block On Fault 标志，当 WQCFG 寄存器中的 Block On Fault Enable 字段为 0 时，该标志被保留。有关详细信息，请参阅表 5-3 和表 5-4。</li>
<li>Flags 字段中设置了必需的标志。例如，在比较操作的描述符中，请求完成记录标志必须为 1。有关详细信息，请参阅表 5-5。</li>
<li>保留字段（除标志外）为 0。这包括任何对指定操作没有定义含义的字段。某些实现可能不会检查所有保留字段，但软件应注意清除所有未使用的字段以实现最大兼容性。</li>
<li>在提交到共享 WQ 的描述符中，如果 PCI Express PASID 功能的特权模式启用字段为 0，则 Priv 字段为 0。</li>
<li>在 Batch 描述符中，描述符计数字段大于 1，并且不大于 WQ Config 寄存器中的 WQ Maximum Batch Size 字段指定的值。</li>
<li>传输大小（如果适用于描述符类型）大于 0 并且不大于 WQ 配置寄存器中的 WQ 最大传输大小字段指定的值。</li>
<li>在创建增量记录或应用增量记录描述符中，传输大小不大于允许值（0x80000 字节或 512 KB，如第 8.3.8 节所述）。</li>
<li>在创建 Delta 记录或应用 Delta 记录描述符中，最大 Delta 记录大小或 Delta 记录大小（适用于描述符类型）不大于 WQ 配置寄存器中的 WQ 最大传输大小字段指定的值。</li>
<li>在创建增量记录描述符中，最大增量记录大小大于或等于 80 字节。</li>
<li>在应用增量记录描述符中，增量记录大小大于或等于 10 个字节。</li>
<li>在具有双播描述符的内存复制中，两个目标地址的位 11:0 相同。</li>
<li>目标缓冲区不与源缓冲区或其他目标缓冲区重叠。（如果重叠复制支持能力为 1，则不会对内存移动操作执行此检查。）</li>
<li>如果请求完成中断标志为 1，则完成中断句柄根据表 5-2 有效。</li>
<li>如果请求完成中断标志为 1，则所选中断表条目中的 PASID 启用字段等于描述符提交到的工作队列的 WQ PASID 启用控制。<br>此外，如果 PASID 启用字段为 1，则所选中断表条目中的 PASID 字段等于描述符的 PASID。</li>
<li>描述符标志选择的流量类别在 VC 资源控制寄存器的 TC&#x2F;VC 映射中具有相应的位设置，并且该寄存器中的 VC 启用位为 1。</li>
<li>如果 WQCAP 中的 WQ 操作配置支持为 1，则操作代码字段中的值对应于 WQ OPCFG 中指示的支持的操作；或者如 OPCAP 中所示。</li>
<li>该操作在提交的上下文中有效。批处理、清空和更新窗口操作在批处理中不受支持，并且被视为无效操作代码。提交给 WQ 的 Translation Fetch 操作（在 WQ 配置中将 WQ ATS 禁用设置为 1）被视为无效操作代码。</li>
<li>在 Translation Fetch 描述符中，Region Size 非零，并且 Address 与 Region Size 之和小于或等于 2^64^ 。</li>
</ul>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726279498210.png" class="" title="QQ_1726279498210">

<ul>
<li>在 Translation Fetch 描述符中，Region Stride 大于或等于 4096，并且是 2 的幂。</li>
<li>在域间内存复制或域间比较描述符中，至少一个使用备用 PASID 标志为 1。</li>
<li>在域间内存填充或域间缓存刷新描述符中，使用备用目标 PASID 标志为 1。</li>
<li>在域间比较模式描述符中，使用备用源 PASID 标志为 1。</li>
<li>对于域间或更新窗口描述符，提交该描述符的工作队列的 WQ PASID 启用控制为 1。</li>
<li>如果不支持请求 IDPT 句柄命令，则域间或更新窗口描述符中的任何 IDPT 句柄都小于域间权限表大小。</li>
<li>如果支持请求 IDPT 句柄命令，则域间或更新窗口描述符中的任何 IDPT 句柄都是该命令返回的句柄。</li>
<li>在更新窗口描述符中，如果窗口启用标志为 1，则窗口大小字段不为零。</li>
</ul>
<p>如果完成记录地址有效标志为 0，并且任何这些检查失败，则会在软件错误寄存器或事件日志中报告该错误。</p>
<p>如果完成记录地址有效标志为 1，且完成记录地址未对齐或无法转换，或者完成记录 TC 无效，则将丢弃描述符并在软件错误寄存器或事件日志中报告错误。</p>
<p>否则，如果任何这些检查失败，则完成记录将写入状态字段，指示失败的检查类型，并将完成字节设置为 0。如果其中一个标志检查失败，则完成记录的无效标志字段指示无效的标志。如果请求，则生成完成中断，除非与完成中断传递相关的检查失败。如果指定了无效的中断句柄，则还会在事件日志（如果已启用）或软件错误寄存器中报告错误。^1^ </p>
<blockquote>
<p>在一些实现中，完成记录中报告的无效中断句柄错误不会在 SWERROR 中报告。</p>
</blockquote>
<p>这些检查可以按任何顺序执行。因此，完成记录中指示一种类型的错误并不意味着没有其他错误。同一个无效描述符可能会在不同时间或使用不同版本的设备报告不同的错误代码。</p>
<h2 id="5-5-描述符保留字段检查"><a href="#5-5-描述符保留字段检查" class="headerlink" title="5.5 描述符保留字段检查"></a>5.5 描述符保留字段检查</h2><p>描述符中的保留字段分为三类：始终保留的字段；在某些条件下保留的字段（例如，基于功能、配置字段、描述符的提交方式或描述符本身中其他字段的值）；以及基于操作类型保留的字段。有关描述符格式的更多详细信息，请参阅第 8 章。</p>
<p>表 5-3 列出了每种操作类型允许和保留的标志和字段。未列出的标志适用于所有操作类型。标志位 5、6 和 15 为所有操作类型保留。标志位 23:16 是操作特定的，除非操作说明中描述了它们的用途，否则将保留。</p>
<p>表 5-4 列出了保留某些标志和字段的其他条件。其他特定于操作的保留字段和标志与第 8.3 节中的相应描述符详细信息一起描述。</p>
<p>表 5-5 列出了需要将某些标志设置为 1 的操作类型。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726279686703.png" class="" title="QQ_1726279686703">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726279698135.png" class="" title="QQ_1726279698135">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726279716416.png" class="" title="QQ_1726279716416">

<h2 id="5-6-域间权限表条目检查"><a href="#5-6-域间权限表条目检查" class="headerlink" title="5.6 域间权限表条目检查"></a>5.6 域间权限表条目检查</h2><p>设备在处理引用 IDPT 条目的描述符时执行以下检查：</p>
<ul>
<li>描述符中引用的任何 IDPTE 必须满足以下条件：<ul>
<li>保留字段为 0，如第 9.2.29 节所述。（这包括有条件保留的字段）。</li>
<li>IDPTE 中的类型字段必须是 IDCAP 中支持的类型之一。</li>
<li>如果窗口启用为 1：<ul>
<li>窗口基数加上窗口大小必须小于或等于 2 64（即窗口不得绕过 2 64 地址边界）</li>
<li>窗口大小不为零</li>
</ul>
</li>
</ul>
</li>
<li>对于任何域间描述符：<ul>
<li>每个引用的 IDPTE 必须将 Usable 字段设为 1。</li>
<li>与源地址对应的IDPTE必须具有读权限1。</li>
<li>与目标地址对应的IDPTE必须具有写权限1。</li>
<li>对于域间缓存刷新操作，R 或 W 必须为 1。</li>
<li>如果类型为 0，则描述符 PASID 必须与 IDPTE 中的提交者 PASID 字段匹配。</li>
<li>如果类型为1，则内存中的提交者位图中描述符PASID对应的位必须为1。</li>
<li>如果 IDPTE 中的窗口使能为 1，且窗口模式为 0，则引用 IDPTE 的描述符中的地址范围必须位于窗口基址和大小指定的范围内；具体而言：<ul>
<li>地址必须大于或等于窗口基数，并且小于窗口基数加上窗口大小。</li>
<li>地址加上传输大小必须大于窗口基数，并且小于或等于窗口基数加上窗口大小。</li>
</ul>
</li>
<li>如果 IDPTE 中的窗口启用为 1，且窗口模式为 1，则地址必须小于窗口大小，并且地址加上传输大小必须小于或等于窗口大小。</li>
</ul>
</li>
<li>对于更新窗口描述符：<ul>
<li>IDPTE 中的允许更新位必须为 1。</li>
<li>描述符 PASID 必须与 IDPTE 中的访问 PASID 字段匹配。</li>
</ul>
</li>
</ul>
<h2 id="5-7-设备暂停状态"><a href="#5-7-设备暂停状态" class="headerlink" title="5.7 设备暂停状态"></a>5.7 设备暂停状态</h2><p>除了正常运行状态外，英特尔 DSA 还具有暂停状态，用于处理各种错误或不支持的条件和重置转换。软件可以通过读取通用状态寄存器的设备状态字段来找出当前设备状态。GENSTS 还指示从设备暂停状态恢复所需的重置类型。据此，软件确定如何重置设备并将其置于正常运行模式。如果 GENCTRL 中的暂停状态中断启用字段为 1，则当设备进入暂停状态时，将使用 MSI-X 表的条目 0 生成中断。INTCAUSE 寄存器中的暂停状态字段设置为 1，以向软件指示中断原因。可能导致设备进入暂停状态的一些原因包括：</p>
<ul>
<li>不支持的 PCIe 配置更改（例如，将 BME 设置为 0）。</li>
<li>寄存器写入或某些内部缓冲区发生奇偶校验错误</li>
<li>严重的 I&#x2F;O 结构错误（例如，通过内部 I&#x2F;O 结构接收的事务遇到奇偶校验错误）。</li>
</ul>
<p>请注意，并非所有错误都会导致设备进入此状态，大多数错误都可以得到处理，而不会导致设备停止运行。还要注意的是，数据的奇偶校验错误通常会通过 PCIe AER 机制报告和处理，不被视为严重的 I&#x2F;O 错误。</p>
<p>在此状态下，设备通常会停止发送上游读取和写入。根据错误的严重程度，设备可能会继续发送非发布请求（例如，寄存器读取）的完成。通过 ENQCMD 或 ENQCMDS 提交的新描述符会收到重试响应。设备通常会继续发送无效完成，除非它遇到严重的 I&#x2F;O 结构错误或正在主动进行 PCIe 重置。实现可能会将设备禁用时可读写的配置寄存器也视为处于暂停状态的可读写寄存器。</p>
<p>此状态需要某种程度的复位才能使设备恢复正常运行。所需复位的类型（复位设备命令、功能级复位、热复位或冷复位）由 GENSTS 寄存器中的“需要恢复的复位类型”字段指示（参见第 9.2.10 节）。</p>
<h2 id="5-8-错误代码"><a href="#5-8-错误代码" class="headerlink" title="5.8 错误代码"></a>5.8 错误代码</h2><h3 id="5-8-1-操作状态代码"><a href="#5-8-1-操作状态代码" class="headerlink" title="5.8.1 操作状态代码"></a>5.8.1 操作状态代码</h3><p>如果描述符有有效的完成记录，则将描述符的操作状态代码写入描述符完成记录的状态字段。如果操作状态为 0x1a、0x1b 或 0x1d，或者完成记录地址有效标志为 0 且操作状态不等于 0x01、0x02 或 0x05，则将操作状态代码写入 SWERROR 寄存器或事件日志（如果已启用）。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280116203.png" class="" title="QQ_1726280116203">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280146197.png" class="" title="QQ_1726280146197">

<blockquote>
<p>内存写入时硬件错误的报告依赖于实现。</p>
</blockquote>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280172156.png" class="" title="QQ_1726280172156">

<h3 id="5-8-2-其他软件错误代码"><a href="#5-8-2-其他软件错误代码" class="headerlink" title="5.8.2 其他软件错误代码"></a>5.8.2 其他软件错误代码</h3><p>这些错误在命令状态寄存器中报告（如第 9.2.13 节所述）。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280203522.png" class="" title="QQ_1726280203522">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280233191.png" class="" title="QQ_1726280233191">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280244152.png" class="" title="QQ_1726280244152">

<h2 id="5-9-事件日志"><a href="#5-9-事件日志" class="headerlink" title="5.9 事件日志"></a>5.9 事件日志</h2><p>描述符的完成记录上的错误或在处理没有有效完成记录地址的描述符期间发生的错误通常会报告在软件错误寄存器中。在软件处理软件错误寄存器之前发生多个此类错误会导致溢出情况。或者，如果 GENCAP 中的事件日志支持字段的值不为 0，则硬件支持在内存中的事件日志中记录此类事件。软件在 EVLCFG 寄存器中指定事件日志区域的地址和大小。如果在设备启用时 GENCFG 中的事件日志启用位为 1，则启用事件日志。</p>
<p>GENCAP 中的事件日志支持字段指定了事件日志中条目的大小。事件日志条目的格式在第 5.9.1 节中描述。实现可以将事件日志写入作为已翻译或未翻译的访问发出。软件必须固定与事件日志相对应的内存页面。事件日志写入以 TC 值 0 执行。如果 EVLCFG 中的 PASID 启用字段为 1，则事件日志写入将使用 EVLCFG 中指定的 PASID 和权限作为具有 PASID 的写入发出。如果启用了事件日志，则设备在启用时初始化 EVLSTATUS 中的头部和尾部字段。启用后，硬件将每个事件写入 EVLSTATUS 中事件日志尾部字段指定的偏移量并增加尾部值。当尾部到达日志末尾时，它会换行到 0。软件要处理的下一个事件由 EVLSTATUS 中的事件日志头部字段指定。软件在处理事件日志头部的一个或多个事件后更新头部字段。当 tail + 1 mod logsize &#x3D; head 时，表示日志已满。</p>
<p>在将事件写入日志时，如果 GENCTRL 中的事件日志中断启用字段为 1 且 EVLSTATUS 中的中断待处理位为 0，则硬件会将 EVLSTATUS 中的中断待处理位设置为 1，将中断原因寄存器的事件日志字段设置为 1，并使用 MSI-X 条目 0 生成中断。在软件清除中断待处理位之前，不会为其他日志条目生成进一步的中断。</p>
<p>如果 GENCAP 中的事件日志溢出支持为 0，并且当硬件尝试附加事件时事件日志已满，则硬件将阻塞，直到软件在处理日志头部的一个或多个事件后更新事件日志头部字段。因此，软件必须确保内存中的事件日志区域大小足够，并且事件日志条目及时处理。如果 GENCAP 中的事件日志溢出支持为 1，并且当硬件尝试附加事件时事件日志已满，则事件将被丢弃，并且硬件尝试在 SWERROR 寄存器中记录错误以指示事件日志已满情况。如果 SWERROR 寄存器中的有效位已经为 1，则行为如第 9.2.15 节所述。</p>
<p>如果在 PRS 被禁用 ^1^ 的情况下硬件在完成记录地址上遇到页面错误，则会将其报告为错误。如果启用了事件日志，硬件会将一个条目写入事件日志，其中包含指示页面错误原因的相应错误代码；否则，将通过 SWERROR 报告。在前一种情况下，硬件还会将该描述符的完成记录写入事件日志条目。写入事件日志的完成记录具有与第 8.3 节中描述的格式相同的格式。负责处理事件日志的软件应执行必要的操作，以在适当的情况下将完成记录传播到提交错误描述符的软件实体。如果需要，软件还应生成完成中断。</p>
<blockquote>
<p>PCI Express PRS 启用控制为 0，或者 WQCFG 中的 WQ PRS 禁用为 1</p>
</blockquote>
<p>事件日志条目按照引擎完成描述符的顺序写入，如第 3.9 节所述。如果由于完成记录地址上的页面错误而将批次中任何描述符的完成记录写入事件日志，则如果批次描述符需要完成记录或完成中断，则相应批次描述符的完成也会写入事件日志。仅在写入批次中描述符的任何完成记录和事件日志条目后，才会写入批次描述符的事件日志条目。在这种情况下，批次描述符的事件日志条目中的错误代码表示批次中的一个或多个描述符具有与必须由软件处理的完成记录相关联的事件日志条目。</p>
<p>硬件生成批次标识符值，以允许软件关联批次内描述符和相应批次描述符的事件日志条目，并在事件日志条目的批次标识符字段中报告。一旦写入批次描述符的事件日志条目，硬件就可以重新使用批次标识符。批次中第一个错误标记为 1 的事件日志条目标识该批次的第一个条目。这允许软件识别具有相同批次标识符的任何过时事件日志条目。如果软件遇到此标记为 1 的条目，则应丢弃先前为相同批次标识符记录的任何未解决的页面错误。</p>
<p>如果启用了事件日志，并且 PRSCTL 中的启用位为 0，或者 WQCFG 中的 WQ PRS 禁用为 1，则将 Drain 描述符的完成写入事件日志。<br>^1^ 如果未启用事件日志，则将 Drain 描述符完成记录写入完成记录地址。</p>
<blockquote>
<p>在一些实现中，即使未启用 PRS，也可能将 Drain 描述符的完成写入事件日志。</p>
</blockquote>
<h3 id="5-9-1-事件日志条目"><a href="#5-9-1-事件日志条目" class="headerlink" title="5.9.1 事件日志条目"></a>5.9.1 事件日志条目</h3><p>每个条目的格式如下所示。事件日志条目中超出此处指定范围的任何字节以及 GENCAP 中指定的条目大小均被保留。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280470945.png" class="" title="QQ_1726280470945">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280482020.png" class="" title="QQ_1726280482020">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280516092.png" class="" title="QQ_1726280516092">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280536974.png" class="" title="QQ_1726280536974">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280602575.png" class="" title="QQ_1726280602575">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280617553.png" class="" title="QQ_1726280617553">

<img src="/2024/09/13/Intel-DSA-spec/QQ_1726280637047.png" class="" title="QQ_1726280637047">

<h1 id="6-性能监控"><a href="#6-性能监控" class="headerlink" title="6 性能监控"></a>6 性能监控</h1><p>Intel DSA 性能监控功能 (perfmon) 的目的是支持收集设备执行期间发生的关键事件（架构或微架构）的信息，以帮助性能调优和调试。这也有助于了解设备支持的关键功能和操作的用法。perfmon 架构包括三个部分：</p>
<ul>
<li>能够发现并枚举给定英特尔 DSA 实施所支持的性能功能。</li>
<li>一组配置和数据寄存器，用于启用和配置设备来监控所支持事件的子集。</li>
<li>支持的事件和过滤器列表。</li>
</ul>
<p>用于枚举和配置各种性能监控功能的寄存器的详细信息可在第 9.2.25 节中找到。</p>
<h2 id="6-1-Perfmon-发现和枚举"><a href="#6-1-Perfmon-发现和枚举" class="headerlink" title="6.1 Perfmon 发现和枚举"></a>6.1 Perfmon 发现和枚举</h2><p>软件读取一组功能寄存器，以发现设备是否支持性能监控功能，如果支持，则枚举功能的详细信息，如计数器数量、计数器宽度、事件类别、过滤器支持等。如果实现不支持性能监控，则性能功能 (PERFCAP) 寄存器将报告为 0，并且不支持其他性能监控功能、配置和数据寄存器。</p>
<p>软件通过指定两条信息来配置计数器以监控事件：计数器配置寄存器 (CNTRCFG) 中的事件类别和事件字段。英特尔 DSA 性能监控架构定义了一组架构事件类别以及每个事件类别的一组特定于实现的事件。事件类别在表 6-1 中定义。未来实现中可能会添加其他事件类别。</p>
<p>对应于定义的每个事件类别，都有一个事件功能寄存器 (EVNTCAP) 来报告该类别支持的事件集。如果实现不支持给定事件类别的任何事件，则 EVNTCAP 中的事件字段将报告为零，并且软件不应尝试配置具有该类别的任何计数器。附录 D 中提供了与每个事件类别对应的事件的详细信息。当启用计数器来计数给定类别的事件时，将忽略指定事件类别中不支持的事件对应的位。软件不应依赖此行为，因为未来的实现可能会支持事件类别中的其他事件，从而导致在一个实现中被忽略的位在另一个实现中具有定义的含义。</p>
<p>事件类别和事件到事件计数器的映射可能因实现而异。实现可能允许任何计数器计数任何事件。但是，实现也可以选择限制这一点，即每个事件计数器只允许计数某些事件类别。在这种情况下，软件可以查阅每个计数器功能寄存器 (CNTRCAP) 来发现每个计数器支持的事件类别和事件集。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726281062859.png" class="" title="QQ_1726281062859">

<h2 id="6-2-Perfmon-配置寄存器"><a href="#6-2-Perfmon-配置寄存器" class="headerlink" title="6.2 Perfmon 配置寄存器"></a>6.2 Perfmon 配置寄存器</h2><p>当支持 perfmon 时，有一组配置、状态和数据寄存器可供软件用来配置和控制 perfmon 硬件。这包括一组全局配置和状态寄存器，以及第 9.2.25 节中记录的每个计数器配置和数据寄存器。软件可以使用 PERFRST 中的“重置 Perfmon 配置”和“重置 Perfmon 计数器”控件将所有支持的计数器控制和数据寄存器的状态重置为默认初始值（请参阅第 9.2.25.4 节）。<br>这可以随时完成。重置 Perfmon 配置会导致所有计数器被禁用。</p>
<p>每组计数器配置和数据寄存器独立运行，软件必须先配置并启用计数器，然后该计数器才能开始计数事件。软件应在启用相应的计数器配置 (CNTRCFG) 寄存器之前对过滤器配置 (FLTCFG) 寄存器进行编程（请参阅第 6.4 节）。当 CNTRCFG 中的启用位被设置时，对 FLTCFG 或 CNTRCFG 的其他字段的写入将被忽略，事件监视将继续，就像没有发生写入一样。对计数器数据 (CNTRDATA) 寄存器的写入按第 6.3 节所述处理。</p>
<p>软件通过选择可用的计数器寄存器并在相应计数器配置寄存器 (CNTRCFG) 的事件字段中编程适当的事件类别值和要监控的事件集来配置事件计数。设备将事件字段中编程的位解释为与指定的事件类别相对应。因此，在任何时候，给定的计数器只能计数与单个事件类别相对应的事件。通过在事件字段中设置多个位，软件可以配置给定的计数器以计数属于同一事件类别的多个事件。在这种情况下，计数器值反映了所有指定事件发生次数的总和。如果某些事件需要独立（非加性）计数，则软件需要编程不同的计数器；每个要监控的事件一个。</p>
<p>类似地，为了计数对应于不同事件类别的事件，软件需要配置多个计数器；每个事件类别至少需要一个计数器，并具有相应的事件值。</p>
<h2 id="6-3-事件计数器"><a href="#6-3-事件计数器" class="headerlink" title="6.3 事件计数器"></a>6.3 事件计数器</h2><p>perfmon 架构支持最多 32 个事件计数器。给定实现中的计数器数量可能小于此数量。软件可以通过读取 PERFCAP 寄存器来发现给定实现中的计数器数量。每个计数器独立运行。</p>
<p>软件可以随时读取计数器数据寄存器 (CNTRDATA)。软件可以在启用计数器之前写入 CNTRDATA 寄存器。如果 PERFCAP 中的“启用时可写入的计数器”字段为 1，则在启用计数器时也允许写入 CNTRDATA 寄存器。软件写入计数器数据寄存器的一些用法包括：</p>
<ul>
<li>在计数器禁用时写入，以使用特定值初始化计数器。</li>
<li>在计数器溢出后写入，以重新初始化计数器。请注意，计数器可能已启用并且当前正在计数（未冻结）。</li>
<li>写入当前冻结的计数器以重新初始化它。</li>
</ul>
<p>通过读取功能 (PERFCAP) 寄存器可以发现计数器数据寄存器的支持宽度。虽然在给定的实现中，该宽度可能小于 64 位，但软件仍可以将完整的 64 位值写入寄存器，而不会触发错误。但是，硬件会忽略指定宽度以上的位。如果支持每个计数器的功能报告（如 PERFCAP 所示），则每个计数器的支持宽度是相应 CNTRCAP 寄存器中指定的值。<br>这允许实现支持不同宽度的计数器。</p>
<p>当在给定的计数器寄存器中启用多个事件时，如果多个事件同时发生，则计数器值在给定的周期内增加超过 1</p>
<h3 id="6-3-1-计数器溢出"><a href="#6-3-1-计数器溢出" class="headerlink" title="6.3.1 计数器溢出"></a>6.3.1 计数器溢出</h3><p>在启用计数事件时，如果事件发生导致计数器值递增并滚动到零或超过零，则称为计数器溢出。溢出时，溢出状态寄存器 (OVFSTATUS) 中的相应位将被设置。如果支持并启用，还可能会生成中断（详细信息如下）。通常，计数器会继续计数事件，不会在溢出时停止计数。如果支持，软件可以在计数器配置寄存器中指定全局溢出冻结位。如果为计数器设置了此位，则该计数器的溢出会导致所有计数器的冻结位在 PERFFRZ 中设置。这会强制所有计数器停止计数（冻结）并保留其当前计数值（直到软件明确写入或重置）。计数器的当前冻结状态在 PERFFRZ 中报告。</p>
<p>如上所述，由于计数器数据寄存器可能是软件可写的，因此软件可以将数据寄存器视为受支持宽度的有符号整数。为了在事件首次发生时导致溢出，软件可以在启用事件计数之前写入初始计数值 -1（例如，对于 32 位计数器，为 0xFFFFFFFF）。这会导致在启用计数器后，指定事件的首次发生导致计数器值溢出并触发中断（如果已启用）。</p>
<h3 id="6-3-2-计数器停止和恢复"><a href="#6-3-2-计数器停止和恢复" class="headerlink" title="6.3.2 计数器停止和恢复"></a>6.3.2 计数器停止和恢复</h3><p>软件可以通过将 1 写入 PERFFRZ 寄存器中的相应位来停止已启用并正在计数事件的计数器。这称为该计数器的冻结操作，可使其停止计数进一步的事件。同样，可以通过将 0 写入 PERFFRZ 中的相应位来恢复之前冻结的计数器。这称为计数器的解冻操作，可使其恢复对已配置事件的计数。解冻后，计数器将继续递增，从解冻操作时的当前计数器值开始。</p>
<p>计数器的当前冻结&#x2F;解冻状态在 PERFFRZ 寄存器中报告。这些位可由软件读取和写入。此外，当任何设置了全局溢出冻结位的计数器发生溢出时，硬件会设置所有计数器的冻结位。</p>
<h2 id="6-4-过滤器支持"><a href="#6-4-过滤器支持" class="headerlink" title="6.4 过滤器支持"></a>6.4 过滤器支持</h2><p>perfmon 架构允许软件指定一组过滤器，这些过滤器可用于根据过滤器配置寄存器中指定的一个或多个条件来限制所选事件的计数。<br>如果受支持，则每个 perfmon 计数器都有一组架构定义的过滤器（如表 6-2 中所述）和一组相应的过滤器配置寄存器（每个过滤器一个）。软件可以通过查询 perfmon 功能寄存器 (PERFCAP) 来发现对过滤功能的支持。</p>
<p>每个事件可能仅支持过滤器类型的子集，或者根本不支持过滤器。有关每个事件允许使用哪些过滤器的信息，请参阅附录 D。软件可以通过在相应的过滤器配置寄存器 (FLTCFG) 中编程该计数器的过滤器值来指定一个或多个要应用于给定计数器监视的事件的过滤器。过滤器的一个示例用途可能是将计数器配置为仅计数特定事件，例如，仅从特定 WQ（过滤器）中计算排水描述符的数量（通过 Event_Category 和 Events 字段指定）。</p>
<p>软件可以为给定计数器指定多个过滤器。当为计数器配置了多个过滤器时，只有满足所有指定过滤器（即所有过滤条件的逻辑与）的事件才会被计数。请参阅 D.3 节中的示例。</p>
<h2 id="6-5-事件编程注意事项"><a href="#6-5-事件编程注意事项" class="headerlink" title="6.5 事件编程注意事项"></a>6.5 事件编程注意事项</h2><p>如第 6.2 节所述，通过在相应 CNTRCFG 寄存器的事件字段中设置多个位，软件可以配置事件计数器以计数属于同一事件类别的多个事件。为了获得有意义的事件计数，软件应确保当计数器要监视多个事件时，这些事件在某种程度上是相关的。例如，将计数器配置为同时计数循环数和操作数可能并不可取。同样，事件类别中的所有事件可能不支持同一组过滤器。软件应确保指定的过滤器值与为该计数器配置的事件集兼容。不这样做可能会产生不良的事件计数器值。硬件在编程性能监视寄存器时不执行错误检查，软件有责任确保有意义的配置。</p>
<h2 id="6-6-中断产生"><a href="#6-6-中断产生" class="headerlink" title="6.6 中断产生"></a>6.6 中断产生</h2><p>如果 PERFCAP 中的溢出中断支持字段为 1，则实现支持在计数器溢出时生成 MSI-X 中断（使用 MSI-X 表的条目 0）。软件可以使用此功能在计数器溢出时收到通知。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240914104553708.png" class="" title="image-20240914104553708">

<p>此外，INTCAUSE 寄存器指示 perfmon 计数器溢出导致生成中断。收到中断后，软件可以读取全局状态寄存器 (OVFSTATUS) 以识别哪些计数器溢出。此寄存器中可以设置多个位（表示多个计数器溢出）。如果计数器启用了溢出全局冻结，软件可以检查 PERFFRZ 中所有计数器的当前冻结状态，并从 CNTRDATA 寄存器读取相应的计数器值。</p>
<h1 id="7-参考软件架构"><a href="#7-参考软件架构" class="headerlink" title="7 参考软件架构"></a>7 参考软件架构</h1><p>对英特尔 DSA 的软件支持预计包括以下内容：</p>
<ul>
<li>• 内核模式驱动程序。</li>
<li>• 用户模式驱动程序。</li>
<li>• 虚拟化支持</li>
</ul>
<h2 id="7-1-内核模式驱动"><a href="#7-1-内核模式驱动" class="headerlink" title="7.1 内核模式驱动"></a>7.1 内核模式驱动</h2><p>Intel DSA 内核模式驱动程序 (KMD) 负责初始化和管理设备。它可以插入内核 DMA 子系统，并使用内部操作系统特定的 DMA API 为任何客户端提供服务。它还向用户空间公开一个接口，以支持 SVM 服务的直接用户级访问。KMD 请求操作系统根据用户级请求分配&#x2F;绑定&#x2F;解除绑定&#x2F;释放 PASID。它将有限的门户映射到客户端，以允许它们直接访问以提交工作</p>
<p>对于共享 WQ，KMD 设置 WQ 阈值来控制有限门户可用的 WQ 容量。剩余的 WQ 容量保留用于向无限门户提交工作。<br>KMD 可以随时更改阈值。阈值可以设置为 WQ 大小以不保留任何空间，也可以设置为 0 以防止向有限门户提交任何工作。当有限门户返回重试时，客户端可以请求 KMD 代表其向无限门户提交工作。如果无限门户也返回重试，KMD 可能会重新尝试提交或采取以下步骤：</p>
<ol>
<li>降低阈值，防止直接提交工作。</li>
<li>启用 WQ Occupancy 中断，当 WQ 中有空间时接收通知。</li>
<li>当通知到达时，提交已排队的工作。</li>
<li>恢复阈值。</li>
</ol>
<p>在执行这些步骤时，如果客户端依赖于按顺序执行描述符，则 KMD 可能需要注意将描述符按照客户端尝试的顺序提交给设备。<br>（有关描述符排序的信息，请参阅第 3.9 节。）</p>
<h2 id="7-2-用户态驱动"><a href="#7-2-用户态驱动" class="headerlink" title="7.2 用户态驱动"></a>7.2 用户态驱动</h2><p>Intel DSA 用户模式驱动程序 (UMD) 是一个可选组件，用于提供对设备的用户模式访问。UMD 用于使应用程序可以使用 Intel DSA 功能。它以库的形式与应用程序链接，并与内核模式驱动程序交互，代表应用程序请求对设备的访问。它通过在更高级别的 API 中抽象各种设备功能，向应用程序公开这些功能。它通常使用 ENQCMD 向有限的门户提供应用程序请求服务。如果 ENQCMD 因拥塞而失败，UMD 可能会退出并重试工作提交或使用内核模式驱动程序服务代理请求以确保向前推进。此外，UMD 可以使用 MOVDIR64B 向专用工作队列门户提供应用程序请求服务。</p>
<h2 id="7-3-处理非阻塞页面错误的软件要求"><a href="#7-3-处理非阻塞页面错误的软件要求" class="headerlink" title="7.3 处理非阻塞页面错误的软件要求"></a>7.3 处理非阻塞页面错误的软件要求</h2><p>在 PRS 禁用时，Intel DSA 会通过停止操作并在完成记录中报告部分完成状态来处理页面错误（如第 3.13 节所述）。此外，在启用事件日志时，完成记录地址上的页面错误会通过事件日志报告。KMD 负责配置和启用事件日志。它必须确保事件日志足够大，并且必须及时处理条目，以避免由于日志已满而导致设备后续事件日志写入被阻止</p>
<ol>
<li>如果批次中的第一个错误标志为 1，则丢弃与批次标识符相关的任何先前记录的错误。当批次完成由于中止命令或内部硬件错误而丢失时，可能会发生这种情况。通常情况下，不会记录任何错误，也不需要采取任何措施。</li>
<li>尝试修复与事件日志条目中报告的故障地址和 PASID 相对应的页面错误，如果成功，则将完成记录写入故障地址并生成完成中断（如果事件日志条目中的完成中断必需字段为 1）。</li>
<li>如果写入完成记录时出现错误，并且完成记录是针对批次中的描述符，则 KMD 会将错误与事件日志条目的批次标识符相关联并跟踪它，直到观察到相应批次描述符的事件日志条目。KMD 不需要跟踪成功写入的完成记录。</li>
</ol>
<p>当处理批次描述符的事件日志条目时，如果错误代码表明批次中的一个或多个描述符具有事件日志条目，并且事件日志条目中的“需要完成记录”字段为 1，则在将批次完成记录写入内存之前，KMD 会执行以下操作：</p>
<ol>
<li>如果事件日志条目中的完成记录的 Status 字段为 0x01，KMD 会将其更改为 0x05，并将 Result 字段更改为 1。</li>
<li>如果 Status 为 0x06，则将 Result 更改为 1。</li>
<li>如果 Status 为任何其他值，则不应更改完成记录。</li>
<li>然后，KMD 应清除记录的错误，为具有相同批次标识符的下一个批次做准备。</li>
</ol>
<p>如果此批次未记录任何错误（所有完成记录均已成功写入），KMD 将按原样写入批次完成记录。如果事件日志条目中的“需要完成中断”字段为 1，则软件应生成完成中断。</p>
<p>当应用程序或 UMD 收到指示部分完成的完成记录时，它可以选择修复页面错误并向设备重新提交描述符以完成操作的剩余部分。在大多数情况下，可能需要更新原始描述符以根据已完成的工作量调整传输大小字段。对于某些操作，可能需要对原始描述符进行额外更新。如果 GENCAP 中的批处理继续支持为 1，则在重新提交提前终止的批处理描述符时（如第 8.3.2 节所述），软件可以根据完成记录中的结果字段设置描述符中的批处理错误标志，以确保批处理的最终完成记录中的状态和结果字段反映批处理中所有描述符的正确状态。</p>
<h2 id="7-4-跨域作战的软件要求"><a href="#7-4-跨域作战的软件要求" class="headerlink" title="7.4 跨域作战的软件要求"></a>7.4 跨域作战的软件要求</h2><p>如第 3.13.3 节所述，每个域间或更新窗口操作至少指定一个 IDPT 句柄，该句柄引用该设备上域间权限表中的条目。IDPT 控制不同地址空间 (PASID) 之间的连接和通信。使用域间或更新窗口操作时的一些关键软件注意事项如下：</p>
<ul>
<li>• 特权软件（例如 KMD）负责发现和枚举域间功能，以及配置每个设备中的 IDPT。</li>
<li>• 为了使域间或更新窗口操作成功，必须在将描述符提交给设备之前设置 IDPTE。</li>
<li>• IDPT 特定于设备；因此，要使用给定的 IDPTE，所有者和提交者进程（如第 3.13.3 节所述）必须订阅同一物理设备。</li>
<li>• 所有者和提交者可以在设备上使用相同的 SWQ 或不同的 SWQ&#x2F;DWQ。如果所有者不需要使用更新窗口操作，则所有者无需访问设备上的 WQ。</li>
<li>• 对于类型 0 SASS 和类型 1 SAMS IDPTE：<ul>
<li>o 所有者通常通过系统调用接口（例如 ioctl）请求 KMD 设置适当类型的 IDPTE，并附带必要的窗口参数。</li>
<li>o 所有者有责任将代表 IDPTE、IDPT 句柄和窗口参数的系统文件句柄传达给提交者。用于交换此信息的具体机制取决于软件实现。</li>
<li>o 软件实现可能要求每个提交者在域间描述符中首次使用 IDPT 句柄之前，使用系统调用接口（例如 ioctl）向 KMD 明确注册自己。后续在域间描述符中使用 IDPT 句柄可以不涉及 KMD。</li>
<li>o 如果 IDPTE 中的“允许更新”字段为 1，所有者可以发出更新窗口描述符来修改 IDPTE 的窗口属性。软件有责任协调对 IDPTE 窗口属性的更改以及提交者对窗口的任何并发访问。</li>
</ul>
</li>
</ul>
<p>图 7-1 显示了所有者、提交者、KMD 和硬件之间的通信示例软件序列。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726708411986.png" class="" title="QQ_1726708411986">



<h2 id="7-5-虚拟化软件"><a href="#7-5-虚拟化软件" class="headerlink" title="7.5 虚拟化软件"></a>7.5 虚拟化软件</h2><p>Intel DSA 使用 Intel 可扩展 IOV 模型进行虚拟化，该模型在 Intel® 可扩展 I&#x2F;O 虚拟化架构规范中进行了描述。虚拟化软件架构如图 7-2 所示。设备虚拟化由名为 Intel DSA 虚拟设备组合模块 (VDCM) 的软件组件支持，该模块组成虚拟 Intel DSA 设备并将其公开给客户机。VDCM 是 VMM 特定模块，负责与 VMM 通信以促进设备虚拟化。根据主机系统软件架构，VDCM 可以开发为用户级模块、内核模式驱动程序的一部分、单独的内核模块或 VMM 的一部分。</p>
<p>主机操作系统中的 KMD 经过扩展，以支持虚拟化所需的 VDCM 操作。具有虚拟化扩展的 KMD 称为主机驱动程序。客户操作系统中的 KMD 可以像在非虚拟化环境中一样运行，也可以优化为在 VM 中运行。客户操作系统中的 KMD 称为客户驱动程序。主机驱动程序控制和管理物理设备，并允许多个客户驱动程序共享设备。可以为每个操作系统开发一个英特尔 DSA 驱动程序，以在非虚拟化操作系统、主机操作系统和客户操作系统中运行。</p>
<h3 id="7-5-1-虚拟英特尔®-DSA-设备"><a href="#7-5-1-虚拟英特尔®-DSA-设备" class="headerlink" title="7.5.1 虚拟英特尔® DSA 设备"></a>7.5.1 虚拟英特尔® DSA 设备</h3><p>VDCM 实现的虚拟设备称为 VDEV，它模拟与物理 Intel DSA 设备相同的接口，因此相同的设备驱动程序可以在主机操作系统和客户机操作系统中运行。客户机驱动程序使用与物理设备相同的软件接口通过 MMIO 寄存器访问虚拟设备。VDCM 模拟虚拟设备的行为并通过主机驱动程序调解设备的客户机订阅。来自虚拟机的 VDEV 上的控制路径操作（例如专用 WQ 配置）被 VMM 捕获并由 VDCM 模拟，但快速路径操作（描述符提交和描述符完成）直接映射到虚拟机。</p>
<p>在客户机中，设备的某些功能可能不受支持。功能寄存器向客户机指示哪些功能可用。例如，虚拟设备中可用的工作队列或组的数量可能与物理设备中可用的数量不同。可能不支持的功能的另一个示例是中断消息存储。</p>
<p>GENCAP 中的配置支持功能表明，组和 WQ 配置的某些方面不能由客户机修改。例如，每个 WQ 的大小必须在启动设备之前由主机驱动程序配置，并且不能由 WQ 随后分配给的客户机更改。为了表明这一点，VDCM 应始终在 VDEV 的 GENCAP 寄存器中的配置支持字段中返回值 0。</p>
<p>如果将 WQ 分配给多个客户机，则主机驱动程序会将其配置为共享 WQ。客户机驱动程序无法更改此类 WQ 的任何 WQ 配置寄存器。WQCFG 寄存器的 WQ Mode Support 字段中的值 0 会向客户机表明这一点。</p>
<p>如果将 WQ 分配给单个客户机，则客户机驱动程序可以决定它是专用 WQ 还是共享 WQ。在这种情况下，客户机驱动程序还可以配置 WQ 阈值、Priv、PASID 启用和 PASID。这通过 WQCFG 寄存器的 WQ 模式支持字段中的值 1 向客户机指示。<br>有关 WQ 配置支持的详细信息，请参阅表 9-7。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726708506596.png" class="" title="QQ_1726708506596">

<h3 id="7-5-2-门户虚拟化"><a href="#7-5-2-门户虚拟化" class="headerlink" title="7.5.2 门户虚拟化"></a>7.5.2 门户虚拟化</h3><p>对于 VDEV 中包含的每个 WQ，VDCM 直接将 WQ 的一些物理门户映射到 VM 中。<br>对于由多个客户共享的 WQ，主机驱动程序保留对无限门户的控制，而 VDCM 仅将有限门户映射到客户。当客户使用其无限门户地址提交描述符时（在客户的有限门户返回重试之后），VMM 会捕获门户写入，而主机驱动程序会使用物理无限门户提交描述符以向客户提供前进进度。<br>如果物理无限门户也返回重试，则主机驱动程序可以使用第 7.1 节中描述的相同方法。<br>对于分配给单个客户的 WQ，VDCM 应该同时映射有限门户和无限门户。</p>
<p>这样，如果客户机驱动程序选择将 WQ 配置为共享 WQ，它可以设置 WQ 阈值并通过将有限门户直接映射到其用户模式客户端并使用无限制门户进行内核模式操作来管理 WQ 本身的前向进度保证。</p>
<p>图 7-2 显示 VDCM 已为客户机 1 创建了 VDEV1，其中包含一个共享 WQ (SWQ)，并为客户机 2 创建了 VDEV2，其中包含一个 SWQ 和一个专用 WQ (DWQ)。客户机 1 和客户机 2 在设备中共享相同的 SWQ。DWQ 只能分配给一个 VM。相应的 SWQ 和 DWQ 门户直接映射到各自的 VM 中以进行快速路径操作。对于 SWQ，相同的有限门户映射到两个 VM 中。</p>
<p>VDCM 仅将 IMS 门户映射到客户机。MSI-X 门户保留供主机使用。如果客户可见的虚拟设备未报告对 IMS 的支持，则 IMS 门户将映射到客户的虚拟 BAR2 中以代替 MSI-X 门户，并且虚拟门户（第 9.2.21 节中描述）可以映射到与客户的虚拟 IMS 门户相对应的地址范围中。有关中断虚拟化的描述，请参阅第 7.5.4 节。</p>
<h3 id="7-5-3-SVM-和-PASID-虚拟化"><a href="#7-5-3-SVM-和-PASID-虚拟化" class="headerlink" title="7.5.3 SVM 和 PASID 虚拟化"></a>7.5.3 SVM 和 PASID 虚拟化</h3><p>当虚拟英特尔 DSA 设备分配给虚拟机时，虚拟机使用的所有 WQ 都必须配置为使用 PASID。VMM 为虚拟机分配默认主机 PASID，并在 IOMMU 中为该 PASID 配置 PASID 表条目，以进行二级地址转换 (GPA → HPA)。当客户机在专用模式下配置虚拟 WQ 并禁用 PASID 时，将使用此 PASID。为了让客户机以这种方式使用虚拟设备，VDEV 不需要支持 PASID、ATS 和 PRS PCIe 功能（即使这些功能在物理英特尔 DSA 设备中已启用）。</p>
<p>为了在客户机中支持 SVM，VDEV 包括对 ATS、PASID 和 PRS 功能的支持，并且 VMM 向客户机公开虚拟 IOMMU。客户机操作系统在虚拟 IOMMU 的 PASID 表中设置 PASID 表条目。由于客户机软件使用客户机 PASID，而物理设备使用主机 PASID，因此 VMM 必须管理客户机 PASID 到主机 PASID 的映射。</p>
<p>一些 VMM 可能会选择使用半虚拟化或启发式虚拟 IOMMU，其中客户机不生成自己的客户机 PASID，而是从虚拟 IOMMU 请求客户机 PASID。在这种情况下，VMM 可能会对每个请求的客户机 PASID 使用与主机 PASID 相同的客户机 PASID 值，从而简化 VMM 中的 PASID 管理。否则，客户机操作系统会为其 SVM 操作分配自己的客户机 PASID，而 VMM 必须为每个客户机 PASID 分配一个主机 PASID。</p>
<p>设置客户机 PASID 到主机 PASID 映射的方法取决于 WQ 是处于专用模式还是共享模式。如果将 WQ 分配给单个 VM，则客户机驱动程序可以决定是将其配置为 DWQ 还是 SWQ，以便在 VM 内的多个应用程序之间共享。如果将 WQ 分配给多个 VM，则主机驱动程序会将其配置为 SWQ，客户机无法更改 WQ 模式。</p>
<p>当客户驱动程序在专用模式下启用 WQ 且 VDEV 中的 WQ PASID Enable 字段等于 1 时，VMM 会在 WQ PASID 字段中为客户 PASID 创建映射。如果 WQ PASID Enable 字段为 0，VMM 会使用虚拟机的默认主机 PASID。无论哪种情况，主机驱动程序都会将正确的主机 PASID 写入物理 WQCFG 寄存器的 WQ PASID 字段，并将 1 写入 WQ PASID Enable 字段。</p>
<p>如果主机驱动程序或客户机驱动程序将 WQ 配置为共享模式，则 VMM 会在 VMCS（VM 控制结构）中启用 PASID 转换 VMX 执行控制。客户机使用 ENQCMD 或 ENQCMDS 指令提交描述符。第一次提交客户机 PASID 时，ENQCMD&#x2F;S 会导致 VM 退出，因为 PASID 转换表没有客户机 PASID 的映射，而 VMM 会为其创建映射。</p>
<p>要为客户 PASID 创建映射，VMM 会查看虚拟 IOMMU 的 PASID 表中客户 PASID 的 PASID 表条目。如果客户 PASID 在虚拟 IOMMU 中配置为第一级转换，VMM 会分配一个新的主机 PASID，配置其 PASID 表条目以进行嵌套的第一级（GVA 到 GPA）和第二级（GPA 到 HPA）转换，并设置 VMCS PASID 转换表以将客户 PASID 映射到主机 PASID。如果虚拟 IOMMU 中未配置客户 PASID，VMM 会设置 VMCS PASID 转换表以将客户 PASID 映射到虚拟机的默认主机 PASID（该主机 PASID 已在物理 IOMMU 中配置）。</p>
<h3 id="7-5-4-中断虚拟化"><a href="#7-5-4-中断虚拟化" class="headerlink" title="7.5.4 中断虚拟化"></a>7.5.4 中断虚拟化</h3><p>VDCM 通过在 VDEV 中公开虚拟 MSI-X 功能来虚拟化中断。VDEV 中的可扩展 IOV 功能中的中断消息存储支持字段可能为 0。VDCM 请求主机驱动程序在中断消息存储中为 VM 可用的每个中断分配一个条目。VDCM 将每个 WQ 的受限 IMS 门户映射到 VM 中，偏移量为无限 MSI-X 门户和有限 MSI-X 门户。当客户机使用其 MSI-X 门户地址提交描述符时，它实际上是在使用物理 IMS 门户，因此客户机中断始终使用 IMS 生成。</p>
<p>当客户机操作系统配置虚拟 MSI-X 条目时，VDCM 或主机驱动程序请求主机操作系统或 VMM 分配物理中断，并使用来自虚拟 MSI-X 表条目的向量和 VCPU 信息将其编程到 IOMMU 的中断发布结构中。 Host OS 或 VMM 将物理中断地址和数据值传递给主机驱动程序，主机驱动程序负责将物理中断配置到分配的中断消息存储条目中，包括将 IMS PASID 字段设置为客户机的 PASID。</p>
<p>VDEV 中的命令功能寄存器指示支持请求中断句柄命令，要求客户机使用请求中断句柄命令获取与每个 MSI-X 表条目关联的中断句柄。VDCM 使用 IMS 中与虚拟 MSI-X 表条目对应的索引来响应该命令。客户机将中断句柄放在请求中断的每个描述符中。物理设备使用该句柄来识别要用于生成完成中断的中断消息存储条目。它根据 IMS 条目中的 PASID 字段检查描述符的 PASID。如果客户机使用尚未分配给它的中断句柄请求中断，则 PASID 将不匹配，因此不会生成中断。</p>
<p>迁移虚拟机或恢复已挂起的虚拟机时，分配给虚拟机的中断句柄可能不再可用。为了通知客户机一个或多个中断句柄已被撤销，VDCM 会设置虚拟 INTCAUSE 寄存器中的“中断句柄已撤销”位，并使用 VDEV 中的 MSI-X 条目 0 向客户机生成中断。客户机清除“中断句柄已撤销”位，然后使用“请求中断句柄”命令获取正在使用的任何 MSI-X 和&#x2F;或 IMS 条目的新句柄。确保所有线程都已停止使用已撤销的句柄后，客户机使用每个新的中断句柄提交一个 Drain 描述符。Drain 等待使用已撤销的句柄提交的任何描述符完成；这些描述符以操作状态 0x19（无效中断句柄）完成。完成 Drain 描述符后，Intel DSA 硬件会为这些描述符生成预期的完成中断，以便软件识别完成记录中的错误，并使用新句柄重新提交描述符。请参阅图 7-2 了解客户机中要执行的步骤的伪代码。</p>
<p>当客户机写入虚拟 MSI-X 表的忽略或掩码位时，VDCM 会写入相应的 IMS 表条目。当客户机读取虚拟 MSI-X 待处理位数组时，VDCM 会根据分配给该客户的 IMS 表条目的待处理位的值构建值。</p>
<p>VDCM 应提供一个额外的 MSI-X 表条目，用于错误和命令完成。VDCM 本身负责使用虚拟 MSI-X 表条目中的向量和 VCPU 信息为这些事件生成虚拟中断。</p>
<p>如果 VDEV 中的中断消息存储支持功能为 1，则 IMS 的虚拟化方式与 MSI-X 非常相似。</p>
<p>当某个客户被销毁时，在其 PASID 耗尽后，应清除分配给该客户的所有 IMS 条目中的 PASID 启用字段，以确保在重新分配 PASID 时这些条目不会被其他客户不当使用。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726708769213.png" class="" title="QQ_1726708769213">

<h3 id="7-5-5-Capability-虚拟化"><a href="#7-5-5-Capability-虚拟化" class="headerlink" title="7.5.5 Capability 虚拟化"></a>7.5.5 Capability 虚拟化</h3><p>英特尔 DSA 通过功能寄存器向软件公开其功能，如第 9.2 节所述。这使 VDCM 能够通过虚拟设备的功能寄存器向 VM 公开设备功能的子集，从而使虚拟设备能够与多代设备兼容。此功能虚拟化使带有客户机驱动程序的 VM 映像能够在包含不同代英特尔 DSA 设备的物理机上启动或迁移。这允许在数据中心中创建兼容物理机池，其中可以启动或迁移相同的 VM 映像。</p>
<h3 id="7-5-6-域间特征虚拟化"><a href="#7-5-6-域间特征虚拟化" class="headerlink" title="7.5.6 域间特征虚拟化"></a>7.5.6 域间特征虚拟化</h3><p>如果未为客户机启用 PASID 功能，则 VDCM 不会向该客户机公开域间功能。如果为客户机启用了 PASID 功能，则 VDCM 通过在 VDEV 中公开虚拟 IDPT 功能来虚拟化域间操作。VM 在虚拟 IDPT 中分配条目，并使用 MMIO 写入相应的虚拟 IDPTE 来配置它们。VDCM 将虚拟 IDPTE 中的客户机 PASID 值转换为相应的主机 PASID 值，并请求主机驱动程序为 VM 分配的每个虚拟 IDPTE 分配一个物理 IDPTE。VDEV 的 CMDCAP 中的请求 IDPT 句柄字段为 1，表示客户机必须使用请求 IDPT 句柄命令来获取与 VDEV 中每个 IDPTE 关联的 IDPT 句柄。VDCM 使用与虚拟 IDPTE 对应的物理 IDPTE 的索引来响应该命令。当客户机提交带有 IDPT 句柄的描述符时，它实际上是在使用包含与该客户机关联的主机 PASID 值的物理 IDPTE。客户机 KMD 可以维护句柄与虚拟 IDPTE 的关联。</p>
<p>迁移 VM 或恢复已暂停的 VM 时，分配给 VM 的 IDPT 句柄可能不再可用。VM 提交的域间或更新窗口描述符引用了不可用的 IDPT 句柄，并返回错误代码，如第 5.8.1 节所述。收到包含无效 IDPT 句柄错误的完成时，VM 中的应用程序使用适当的系统调用接口（例如 ioctl）从客户 KMD 请求新的 IDPT 句柄。客户 KMD 使用请求 IDPT 句柄命令获取如上所述的新 IDPT 句柄。VDCM 在物理 IDPT 中分配新条目，并根据相应虚拟 IDPTE 中的值适当地初始化该条目。VDCM 使用物理 IDPTE 的索引作为要使用的新句柄来响应该命令。客户 KMD 将新句柄提供给应用程序，并可以将新句柄记录为与虚拟 IDPTE 关联的句柄。</p>
<p>VDCM 可以使用只读映射将虚拟 IDPT 对应的内存区域映射到 VM 中。当客户机写入虚拟 IDPTE 时，VDCM 会将虚拟 IDPT 在 DRAM 支持区域中的相应位置写入，并请求主机驱动程序将相应值写入物理 IDPTE。当客户机读取虚拟 IDPTE 时，它会直接从 DRAM 区域读取值，而无需 VM 退出。</p>
<p>如果 VDCM 向客户机公开类型 1 SAMS IDPTE，则它必须虚拟化与该 IDPTE 关联的提交者位图。VM 为虚拟位图分配内存，并使用位图地址配置虚拟 IDPTE。VDCM 为相应的物理位图分配内存并更新物理 IDPTE。客户机无需退出 VM 即可读取或写入虚拟位图区域。VDEV 中的 Invalidate Submitter Bitmap Cache 功能为 1，表示客户机必须在对位图进行任何更改后使用 Invalidate Submitter Bitmap Cache 命令，以确保 VDEV 使用更新的值。当 VM 发出 Invalidate Submitter Bitmap Cache 命令并指定已更新的位图部分时，VDCM 会更新物理位图中的相应位。如果客户机未能发出“无效提交者位图缓存”命令，则 VDCM 不会更新物理位图，并且引用该 IDPTE 的任何后续描述符都可能无法按预期完成。</p>
<p>当客户机被销毁时，在其 PASID 耗尽后，分配给该虚拟机的任何 IDPTE 都必须标记为不可用，以确保在重新分配 PASID 时这些条目不会被其他客户机不当使用。</p>
<h3 id="7-5-7-VM迁移过程中的状态迁移"><a href="#7-5-7-VM迁移过程中的状态迁移" class="headerlink" title="7.5.7 VM迁移过程中的状态迁移"></a>7.5.7 VM迁移过程中的状态迁移</h3><p>Intel DSA 虚拟化支持虚拟机的实时迁移。在实时虚拟机迁移的最后阶段，VMM 会暂停虚拟机，然后向虚拟机的所有虚拟设备发出暂停命令，并等待暂停完成。然后，VMM 会保存虚拟设备状态，将其与虚拟机的其余状态一起迁移，并在目标计算机上恢复虚拟设备状态。</p>
<p>要暂停虚拟 Intel DSA 设备，VDCM 会请求主机驱动程序耗尽分配给虚拟机的所有主机 PASID。主机驱动程序会为每个分配的 PASID 发出 Drain PASID 命令，或者如果为虚拟机分配了大量 PASID，则可能会发出 Drain All。完成 Drain 命令后，虚拟设备将进入暂停状态。如果 IOMMU 的中断发布结构中有虚拟机的待处理中断，则这些中断将被传送到虚拟 APIC。虚拟设备状态将与虚拟机的其余状态一起传输到目标计算机。</p>
<p>在目标计算机上，VMM 为 VM 创建新的虚拟 Intel DSA 设备，并将虚拟设备状态恢复到该设备。具体来说，它为虚拟 MSI-X 表中配置的中断配置 IMS 条目，根据虚拟设备配置将物理 WQ 分配给 VM，并设置物理 IOMMU 以进行 DMA 重新映射和中断重新映射&#x2F;发布。对于专用 WQ，目标 DWQ 的大小必须与原始 DWQ 相同或更大，因为客户驱动程序可能会继续使用旧的 DWQ 大小。第 3.16 节中描述的功能虚拟化可确保虚拟设备可以在多代 Intel DSA 设备上工作。</p>
<p>有关 VM 迁移后中断句柄撤销的描述，请参阅第 7.5.4 节。有关 VM 迁移后 IDPT 句柄撤销的描述，请参阅第 7.5.6 节。</p>
<h3 id="7-5-8-事件日志虚拟化"><a href="#7-5-8-事件日志虚拟化" class="headerlink" title="7.5.8 事件日志虚拟化"></a>7.5.8 事件日志虚拟化</h3><p>无论硬件中是否启用了事件日志，事件日志功能都可以向客户机公开。当事件日志功能向客户机公开时，客户机可能会启用或不启用该功能。<br>如果客户机未启用事件日志，则 VDCM 必须使用虚拟 SWERROR 向客户机报告错误。<br>如果有多个错误要注入客户机，则 VDCM 可以设置虚拟 SWERROR 寄存器中的溢出字段，或者可以一次向客户机报告一个错误，等待客户机清除虚拟 SWERROR 中的每个错误，然后 VDCM 报告下一个错误。</p>
<p>如果客户机启用了事件日志，则 VDCM 必须使用它向客户机报告错误，而不是使用 SWERROR。本节的其余部分介绍了主机和客户机都启用事件日志的情况。</p>
<p>当客户机在虚拟英特尔 DSA 设备中启用事件日志时，它会在其自己的内存中为其事件日志分配空间，并将基地址和大小写入虚拟英特尔 DSA 设备中的 EVLCFG 字段。</p>
<p>当主机驱动程序处理事件日志时，它会确定每个事件日志条目是否特定于某个客户机。VDCM 将主机事件日志条目中的 PASID、WQ 索引和门户标识符转换为客户机值，将修改后的事件日志条目写入客户机内存中的客户机事件日志，更新虚拟 EVLSTATUS 寄存器中的事件日志尾字段，然后在需要时向客户机生成中断。如果主机事件日志处理是在单独的线程上执行的，则不需要客户机退出 VM。</p>
<p>当客户机收到事件日志中断时，它会从自己的内存中读取事件日志条目。无需 VM 退出即可读取事件日志，但可能需要 VM 退出才能读取事件日志尾部、写入事件日志头并清除虚拟 EVLSTATUS 寄存器中的中断待处理。</p>
<p>在将事件日志条目写入客户机内存时，VDCM 使用虚拟 EVLCFG 寄存器中的字段和客户机虚拟 IOMMU 中配置的转换表执行地址转换。</p>
<ul>
<li>• 如果客户机中没有虚拟 IOMMU 或者已禁用，则虚拟 EVLCFG 寄存器中的事件日志基地址是客户机物理地址。虚拟 EVLCFG 中的 PASID Enable、PASID 和 Priv 字段将被忽略。</li>
<li>• 如果虚拟 IOMMU 处于传统模式，则虚拟 EVLCFG 中的客户机 PASID Enable 必须为 0。</li>
<li>否则，写入客户机事件日志会导致虚拟 IOMMU 出现故障。（有关报告的错误代码的详细信息，请参阅英特尔定向 I&#x2F;O 虚拟化技术规范。）</li>
<li>• 如果虚拟 IOMMU 处于可扩展模式，<ul>
<li>o 如果客户机 PASID Enable 为 0，则使用虚拟 IOMMU 上下文条目中的 RID_PASID 执行转换。</li>
<li>o 如果客户机 PASID Enable 为 1，则使用虚拟 EVLCFG 寄存器中的 PASID 和 Priv 字段执行转换。</li>
</ul>
</li>
</ul>
<h4 id="处理访客事件日志已满的情况"><a href="#处理访客事件日志已满的情况" class="headerlink" title="处理访客事件日志已满的情况"></a>处理访客事件日志已满的情况</h4><p>如第 5.9 节所述，当物理硬件需要写入事件日志且事件日志已满时，硬件会等待软件写入事件日志头以腾出事件日志中的空间。<br>这会延迟导致写入事件日志的任何描述符的完成，也可能延迟后续描述符的执行。 </p>
<p>如第 9.2.2 节所述，GENCAP 中的事件日志溢出支持字段指示设备是否在事件日志已满时丢弃新事件，或者是否阻塞直到软件更新事件日志头。</p>
<p>VDCM 可能会将虚拟 GENCAP 寄存器中的事件日志溢出支持字段报告为 0，并模仿物理硬件的阻塞行为。在这种情况下，为了避免影响设备的其他用途，即使客户机的事件日志已满，主机驱动程序也应继续处理物理事件日志。当主机驱动程序处理物理事件日志并将条目转发到相应的客户机事件日志中时，如果客户机事件日志已满，VDCM 会将该客户机的事件日志条目存储在与客户机关联的内部 VDCM 事件队列中。当客户机通过移动头部释放事件日志中的条目时，VDCM 会将事件日志条目从 VDCM 事件队列传输到客户机事件日志中。</p>
<p>或者，VDCM 可以配置虚拟硬件以将虚拟 GENCAP 寄存器中的事件日志溢出支持报告为 1。在这种情况下，如果虚拟事件日志已满，则 VDCM 可以丢弃与该虚拟事件日志有关的事件，并在虚拟 SWERROR 寄存器中记录指示事件日志已满情况的错误。</p>
<p>如果在 SWERROR 中记录了事件日志已满错误，或者如果 SWERROR 在事件日志已满时报告溢出，则客户机软件必须假设一个或多个事件可能已被丢弃，并采取适当措施通知和&#x2F;或根据需要终止任何受影响的应用程序。VDCM 还可以选择为每个客户机实现固定大小的 VDCM 事件队列，以便在虚拟事件日志已满时记录事件，并且仅在相应的事件队列已满时才开始丢弃客户机的事件。</p>
<p>如果 VDCM 事件队列具有固定大小，则 VDCM 可以通过将队列大小设置为以下总和来适当调整其大小，以减少溢出情况（基于正在运行的描述符，没有提交额外的描述符）：</p>
<ul>
<li>• WQ 数量 × WQ 大小 × (最大批次大小 + 1)。</li>
<li>• 引擎数量 × 正在进行的最大批次描述符 × (最大批次大小 + 1)。</li>
<li>• 引擎数量 × 正在进行的最大工作描述符。</li>
</ul>
<p>例如，如果为guest分配了以下内容：</p>
<ul>
<li>• 1 个引擎组中有 1 个 WQ。</li>
<li>• WQ 大小 &#x3D; 16。</li>
<li>• WQ 最大批次大小 &#x3D; 32。</li>
</ul>
<p>VDCM 事件队列大小 &#x3D; 1 × 16 × (32+1) + 1 × 16 × (32+1) + 1 × 128 &#x3D; 1184 个条目或大约 76 KB。</p>
<h1 id="8-描述符格式"><a href="#8-描述符格式" class="headerlink" title="8 描述符格式"></a>8 描述符格式</h1><h2 id="8-1-通用描述符字段"><a href="#8-1-通用描述符字段" class="headerlink" title="8.1 通用描述符字段"></a>8.1 通用描述符字段</h2><p>Intel DSA 描述符为 64 字节。一些描述符字段是所有操作类型所共有的，而一些字段则取决于操作类型。本节介绍大多数操作类型所共有的字段。每种操作类型的图表指示了哪些公共字段用于该操作类型以及操作特定字段是什么。</p>
<p>公共字段包括受信任字段和不受信任字段。受信任字段始终受设备信任，因为它们由 CPU 或主机上的特权（ring 0 或 VMM）软件填充。不受信任字段由客户端软件直接提供</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726709151406.png" class="" title="QQ_1726709151406">

<p>通用描述符格式</p>
<h3 id="8-1-1-可信字段"><a href="#8-1-1-可信字段" class="headerlink" title="8.1.1 可信字段"></a>8.1.1 可信字段</h3><p><strong>偏移量：0；大小：4 字节（32 位）</strong></p>
<ul>
<li>当将描述符提交给 SWQ 时，这些字段携带提交描述符的软件实体的特权和 PASID。</li>
<li>当将描述符提交给 DWQ 时，将忽略描述符中的这些字段；设备使用 WQCFG 寄存器的 WQ Priv 和 WQ PASID 字段。</li>
</ul>
<p>在 Intel CPU 上，当软件使用 ENQCMD 将描述符提交给 SWQ 时，源描述符中的这些字段被保留。IA32_PASID MSR 的值放在 PASID 字段中，并且在将描述符发送到设备之前将 Priv 字段设置为 0。</p>
<p>当软件使用 ENQCMDS 时，必须由软件适当地初始化源描述符中的这些字段。如果 PCI Express PASID 功能的特权模式启用字段为 0，则 Priv 字段必须为 0。</p>
<p>对于批次中的任何描述符，这些字段都将被忽略。批次描述符的相应字段用于批次中的每个描述符。</p>
<img src="/2024/09/13/Intel-DSA-spec/QQ_1726709372204.png" class="" title="QQ_1726709372204">

<h3 id="8-1-2-操作"><a href="#8-1-2-操作" class="headerlink" title="8.1.2 操作"></a>8.1.2 操作</h3><p><strong>偏移量：7；大小：1 字节（8 位）</strong></p>
<p>该字段指定要执行的操作</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919093136233.png" class="" title="image-20240919093136233">



<h3 id="8-1-3-标志"><a href="#8-1-3-标志" class="headerlink" title="8.1.3 标志"></a>8.1.3 标志</h3><p><strong>偏移量：4；大小：3 字节（24 位）</strong></p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919093229885.png" class="" title="image-20240919093229885">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919093430977.png" class="" title="image-20240919093430977">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919093450213.png" class="" title="image-20240919093450213">

<h3 id="8-1-4-完成记录地址"><a href="#8-1-4-完成记录地址" class="headerlink" title="8.1.4 完成记录地址"></a>8.1.4 完成记录地址</h3><p><strong>偏移量 8；大小 8 字节（64 位）</strong></p>
<p>此字段指定完成记录的地址。完成记录为 32 字节，并且必须与 32 字节边界对齐。如果完成记录地址有效标志为 0，则保留此字段。</p>
<ul>
<li>如果请求完成记录标志为 1，则在操作完成时将完成记录写入此地址。</li>
<li>如果请求完成记录标志为 0，则仅当出现页面错误或错误时才将完成记录写入此地址。</li>
</ul>
<p>对于产生结果的任何操作（例如比较），完成记录地址有效和请求完成记录标志必须同时为 1，并且完成记录地址必须有效。</p>
<p>对于使用虚拟地址的任何操作，无论是否设置了请求完成记录标志，完成记录地址都应该有效，以便在出现页面错误或错误时可以写入完成记录。</p>
<p>为了获得最佳结果，此字段应在所有描述符中有效，因为它允许设备向提交描述符的软件报告错误。否则，如果发生意外错误，则会在 SWERROR 寄存器或事件日志中报告该错误，并且提交请求的软件可能不会收到有关该错误的通知。</p>
<h3 id="8-1-5-源地址"><a href="#8-1-5-源地址" class="headerlink" title="8.1.5 源地址"></a>8.1.5 源地址</h3><p><strong>偏移量：16；大小：8 字节（64 位）</strong></p>
<p>对于从内存读取数据的操作，此字段指定源数据的地址。大多数操作类型对源地址没有对齐要求。操作描述中注明了例外情况。如果源地址和传输大小未同时对齐到 64 字节的倍数，则实现可能会读取比描述符所需的更多的源数据。例如，源数据可能以对齐的 32 字节块读取。多余的数据将被丢弃。</p>
<h3 id="8-1-6-目标地址"><a href="#8-1-6-目标地址" class="headerlink" title="8.1.6 目标地址"></a>8.1.6 目标地址</h3><p><strong>偏移量：24；大小：8 字节（64 位）</strong></p>
<p>对于将数据写入内存的操作，此字段指定目标缓冲区的地址。大多数操作类型的目标地址没有对齐要求。操作描述中注明了例外情况。</p>
<p>对于某些操作类型，此字段用作第二个源缓冲区的地址。</p>
<h3 id="8-1-7-传输大小"><a href="#8-1-7-传输大小" class="headerlink" title="8.1.7 传输大小"></a>8.1.7 传输大小</h3><p><strong>偏移量：32；大小：4 字节（32 位）</strong></p>
<p>此字段表示要从源地址读取的字节数以执行操作。<br>允许的最大传输大小取决于描述符提交到的 WQ。它由 WQ 配置表中 WQ 的 WQ 最大传输大小字段指定（而该字段又受通用功能寄存器中的最大支持传输大小字段限制）。创建增量记录操作对允许的最大传输大小有额外的限制，该操作的描述中注明了这一点。</p>
<p>对于批处理操作，此字段包含描述符计数。描述符计数必须大于 1。</p>
<p>允许的最大描述符计数由 WQ 配置表中 WQ 的 WQ 最大批处理大小字段指定（反过来，该字段受通用功能寄存器中的最大支持批处理大小字段限制）。<br>传输大小不得为 0。对于大多数操作类型，传输大小没有对齐要求。操作描述中注明了例外情况。</p>
<h3 id="8-1-8-完成中断句柄"><a href="#8-1-8-完成中断句柄" class="headerlink" title="8.1.8 完成中断句柄"></a>8.1.8 完成中断句柄</h3><p><strong>偏移量：36；大小：2 字节（16 位）</strong></p>
<p>此字段指定用于生成完成中断的中断表条目，如第 3.7 节所述。</p>
<p>如果请求完成中断标志为 0，则此字段保留。</p>
<h2 id="8-2-完成记录"><a href="#8-2-完成记录" class="headerlink" title="8.2 完成记录"></a>8.2 完成记录</h2><p>完成记录是内存中的一个 32 字节结构，设备在操作完成或遇到错误时会将其写入内存中。每个描述符中都有一个完成记录地址。完成记录地址必须按 32 字节对齐。有关更多信息，请参阅第 3.6 节。</p>
<p>本节介绍大多数操作类型共有的完成记录字段。其他特定于操作的字段在第 8.3 节的详细操作描述中进行了描述。即使不需要所有字段，完成记录也始终为 32 字节。如果由于页面错误而导致操作部分完成，完成记录包含足够的信息以继续操作。页面错误由操作状态代码 0x03、0x04、0x06 和 0x1f 指示，如表 5-6 中所述。软件不应依赖未使用的字段的值（包括未用于特定操作类型的字段）。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919093920311.png" class="" title="image-20240919093920311">

<h3 id="8-2-1-状态"><a href="#8-2-1-状态" class="headerlink" title="8.2.1 状态"></a>8.2.1 状态</h3><p><strong>偏移量：0；大小：1 字节（8 位）</strong></p>
<p>此字段报告描述符的完成状态。硬件永远不会向此字段写入 0。软件应将此字段初始化为 0，以便能够检测完成记录何时已写入。有关操作状态代码及其含义的列表，请参阅第 5.8.1 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919094400832.png" class="" title="image-20240919094400832">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919094417644.png" class="" title="image-20240919094417644">

<h3 id="8-2-2-结果"><a href="#8-2-2-结果" class="headerlink" title="8.2.2 结果"></a>8.2.2 结果</h3><p><strong>偏移量：1；大小：1 字节（8 位）</strong></p>
<p>对于某些操作类型，结果字段包含有关操作结果的信息。每种操作类型的描述包括此字段的可能值和含义。对于未指定含义的操作类型，软件不应依赖此字段的值。</p>
<h3 id="8-2-3-故障信息"><a href="#8-2-3-故障信息" class="headerlink" title="8.2.3 故障信息"></a>8.2.3 故障信息</h3><p><strong>偏移量：2；大小：1 字节（8 位）</strong></p>
<p>如果由于页面错误导致操作部分完成，并且 GENCAP 中的完成记录故障信息支持为 1，则该字段包含有关遇到的故障的附加信息。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101000326.png" class="" title="image-20240919101000326">

<h3 id="8-2-4-完成的字节数"><a href="#8-2-4-完成的字节数" class="headerlink" title="8.2.4 完成的字节数"></a>8.2.4 完成的字节数</h3><p><strong>偏移量：4；大小：4 字节（32 位）</strong></p>
<p>如果由于页面错误导致操作部分完成，则此字段包含发生错误之前处理的源字节数。此计数表示的所有源字节都已完全处理，并且结果已根据操作类型的需要写入目标地址。页面错误由操作状态代码 0x03、0x04、0x06 和 0x1f 指示，如表 5-6 中所述。对于其他错误，此字段未定义。</p>
<p>对于某些操作类型，当操作因错误以外的某种原因在完成之前停止时，也可以使用此字段。这些用途在特定于每个操作类型的部分中描述。</p>
<p>如果操作完全完成，则此字段为 0。</p>
<p>对于无法根据该值轻易确定输出大小的操作类型，完成记录还包含写入目标地址的字节数。</p>
<h3 id="8-2-5-故障地址"><a href="#8-2-5-故障地址" class="headerlink" title="8.2.5 故障地址"></a>8.2.5 故障地址</h3><p><strong>偏移量：8；大小：8 字节（64 位）</strong></p>
<p>如果由于页面错误导致操作部分完成，并且 GENCAP 中的完成记录错误信息支持为 1，则错误信息字段指定错误地址是否可用。如果 GENCAP 中的完成记录错误信息支持为 0，则此字段始终包含导致错误的地址。位 11:0 可能报告为 0。页面错误报告为操作状态代码 0x03、0x04、0x06 或 0x1f，如表 5-6 中所述。对于其他错误，此字段未定义。</p>
<h3 id="8-2-6-无效标志"><a href="#8-2-6-无效标志" class="headerlink" title="8.2.6 无效标志"></a>8.2.6 无效标志</h3><p><strong>偏移量：16；大小：3 字节（24 位）</strong></p>
<p>如果操作状态为无效标志，则此字段包含被发现无效的标志的位掩码，以帮助调试。如果此字段中的某个位为 1，则表示描述符的标志字段中相应位位置处的标志无效。实现没有义务指示描述符中可能存在的每个无效标志，但它必须在报告无效标志错误代码时指示至少一个无效标志。</p>
<p>如果操作状态不是无效标志，则此字段可能用于操作特定的信息，也可能不被使用，具体取决于操作类型。有关更多信息，请参阅每种操作类型的完成记录的描述。</p>
<h2 id="8-3-描述符类型"><a href="#8-3-描述符类型" class="headerlink" title="8.3 描述符类型"></a>8.3 描述符类型</h2><h3 id="8-3-1-无操作"><a href="#8-3-1-无操作" class="headerlink" title="8.3.1 无操作"></a>8.3.1 无操作</h3><p>No-op 操作 0x00 不执行 DMA 操作。它可能请求完成记录和&#x2F;或完成中断。如果它在批处理中，它可能指定 Fence 标志以确保 No-op 描述符的完成发生在批处理中所有先前的描述符完成后。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101357394.png" class="" title="image-20240919101357394">

<h3 id="8-3-2-批处理"><a href="#8-3-2-批处理" class="headerlink" title="8.3.2 批处理"></a>8.3.2 批处理</h3><p>批处理操作 0x01 一次将多个描述符排队。描述符列表地址是要处理的工作描述符的连续数组的地址。数组中的每个描述符为 64 个字节。<br>描述符列表地址必须与 64 个字节对齐。描述符计数是数组中的描述符数量。<br>数组中的描述符集称为“批处理”。描述符计数必须大于 1。批处理中允许的最大描述符数量由 WQ 配置表中 WQ 的 WQ 最大批处理大小字段指定（而该字段又受通用功能寄存器中的最大支持批处理大小字段限制）。</p>
<p>与批次描述符关联的 PASID 和 Priv 标志用于批次中的所有描述符。<br>批次中描述符的 PASID 和 Priv 字段将被忽略。</p>
<p>完成记录的“描述符已完成”字段包含已处理的批处理中的描述符总数，无论它们是否成功。如果批处理中有 Fence 或读取批处理时发生不可恢复的转换故障，则“描述符已完成”可能小于“描述符计数”。</p>
<p>如果批处理中的所有描述符都成功完成，则批处理完成记录的“状态”字段指示“成功”；否则，它指示“描述符列表地址”上是否有页面错误，或者批处理中的一个或多个描述符完成且“状态”不等于“成功”。</p>
<p>如果 GENCAP 中的“批处理继续支持”为 1，则如果批处理中的任何操作完成且“状态”不等于“成功”，则完成记录中的“结果”字段为 1。在某些情况下，如果批处理中的描述符在完成记录地址上遇到页面错误，即使完成记录页面错误已成功解决，结果也可能为 1。软件可以检查批处理中描述符的完成记录，以确定是否确实存在任何故障。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101524033.png" class="" title="image-20240919101524033">

<p>如果软件在描述符列表地址发生故障后继续执行批处理，则应将部分完成的完成记录中的结果字段复制到连续描述符的批处理错误字段中</p>
<p>批处理的详细信息请参阅第 3.8 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101546165.png" class="" title="image-20240919101546165">

<h3 id="8-3-3-排空"><a href="#8-3-3-排空" class="headerlink" title="8.3.3 排空"></a>8.3.3 排空</h3><p>排空操作 0x02 等待排空描述符提交到的 WQ 中某些未完成的描述符完成，如第 3.10 节所述。</p>
<p>排空描述符可能不包含在批处理中；它被视为不受支持的操作类型。</p>
<p>排空必须指定请求完成记录或请求完成中断。完成通知是在其他描述符完成后发出的。</p>
<p>表 8-7 列出了排空操作允许的操作特定标志。如果排空描述符的回读地址支持能力位为 0，则保留回读地址 1 有效和回读地址 2 有效标志。</p>
<p>标志地址 1 TC 选择器和地址 2 TC 选择器在排空描述符中有条件允许。当回读地址 1 有效为 0 时，保留地址 1TC 选择器。当回读地址 2 有效为 0 时，保留地址 2TC 选择器。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101713566.png" class="" title="image-20240919101713566">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919101722698.png" class="" title="image-20240919101722698">

<h3 id="8-3-4-内存移动"><a href="#8-3-4-内存移动" class="headerlink" title="8.3.4 内存移动"></a>8.3.4 内存移动</h3><p>内存移动操作 0x03 将内存从源地址复制到目标地址。</p>
<p>复制的字节数由传输大小给出。内存地址或传输大小没有对齐要求。<br>如果源区域和目标区域重叠，则行为取决于 GENCAP 中的重叠复制支持字段的值。如果重叠复制支持为 1，则内存复制的完成方式就像将整个源缓冲区复制到临时空间，然后复制到目标缓冲区一样。（这可以通过在目标缓冲区的开头与源缓冲区的结尾重叠时反转复制方向来实现。）如果重叠复制支持为 0，则为错误。</p>
<p>如果由于页面错误而导致操作部分完成，则完成记录的结果字段包含复制的方向。如果复制是从源缓冲区和目标缓冲区的开头开始执行的，则为 0；如果复制的方向被反转，则为 1。如果重叠复制支持为 0，则结果始终为 0。</p>
<p>要在部分完成后恢复操作，如果结果为 0，则延续描述符中的源地址和目标地址字段应增加“已完成的字节数”，传输大小应减少“已完成的字节数”。如果结果为 1，则传输大小应减少“已完成的字节数”，但源地址和目标地址字段应与原始描述符中的相同。请注意，如果发生后续部分完成，则结果字段不一定与第一次部分完成时的结果字段相同。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101814894.png" class="" title="image-20240919101814894">

<h3 id="8-3-5-填充"><a href="#8-3-5-填充" class="headerlink" title="8.3.5 填充"></a>8.3.5 填充</h3><p>内存填充操作 0x04 使用模式字段中的值填充目标地址处的内存。</p>
<p>模式大小由模式大小标志指定。当模式大小为 8 个字节时，模式在模式下限字段中指定。当模式大小为 16 个字节时，前 8 个字节在模式下限中，接下来的 8 个字节在模式上限中。（要使用较小的模式，软件必须在描述符中复制该模式。）写入的字节数由传输大小给出。传输大小不需要是模式大小的倍数。目标地址或传输大小没有对齐要求。如果由于页面错误而导致操作部分完成，则完成记录的已完成字节字段包含发生错误之前写入目标的字节数。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101845895.png" class="" title="image-20240919101845895">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919101857936.png" class="" title="image-20240919101857936">

<h3 id="8-3-6-比较"><a href="#8-3-6-比较" class="headerlink" title="8.3.6 比较"></a>8.3.6 比较</h3><p>比较操作 0x05 将源 1 地址处的内存与源 2 地址处的内存进行比较。 </p>
<p>比较的字节数由传输大小给出。内存地址或传输大小没有对齐要求。完成记录地址有效和请求完成记录标志必须为 1，并且完成记录地址必须有效。比较结果写入完成记录的结果字段：值为 0 表示两个内存区域匹配，值为 1 表示它们不匹配。如果结果为 1，则完成记录的字节完成字段指示第一个差异的字节偏移量。如果由于页面错误而导致操作部分完成，则结果为 0。（如果检测到差异，则将报告差异而不是页面错误。）</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101930835.png" class="" title="image-20240919101930835">

<p>如果操作成功且检查结果标志为 1，则完成记录的状态字段将根据结果和预期结果进行设置，如表 8-9 所示。这允许同一批次中具有 Fence 标志的后续描述符根据比较结果继续或停止执行批次。预期结果的位 7:1 将被忽略。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919101946986.png" class="" title="image-20240919101946986">

<h3 id="8-3-7-比较模式"><a href="#8-3-7-比较模式" class="headerlink" title="8.3.7 比较模式"></a>8.3.7 比较模式</h3><p>比较模式操作 0x06 将源地址处的内存与模式字段中的值进行比较。模式大小始终为 8 个字节。（要使用较小的模式，软件必须在描述符中复制模式。）比较的字节数由传输大小给出。传输大小不必是模式大小的倍数。完成记录地址有效和请求完成记录标志必须为 1，并且完成记录地址必须有效。比较结果写入完成记录的结果字段；值为 0 表示内存区域与模式匹配，值为 1 表示不匹配。如果结果为 1，则完成记录的已完成字节字段指示第一个差异的位置。 （它可能不是确切的字节位置，但保证不大于第一个差异。）如果由于页面错误而导致操作部分完成，则结果为 0。（如果检测到差异，则将报告差异而不是页面错误。）</p>
<p>Compare Pattern 的完成记录格式以及 Check Result 和 Expected Result 的行为与 Compare 相同。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102021301.png" class="" title="image-20240919102021301">

<h3 id="8-3-8-创建增量记录"><a href="#8-3-8-创建增量记录" class="headerlink" title="8.3.8 创建增量记录"></a>8.3.8 创建增量记录</h3><p>创建增量记录操作 0x07 将源 1 地址处的内存与源 2 地址处的内存进行比较，并生成一个增量记录，其中包含更新源 1 以匹配源 2 所需的信息。比较的字节数由传输大小给出。除了通常的 WQ 特定传输大小限制外，传输大小还受增量记录中可存储的最大偏移量限制（如下所述）。源 1 地址、源 2 地址和传输大小必须对齐为 8 的倍数。完成记录地址有效和请求完成记录标志必须为 1，并且完成记录地址必须有效。</p>
<p>增量记录的最大大小由最大增量记录大小给出。最大增量记录大小应为增量大小（10 字节）的倍数，不得小于可从单个缓存行生成的最大增量数（80 字节），并且不得大于此描述符提交到的 WQ 的 WQ 配置表中的 WQ 最大传输大小允许的值。如果最大大小的增量记录与任一源缓冲区重叠，则会出现错误。生成的增量记录的实际大小取决于在源 1 和源 2 之间检测到的差异数量；此大小将写入完成记录的增量记录大小字段。如果增量记录中所需的空间超出描述符中指定的最大增量记录大小，则操作将以部分增量记录完成。</p>
<p>比较结果将写入完成记录的结果字段。如果两个区域完全匹配，则结果为 0，差异记录大小为 0，且已完成的字节数为 0。如果两个区域不匹配，且已将一整套差异写入差异记录，则结果为 1，差异记录大小包含发现的所有差异的总大小，且已完成的字节数为 0。如果两个区域不匹配，且记录所有差异所需的空间超过了最大差异记录大小，则结果为 2，差异记录大小包含写入差异记录的差异集的大小（通常等于或接近于描述符中指定的最大差异记录大小），且已完成的字节数包含在超出差异记录中的空间之前比较的字节数。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102102609.png" class="" title="image-20240919102102609">

<p>如果由于页面错误导致操作部分完成，则如果页面错误之前未写入任何增量，则将 Result 设置为 0；如果页面错误之前写入了任何增量，则将 Result 设置为 1。无论页面错误是发生在源缓冲区之一还是增量记录缓冲区上，此行为都是相同的。已完成字节数包含页面错误发生之前比较的字节数，增量记录大小包含页面错误发生之前增量记录中使用的空间。如果由于任何其他错误导致操作失败，则这些字段未定义。为确保软件可以恢复操作而不丢失任何增量，如果增量记录上发生故障，已完成字节数不包括未写入增量记录的发现差异的字节。</p>
<p>增量记录的格式如下所示。增量记录包含增量数组。每个增量包含一个 2 字节偏移量和一个来自 Source2 的 8 字节数据块，该数据块与 Source1 中相应的 8 字节不同。2 字节偏移量字段存储在内存中，低字节位于低地址（小端字节序）。增量记录的总大小是 10 的倍数。由于偏移量是一个 16 位字段，表示 8 字节的倍数，因此可以表示的最大偏移量为 0x7FFF8，因此最大传输大小为 0x80000 字节（512 KB）。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102232395.png" class="" title="image-20240919102232395">

<p>如果操作成功且检查结果标志为 1，则根据结果和预期结果掩码设置完成记录的状态字段。这允许同一批次中具有 Fence 标志的后续描述符根据增量记录创建的结果继续或停止批次的执行。<br>状态设置如下：如果结果的值为 X 且预期结果掩码的位 X 为 1，则状态设置为成功。如果位 X 为 0，则状态设置为成功且谓词为假。由于结果的值为 0、1 或 2，因此忽略预期结果掩码的位 7:3。请注意，如果预期结果掩码的位 2:0 为 0，则状态将始终设置为成功且谓词为假，如果预期结果掩码的位 2:0 全部为 1，则状态将始终设置为成功。</p>
<p>如果操作成功且检查结果标志为 0，则忽略预期结果掩码并将状态设置为成功。</p>
<h3 id="8-3-9-应用增量记录"><a href="#8-3-9-应用增量记录" class="headerlink" title="8.3.9 应用增量记录"></a>8.3.9 应用增量记录</h3><p>应用增量记录操作 0x08 将增量记录应用于目标地址内存的内容。增量记录地址是由结果等于 1 的创建增量记录操作创建的增量记录的地址。增量记录大小是增量记录的大小，如创建增量记录操作的完成记录中所述。目标地址是包含与创建增量记录时源 1 地址内存相同内容的缓冲区的地址。传输大小与创建增量记录时使用的传输大小相同。应用增量记录操作完成后，目标地址的内存将与创建增量记录时源 2 地址内存中的内容相匹配。目标地址和传输大小必须对齐为 8 的倍数。如果增量记录与目标缓冲区重叠，则会出现错误。</p>
<p>如果在应用增量记录操作期间遇到页面错误，则完成记录的“已完成字节数”字段包含已成功应用于目标的增量记录的字节数。如果软件选择提交另一个描述符来恢复操作，则继续描述符应包含与原始描述符相同的目标地址。增量记录地址应增加“已完成字节数”（因此它指向第一个未应用的增量），增量记录大小应减少“已完成字节数”。</p>
<p>如果增量记录中的偏移量字段不是按升序排列的，或者任何偏移量字段大于或等于传输大小，则会报告错误，并且完成记录的“已完成字节数”字段包含错误发生前已成功应用于目标的增量记录的字节数。</p>
<p>有关增量记录格式的描述，请参阅第 8.3.8 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102320112.png" class="" title="image-20240919102320112">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919102327719.png" class="" title="image-20240919102327719">

<p>图 8-1 显示了 Create Delta Record 和 Apply Delta Record 操作的用法。首先，执行 Create Delta Record 操作。它读取两个源缓冲区并写入增量记录，并在其完成记录中记录实际增量记录大小。Apply Delta Record 操作获取 Create Delta Record 操作写入的增量记录的内容以及其大小和 Source1 数据的副本，并将目标缓冲区更新为原始 Source2 缓冲区的副本。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102344449.png" class="" title="image-20240919102344449">

<h3 id="8-3-10-双播内存复制"><a href="#8-3-10-双播内存复制" class="headerlink" title="8.3.10 双播内存复制"></a>8.3.10 双播内存复制</h3><p>双播内存复制操作 0x09 将内存从源地址复制到目标 1 地址和目标 2 地址。复制的字节数由传输大小给出。<br>源地址或传输大小没有对齐要求。两个目标地址的位 11:0 必须相同。</p>
<p>如果源区域与任一目标区域重叠，或者两个目标区域重叠，则会出现错误。如果由于页面错误而导致操作部分完成，则复制操作在向两个目标区域写入相同数量的字节后停止。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102413944.png" class="" title="image-20240919102413944">

<h3 id="8-3-11-翻译获取"><a href="#8-3-11-翻译获取" class="headerlink" title="8.3.11 翻译获取"></a>8.3.11 翻译获取</h3><p>转换获取操作 0x0A 通过向 IOMMU 发出地址转换 (ATS) 请求来获取描述符中指定的地址范围的地址转换。此操作不涉及任何数据移动。区域大小字段指定可发出转换请求的地址范围的大小。如果使用步长标志为 1，则区域步长字段指定要跳过的字节数，以计算每个后续 ATS 请求的地址。区域步长必须大于或等于 4096，并且必须是 2 的幂。当 ATS 请求地址大于或等于起始地址加上区域大小时，描述符执行终止。如果使用步长为 0，则设备使用特定于实现的步长值。地址或区域大小没有对齐要求。但是，转换请求始终是 4KB 对齐的，并且可以对齐到区域步长的倍数。</p>
<p>区域大小必须为非零，并且描述符中的地址和区域大小之和必须小于或等于 264。如果遇到页面错误，则“故障块”标志控制操作是否部分完成，或者是否向 IOMMU 发出页面请求。如果由于页面错误而部分完成，则在完成记录中报告故障地址。“已完成字节”字段未定义，软件不应依赖该字段。</p>
<p>该操作可能导致 IOMMU 执行的一个或多个地址转换，或用于地址转换的转换结构条目，或两者，被缓存在设备或 IOMMU 中的地址转换缓存中。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102446116.png" class="" title="image-20240919102446116">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919102453572.png" class="" title="image-20240919102453572">

<h3 id="8-3-12-CRC-生成"><a href="#8-3-12-CRC-生成" class="headerlink" title="8.3.12 CRC 生成"></a>8.3.12 CRC 生成</h3><p>CRC 生成操作 0x10 计算源地址内存中的 CRC。有关 CRC 生成的详细信息，请参阅附录 A。用于 CRC 计算的字节数由传输大小给出。内存地址或传输大小没有对齐要求。完成记录地址有效和请求完成记录标志必须为 1，并且完成记录地址必须有效。计算出的 CRC 值将写入完成记录。</p>
<p>CRC 生成操作特定标志如表 8-11 所示。计算出的 CRC 值的大小和使用的 CRC 种子取决于 CRC 大小标志。如果 CRC 大小为 0，则使用 32 位 CRC 种子，并计算 32 位 CRC 值。如果 CRC 大小为 1，则使用 64 位 CRC 种子，并计算 64 位 CRC 值。</p>
<p>如果读取 CRC 种子标志为 1，则从 CRC 种子地址处的内存中读取 CRC 种子。该地址必须自然与 CRC 值的大小对齐。如果读取 CRC 种子标志为 0，则描述符中的 CRC 种子字段用于种子。除非这是部分 CRC 计算的延续，否则种子应为 0。如果 CRC 大小为 0，则 CRC 种子的位 63:32 被保留。</p>
<p>如果由于页面错误导致操作部分完成，则部分 CRC 结果将与页面错误信息一起写入完成记录。如果软件纠正了错误并恢复操作，则必须使用部分 CRC 结果作为继续描述符的种子，方法是将其复制到 CRC 种子字段中，或者将 CRC 种子地址设置为部分 CRC 结果的位置并将读取 CRC 种子标志设置为 1。如果操作由于任何其他错误而失败，或者完成的字节数为 0，则完成记录中的 CRC 值未定义，软件应重新使用描述符中的 CRC 种子或 CRC 种子地址。</p>
<p>如果读取 CRC 种子标志为 0，则保留 CRC 种子地址字段。如果读取 CRC 种子标志为 1，则保留 CRC 种子字段。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102537533.png" class="" title="image-20240919102537533">

<h3 id="8-3-13-带-CRC-生成的复制"><a href="#8-3-13-带-CRC-生成的复制" class="headerlink" title="8.3.13 带 CRC 生成的复制"></a>8.3.13 带 CRC 生成的复制</h3><p>带 CRC 生成的复制操作 0x11 将内存从源地址复制到目标地址，并计算复制数据的 CRC。有关 CRC 生成的详细信息，请参阅附录 A。复制的字节数由传输大小给出。内存地址或传输大小没有对齐要求。如果源区域和目标区域重叠，则会出现错误。完成记录地址有效和请求完成记录标志必须为 1，并且完成记录地址必须有效。计算出的 CRC 值将写入完成记录。	</p>
<p>有关 CRC 操作特定标志、CRC 种子字段和 CRC 种子地址字段的描述，请参阅第 8.3.12 节和表 8-11 中 CRC 生成操作的描述。</p>
<p>带 CRC 生成的复制的完成记录格式与 CRC 生成的格式相同。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102614846.png" class="" title="image-20240919102614846">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919102623729.png" class="" title="image-20240919102623729">

<h3 id="8-3-14-DIF-检查"><a href="#8-3-14-DIF-检查" class="headerlink" title="8.3.14 DIF 检查"></a>8.3.14 DIF 检查</h3><p>DIF 检查操作 0x12 计算源数据上的数据完整性字段 (DIF)，并将计算出的 DIF 与源数据中包含的 DIF 进行比较。<br>读取的源字节数由传输大小给出。对每个 512、520、4096 或 4104 字节的源数据块执行 DIF 计算。传输大小应为源块大小的倍数加上每个源块的 8 个字节。源地址没有对齐要求。</p>
<p>如果操作成功完成，则最终的参考标记和应用程序标记将与成功完成状态一起写入完成记录。如果由于页面错误而导致操作部分完成，则参考标记和应用程序标记的更新值将与页面错误信息一起写入完成记录。如果软件纠正了错误并恢复操作，它可能会将这些字段复制到延续描述符中。如果操作由于任何其他错误而失败，则这些字段未定义。</p>
<p>如果在源数据的 DIF 中检测到错误，则操作停止。完成记录中的状态字段设置为 DIF 错误，DIF 状态字段设置为指示错误类型，完成字节数字段设置为成功处理的源字节数。完成字节数不包括检测到错误的块。完成记录地址有效和请求完成记录标志必须为 1，完成记录地址必须有效。</p>
<p>有关 DIF 标志、源 DIF 标志和完成记录中字段的描述，请参见第 8.3.17 节“DIF 更新”。有关 DIF 检查的详细信息，请参见附录 B。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102816563.png" class="" title="image-20240919102816563">

<h3 id="8-3-15-DIF-插入"><a href="#8-3-15-DIF-插入" class="headerlink" title="8.3.15 DIF 插入"></a>8.3.15 DIF 插入</h3><p>DIF 插入操作 0x13 将内存从源地址复制到目标地址，同时计算源数据上的数据完整性字段 (DIF) 并将 DIF 插入输出数据。<br>复制的源字节数由传输大小给出。对每个 512、520、4096 或 4104 字节的源数据块执行 DIF 计算。传输大小应为源块大小的倍数。写入目标的字节数是传输大小加上每个源块的 8 个字节。内存地址没有对齐要求。如果源和目标区域重叠，则会出现错误。</p>
<p>如果操作成功完成，则最终的引用标记和应用程序标记将与成功完成状态一起写入完成记录。如果由于页面错误而导致操作部分完成，则引用标记和应用程序标记的更新值将与页面错误信息一起写入完成记录。如果软件纠正了错误并恢复操作，它可能会将这些字段复制到延续描述符中。如果操作由于任何其他错误而失败，则这些字段未定义。</p>
<p>有关 DIF 标志、目标 DIF 标志和完成记录中的字段的描述，请参阅第 8.3.17 节“DIF 更新”。有关 DIF 计算的详细信息，请参阅附录 B。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102845652.png" class="" title="image-20240919102845652">

<h3 id="8-3-16-DIF-Strip"><a href="#8-3-16-DIF-Strip" class="headerlink" title="8.3.16 DIF Strip"></a>8.3.16 DIF Strip</h3><p>DIF Strip 操作 0x14 将内存从源地址复制到目标地址，删除数据完整性字段 (DIF)。它可选择计算源数据的 DIF，并将计算出的 DIF 与源数据中包含的 DIF 进行比较。</p>
<p>读取的源字节数由传输大小给出。对每个 512、520、4096 或 4104 字节的源数据块执行 DIF 计算。传输大小应为源块大小的倍数加上每个源块的 8 个字节。写入目标的字节数是传输大小减去每个源块的 8 个字节。内存地址没有对齐要求。如果源和目标区域重叠，则会出现错误。</p>
<p>如果操作成功完成，则最终的引用标记和应用程序标记将与成功完成状态一起写入完成记录。如果由于页面错误而导致操作部分完成，则引用标记和应用程序标记的更新值将与页面错误信息一起写入完成记录。如果软件纠正了错误并恢复操作，它可能会将这些字段复制到延续描述符中。如果操作由于任何其他错误而失败，则这些字段未定义。</p>
<p>如果在源数据的 DIF 中检测到错误，则操作停止。完成记录中的状态字段设置为 DIF 错误，DIF 状态字段设置为指示错误类型，完成字节字段设置为成功处理的源字节数。完成字节不包括检测到错误的块。</p>
<p>有关 DIF 标志、源 DIF 标志和完成记录中字段的描述，请参阅第 8.3.17 节“DIF 更新”。有关 DIF 检查的详细信息，请参阅附录 B。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919102940807.png" class="" title="image-20240919102940807">

<h3 id="8-3-17-DIF-更新"><a href="#8-3-17-DIF-更新" class="headerlink" title="8.3.17 DIF 更新"></a>8.3.17 DIF 更新</h3><p>DIF 更新操作 0x15 将内存从源地址复制到目标地址。它可选择计算源数据上的数据完整性字段 (DIF)，并将计算出的 DIF 与数据中包含的 DIF 进行比较。它同时使用描述符中的目标 DIF 字段计算源数据的 DIF，并将计算出的 DIF 插入到输出数据中。</p>
<p>读取的源字节数由传输大小给出。对每个 512、520、4096 或 4104 字节的源数据块执行 DIF 计算。传输大小应为源块大小的倍数加上每个源块的 8 个字节。写入目标的字节数与传输大小相同。内存地址没有对齐要求。如果源和目标区域重叠，则会出现错误。</p>
<p>如果操作成功完成，最终的源和目标参考标记和应用程序标记将与成功完成状态一起写入完成记录。如果由于页面错误导致操作部分完成，则源和目标引用标记和应用程序标记的更新值将与页面错误信息一起写入完成记录。如果软件纠正了错误并恢复操作，它可能会将这些字段复制到延续描述符中。如果操作由于任何其他错误而失败，则这些字段未定义。</p>
<p>如果在源数据的 DIF 中检测到错误，则操作停止。完成记录中的状态字段设置为 DIF 错误，DIF 状态字段设置为指示错误类型，完成字节字段设置为成功处理的源字节数（包括生成的 DIF 字节）。完成字节不包括检测到错误的块。</p>
<p>有关 DIF 计算和检查的详细信息，请参阅附录 B。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103023322.png" class="" title="image-20240919103023322">

<h4 id="8-3-17-1-DIF-标志"><a href="#8-3-17-1-DIF-标志" class="headerlink" title="8.3.17.1 DIF 标志"></a>8.3.17.1 DIF 标志</h4><img src="/2024/09/13/Intel-DSA-spec/image-20240919103044376.png" class="" title="image-20240919103044376">

<h4 id="8-3-17-2-源-DIF-标志"><a href="#8-3-17-2-源-DIF-标志" class="headerlink" title="8.3.17.2 源 DIF 标志"></a>8.3.17.2 源 DIF 标志</h4><img src="/2024/09/13/Intel-DSA-spec/image-20240919103059588.png" class="" title="image-20240919103059588">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919103106277.png" class="" title="image-20240919103106277">

<h4 id="8-3-17-3-目标-DIF-标志"><a href="#8-3-17-3-目标-DIF-标志" class="headerlink" title="8.3.17.3 目标 DIF 标志"></a>8.3.17.3 目标 DIF 标志</h4><img src="/2024/09/13/Intel-DSA-spec/image-20240919103146793.png" class="" title="image-20240919103146793">

<h4 id="8-3-17-4-DIF-状态"><a href="#8-3-17-4-DIF-状态" class="headerlink" title="8.3.17.4 DIF 状态"></a>8.3.17.4 DIF 状态</h4><p><strong>完成记录偏移量：1；大小：1 字节</strong></p>
<p>此字段报告 DIF 操作的状态。此字段仅针对 DIF 检查、DIF 剥离和 DIF 更新操作定义，并且仅当完成记录的状态字段为 DIF 错误时才定义。当单个块检测到多个错误时，可以组合使用值 0x01、0x02 和 0x04。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103214698.png" class="" title="image-20240919103214698">

<p>当下列条件之一为真时，即检测到 F 检测条件：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103227943.png" class="" title="image-20240919103227943">

<h3 id="8-3-18-DIX-生成"><a href="#8-3-18-DIX-生成" class="headerlink" title="8.3.18 DIX 生成"></a>8.3.18 DIX 生成</h3><p>DIX 生成操作 0x17 计算源数据上的数据完整性字段 (DIF)，并仅将每个源块的计算 DIF 写入目标地址。源数据不会复制到目标区域。<br>源字节数由传输大小给出。对每个 512、520、4096 或 4104 字节的源数据块执行 DIF 计算。传输大小应为源块大小的倍数。</p>
<p>如果操作成功完成，则写入目标的字节数为源块数乘以 8。源地址没有对齐要求，但目标地址必须对齐为 8 的倍数。如果源区域和目标区域重叠，则会出现错误。</p>
<p>如果操作成功完成，则最终的参考标记和应用程序标记将与成功完成状态一起写入完成记录。如果由于页面错误导致操作部分完成，则更新的参考标记和应用程序标记值将与页面错误信息一起写入完成记录。如果软件纠正了错误并恢复操作，则它可能将这些字段复制到继续描述符中。完成记录地址有效和请求完成记录标志必须为 1，并且完成记录地址必须有效。</p>
<p>有关 DIF 标志、目标 DIF 标志和完成记录中字段的描述，请参阅第 8.3.17 节“DIF 更新”。有关 DIF 计算的详细信息，请参阅附录 B。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103300471.png" class="" title="image-20240919103300471">

<h3 id="8-3-19-缓存刷新"><a href="#8-3-19-缓存刷新" class="headerlink" title="8.3.19 缓存刷新"></a>8.3.19 缓存刷新</h3><p>缓存刷新操作 0x20 刷新目标地址处的处理器缓存。刷新的字节数由传输大小给出。传输大小不必是缓存行大小的倍数。目标地址或传输大小没有对齐要求。任何被目标区域部分覆盖的缓存行都会被刷新。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103319123.png" class="" title="image-20240919103319123">

<h3 id="8-3-20-跨域操作"><a href="#8-3-20-跨域操作" class="headerlink" title="8.3.20 跨域操作"></a>8.3.20 跨域操作</h3><p>本节描述了 3.13.3 节中描述的域间操作的描述符的详细信息。以下操作支持域间功能：</p>
<ul>
<li>• 域间操作 <ul>
<li>o 域间内存复制 </li>
<li>o 域间填充 </li>
<li>o 域间比较 </li>
<li>o 域间比较模式 </li>
<li>o 域间缓存刷新</li>
</ul>
</li>
<li>• 更新窗口</li>
</ul>
<h4 id="8-3-20-1-通用描述符格式"><a href="#8-3-20-1-通用描述符格式" class="headerlink" title="8.3.20.1 通用描述符格式"></a>8.3.20.1 通用描述符格式</h4><p>如下图所示，域间操作的描述符允许软件为每个源或目标地址指定一个 IDPT 句柄。IDPT 句柄必须引用类型 0 SASS 或类型 1 SAMS IDPTE（如第 3.14.1 节所述）。必须至少有一个有效的 IDPT 句柄，由设置为 1 的相应标志位指示。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103630388.png" class="" title="image-20240919103630388">

<h4 id="8-3-20-2-完成记录"><a href="#8-3-20-2-完成记录" class="headerlink" title="8.3.20.2 完成记录"></a>8.3.20.2 完成记录</h4><p>本节定义了域间操作的完成记录格式。</p>
<p>如果域间操作由于页面错误而部分完成，并且错误地址引用描述符 PASID，则完成记录将报告遇到页面错误的错误地址。</p>
<p>如果错误地址引用备用 PASID，或者由于 IDPT 句柄无效、IDPTE 配置错误或权限不足而导致操作失败，则完成记录将指定与错误地址或错误关联的 IDPT 句柄。</p>
<p>如果 IDPTE 中的窗口模式字段设置为偏移模式，则完成记录不会报告备用 PASID 地址空间中的错误地址，并且错误信息字段中的错误地址掩码位将报告为 1。错误信息字段指示导致错误的操作数（如第 8.2.3 节所述），软件可以使用已完成字节字段来识别相对于描述符中指定的起始地址或偏移量的故障位置。</p>
<p>提交者应使用软件机制与内存窗口出现页面错误的进程进行通信，并在恢复操作之前解决该错误。或者，提交者可以在描述符中设置“发生错误时阻止”标志，以使设备等待页面错误解决后再继续操作。</p>
<p>结果字段用于域间比较和比较模式。结果字段不用于域间复制、填充或缓存刷新。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103708244.png" class="" title="image-20240919103708244">

<h4 id="8-3-20-3-域间复制"><a href="#8-3-20-3-域间复制" class="headerlink" title="8.3.20.3 域间复制"></a>8.3.20.3 域间复制</h4><p>域间复制操作 0x23 将内存从源地址复制到目标地址。源地址或目标地址中至少有一个必须使用 IDPT 句柄进行限定，并且必须引用域间权限表条目，该条目属于第 3.14.1 节中指定的类型之一。软件通过设置下表中描述的至少一个标志来实现此目的。</p>
<p>复制的字节数由传输大小给出。内存地址或传输大小没有对齐要求。</p>
<p>如果区域在物理内存中重叠，则行为未定义。</p>
<p>完成记录格式在第 8.3.20.2 节中描述。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103744076.png" class="" title="image-20240919103744076">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919103753656.png" class="" title="image-20240919103753656">

<h4 id="8-3-20-4-域间填充"><a href="#8-3-20-4-域间填充" class="headerlink" title="8.3.20.4 域间填充"></a>8.3.20.4 域间填充</h4><p>域间填充操作 0x24 使用模式字段中的值填充目标地址处的内存。必须指定目标 IDPT 句柄，并且它必须引用 3.14.1 节中指定的类型之一的域间权限表条目。</p>
<p>完成记录格式在 8.3.20.2 节中描述。</p>
<p>模式的描述和其他软件要求以及完成报告与 8.3.5 节中描述的填充操作相同。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103824939.png" class="" title="image-20240919103824939">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919103832405.png" class="" title="image-20240919103832405">

<h4 id="8-3-20-5-域间比较"><a href="#8-3-20-5-域间比较" class="headerlink" title="8.3.20.5 域间比较"></a>8.3.20.5 域间比较</h4><p>域间比较操作 0x25 将源 1 地址处的内存与源 2 地址处的内存进行比较。源 1 或源 2 地址中至少有一个必须具有 IDPT 句柄，并且必须引用域间权限表条目，该条目属于第 3.14.1 节中指定的类型之一。</p>
<p>软件通过设置下表中描述的至少一个标志来实现此目的。</p>
<p>完成记录格式在第 8.3.20.2 节中描述。</p>
<p>此操作的结果报告与第 8.3.6 节中描述的比较操作相同。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919103905812.png" class="" title="image-20240919103905812">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919103912256.png" class="" title="image-20240919103912256">

<h4 id="8-3-20-6-域间比较模式"><a href="#8-3-20-6-域间比较模式" class="headerlink" title="8.3.20.6 域间比较模式"></a>8.3.20.6 域间比较模式</h4><p>域间比较模式操作 0x26 将源地址处的内存与模式字段中的值进行比较。源地址必须使用 IDPT 句柄进行限定，并且必须引用 3.14.1 节中指定的类型之一的域间权限表条目。</p>
<p>完成记录格式在 8.3.20.2 节中描述。</p>
<p> 描述符中的模式描述以及此操作的结果报告与 8.3.7 节中描述的比较模式操作相同。检查结果和预期结果的行为与 8.3.6 节中的比较操作相同。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919104125634.png" class="" title="image-20240919104125634">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919104134633.png" class="" title="image-20240919104134633">

<h4 id="8-3-20-7-域间缓存刷新"><a href="#8-3-20-7-域间缓存刷新" class="headerlink" title="8.3.20.7 域间缓存刷新"></a>8.3.20.7 域间缓存刷新</h4><p>域间缓存刷新操作 0x27 刷新目标地址处的处理器缓存。</p>
<p>目标地址必须使用 IDPT 句柄限定，并且必须引用域间权限表条目，该条目属于第 3.14.1 节中指定的类型之一。引用的 IDPTE 可以配置为启用读取或写入权限。</p>
<p>完成记录格式在第 8.3.20.2 节中描述。</p>
<p>该操作的其他细节与第 8.3.18 节中描述的缓存刷新操作相同。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919104213711.png" class="" title="image-20240919104213711">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919104225252.png" class="" title="image-20240919104225252">

<h4 id="8-3-20-8-更新窗口"><a href="#8-3-20-8-更新窗口" class="headerlink" title="8.3.20.8 更新窗口"></a>8.3.20.8 更新窗口</h4><p>更新窗口操作 0x21 原子地修改与指定的域间权限表条目关联的内存窗口的属性。描述符 PASID 必须与句柄引用的条目中的访问 PASID 匹配，并且条目中的允许更新位必须为 1。窗口基地址或窗口大小字段没有对齐要求。如果窗口标志中的窗口启用字段为 1，则描述符中的窗口基地址和窗口大小的总和必须小于或等于 264。如果窗口启用为 0，则描述符中的窗口模式、窗口基地址和窗口大小字段必须为 0。</p>
<p>如第 3.14.4 节所述，执行隐式耗尽以清除仍在使用更新前窗口属性的任何正在进行的描述符。软件可以使用抑制耗尽标志来避免隐式耗尽（如有必要）。</p>
<p>更新窗口描述符可能不包含在批处理中；它被视为不受支持的操作类型。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919104306156.png" class="" title="image-20240919104306156">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919104316353.png" class="" title="image-20240919104316353">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919104327669.png" class="" title="image-20240919104327669">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919104340085.png" class="" title="image-20240919104340085">

<h1 id="9-寄存器说明"><a href="#9-寄存器说明" class="headerlink" title="9 寄存器说明"></a>9 寄存器说明</h1><p>英特尔数据流加速器的编程接口由 PCI 配置寄存器和 MMIO 寄存器组成，其中包括配置和控制寄存器以及工作提交门户。MMIO 寄存器和门户的基地址由 PCI 配置空间中的两个基地址寄存器 (BAR) 指定。</p>
<p>PCI 配置空间访问必须以对齐的 1 字节、2 字节或 4 字节访问执行。有关访问 PCI 配置空间中未实现的寄存器和保留位的规则，请参阅第 1.2 节中列出的 PCI Express 基本规范。</p>
<p><strong>MMIO 空间对 BAR0 区域（功能、配置和状态寄存器）的访问必须以对齐的 1 字节、2 字节、4 字节或 8 字节访问执行。</strong>软件可以对任何寄存器使用 8 字节访问，包括使用单个 8 字节访问访问两个相邻的 32 位寄存器。</p>
<p><strong>MMIO 空间对 BAR2 区域的访问必须以 64 字节访问的形式执行</strong>，如第 9.3 节所述。<br>本章使用以下缩写来表示寄存器属性。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919104458048.png" class="" title="image-20240919104458048">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919104508760.png" class="" title="image-20240919104508760">

<h2 id="9-1-PCI-配置空间寄存器"><a href="#9-1-PCI-配置空间寄存器" class="headerlink" title="9.1 PCI 配置空间寄存器"></a>9.1 PCI 配置空间寄存器</h2><p>本节提供了有关某些 PCI 配置寄存器的 Intel DSA 特定细节。请参阅附录 C 和第 1.2 节中列出的 PCI Express 规范，了解这些寄存器的完整规范。</p>
<h3 id="9-1-1-基地址寄存器（BAR）"><a href="#9-1-1-基地址寄存器（BAR）" class="headerlink" title="9.1.1 基地址寄存器（BAR）"></a>9.1.1 基地址寄存器（BAR）</h3><p>Intel DSA PCI配置空间实现了两个64位BAR。</p>
<h4 id="9-1-1-1-BAR0（设备控制寄存器）"><a href="#9-1-1-1-BAR0（设备控制寄存器）" class="headerlink" title="9.1.1.1 BAR0（设备控制寄存器）"></a>9.1.1.1 BAR0（设备控制寄存器）</h4><p>BAR0 是一个 64 位 BAR，包含设备控制寄存器的物理基址。这些寄存器提供有关设备功能、配置和启用设备的控制以及设备状态的信息。这些寄存器将在以下章节中更详细地描述。BAR0 区域的大小取决于具体的设备实现，至少为 64KB。</p>
<h4 id="9-1-1-2-BAR2（Portals）"><a href="#9-1-1-2-BAR2（Portals）" class="headerlink" title="9.1.1.2 BAR2（Portals）"></a>9.1.1.2 BAR2（Portals）</h4><p>BAR2 是一个 64 位 BAR，其中包含用于向设备提交描述符的门户的物理基址。每个门户的大小为 64 字节，位于单独的 4 KB 页面上。这样，可以使用 CPU 页表将门户独立映射到不同的地址空间。</p>
<p>每个 WQ 有 4 个门户，如第 3.3 节所述。因此，例如，如果设备支持 8 个 WQ，则 BAR2 的大小将为 8 × 4 × 4 KB &#x3D; 128 KB。如果大小不是 2 的幂，则 BAR2 的总大小将四舍五入为下一个 2 的幂。</p>
<p>对 BAR2 区域内不对应于 WQ 门户的地址的任何写入都将被忽略；对于 DMWr，将返回重试响应。对 BAR2 地址空间的任何读取操作都会为所有字节返回 0x00 或 0xFF。</p>
<h3 id="9-1-2-MSI-X-功能"><a href="#9-1-2-MSI-X-功能" class="headerlink" title="9.1.2 MSI-X 功能"></a>9.1.2 MSI-X 功能</h3><p>MSI-X 是英特尔 DSA 提供的唯一 PCI Express 中断功能。它不实现传统 PCI 中断或 MSI。此寄存器结构的详细信息位于 PCI Express 规范中。有关如何使用 MSI-X 表的信息，请参阅第 3.7 节。</p>
<h3 id="9-1-3-地址转换功能"><a href="#9-1-3-地址转换功能" class="headerlink" title="9.1.3 地址转换功能"></a>9.1.3 地址转换功能</h3><p>三种 PCI Express 功能控制地址转换。如果在设备未禁用的情况下通过软件更改了其中任何一项功能，则设备将进入暂停状态，并在软件错误寄存器中报告错误。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919104832619.png" class="" title="image-20240919104832619">

<h4 id="9-1-3-1-PASID-能力"><a href="#9-1-3-1-PASID-能力" class="headerlink" title="9.1.3.1 PASID 能力"></a>9.1.3.1 PASID 能力</h4><p>软件配置 PASID 功能以控制设备是否使用 PASID 执行地址转换。如果禁用 PASID，则不支持共享虚拟内存 (SVM)，只能使用专用 WQ (DWQ)，并且设备不能在多个 VM 之间共享。必须始终启用 PASID 才能使用共享 WQ (SWQ)。如果启用了 PASID，则根据 IOMMU 配置使用 PASID 执行地址转换。</p>
<h4 id="9-1-3-2-ATS-能力"><a href="#9-1-3-2-ATS-能力" class="headerlink" title="9.1.3.2 ATS 能力"></a>9.1.3.2 ATS 能力</h4><p>软件配置 ATS 功能以控制设备是否应在执行内存访问之前转换地址。如果在 IOMMU 中启用了地址转换，则必须在设备中启用 ATS 才能获得可接受的系统性能。如果启用了设备 ATS 功能，并且 WQCAP 中的 WQ ATS 支持为 1，则软件可以通过设置 WQCFG 中的 WQ ATS 禁用（如第 9.2.24 节所述）来选择性地为每个 WQ 单独禁用 ATS。如果在 IOMMU 中未启用地址转换，则必须禁用 ATS。如果禁用 ATS，则所有内存访问都使用未转换访问执行。</p>
<h4 id="9-1-3-3-PRS-能力"><a href="#9-1-3-3-PRS-能力" class="headerlink" title="9.1.3.3 PRS 能力"></a>9.1.3.3 PRS 能力</h4><p>软件配置 PRS 功能以控制设备在地址转换失败时是否可以请求页面。如果启用了设备 PRS 功能，并且 WQCAP 中的 WQ PRS Support 为 1，则软件可以通过设置 WQCFG 中的 WQ PRS Disable 来选择性地为每个 WQ 单独禁用 PRS 的使用（如第 9.2.24 节所述）。</p>
<h3 id="9-1-4-可扩展的-I-O-虚拟化能力"><a href="#9-1-4-可扩展的-I-O-虚拟化能力" class="headerlink" title="9.1.4 可扩展的 I&#x2F;O 虚拟化能力"></a>9.1.4 可扩展的 I&#x2F;O 虚拟化能力</h3><p>可扩展 I&#x2F;O 虚拟化功能在英特尔® 可扩展 I&#x2F;O 虚拟化架构规范中定义。它表示英特尔 DSA 支持可扩展 IOV。字段填写如下：</p>
<p>函数依赖关系链接     &lt;self&gt; </p>
<p>标志                           0 </p>
<p>支持的页面大小         1 </p>
<p>系统页面大小             1 </p>
<p>IMS                             如果支持 IMS，则为 1；否则为 0。</p>
<h3 id="9-1-5-VC-能力"><a href="#9-1-5-VC-能力" class="headerlink" title="9.1.5 VC 能力"></a>9.1.5 VC 能力</h3><p>如果存在 PCIe VC 功能，软件将配置 PCI Express VC 功能中的 TC&#x2F;VC 映射，以控制不同流量类别到相应平台和内部 I&#x2F;O 结构资源的映射。流量类别的使用在第 4.2 节中有更详细的描述。</p>
<h2 id="9-2-配置和控制寄存器（BAR0）"><a href="#9-2-配置和控制寄存器（BAR0）" class="headerlink" title="9.2 配置和控制寄存器（BAR0）"></a>9.2 配置和控制寄存器（BAR0）</h2><img src="/2024/09/13/Intel-DSA-spec/image-20240919105431089.png" class="" title="image-20240919105431089">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919105628122.png" class="" title="image-20240919105628122">

<blockquote>
<p>1 显示的偏移量只是示例。此表的实际偏移量在表偏移量寄存器中给出。<br>2 显示的偏移量只是示例。此表的实际偏移量在 PCIe MSI-X 功能中给出。</p>
</blockquote>
<p>MMIO空间寄存器的初始值如下：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919105737220.png" class="" title="image-20240919105737220">

<blockquote>
<p>如果GENCAP中的配置支持字段为0，则WQ配置和组配置寄存器的初始值反映组和WQ的固定配置。</p>
</blockquote>
<p>以下 MMIO 空间寄存器在所述条件下是只读的：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919105816519.png" class="" title="image-20240919105816519">

<h3 id="9-2-1-版本寄存器（VERSION）"><a href="#9-2-1-版本寄存器（VERSION）" class="headerlink" title="9.2.1 版本寄存器（VERSION）"></a>9.2.1 版本寄存器（VERSION）</h3><p>版本寄存器报告设备支持的架构规范的版本。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919105906256.png" class="" title="image-20240919105906256">

<h3 id="9-2-2-通用功能寄存器（GENCAP）"><a href="#9-2-2-通用功能寄存器（GENCAP）" class="headerlink" title="9.2.2 通用功能寄存器（GENCAP）"></a>9.2.2 通用功能寄存器（GENCAP）</h3><img src="/2024/09/13/Intel-DSA-spec/image-20240919110214953.png" class="" title="image-20240919110214953">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919110231094.png" class="" title="image-20240919110231094">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919110246581.png" class="" title="image-20240919110246581">

<h3 id="9-2-3-WQ-功能寄存器（WQCAP）"><a href="#9-2-3-WQ-功能寄存器（WQCAP）" class="headerlink" title="9.2.3 WQ 功能寄存器（WQCAP）"></a>9.2.3 WQ 功能寄存器（WQCAP）</h3><img src="/2024/09/13/Intel-DSA-spec/image-20240919110310341.png" class="" title="image-20240919110310341">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919110318210.png" class="" title="image-20240919110318210">

<h3 id="9-2-4-组能力寄存器（GRPCAP）"><a href="#9-2-4-组能力寄存器（GRPCAP）" class="headerlink" title="9.2.4 组能力寄存器（GRPCAP）"></a>9.2.4 组能力寄存器（GRPCAP）</h3><img src="/2024/09/13/Intel-DSA-spec/image-20240919110335289.png" class="" title="image-20240919110335289">

<h3 id="9-2-5-发动机能力寄存器（ENGCAP）"><a href="#9-2-5-发动机能力寄存器（ENGCAP）" class="headerlink" title="9.2.5 发动机能力寄存器（ENGCAP）"></a>9.2.5 发动机能力寄存器（ENGCAP）</h3><img src="/2024/09/13/Intel-DSA-spec/image-20240919110355435.png" class="" title="image-20240919110355435">

<h3 id="9-2-6-操作能力寄存器（OPCAP）"><a href="#9-2-6-操作能力寄存器（OPCAP）" class="headerlink" title="9.2.6 操作能力寄存器（OPCAP）"></a>9.2.6 操作能力寄存器（OPCAP）</h3><p>操作能力寄存器指示设备支持哪些操作类型。该寄存器是一个位掩码，其中每个位对应于操作类型，其代码与位位置相同。例如，此寄存器的位 0 对应于无操作操作（代码 0）。有关操作代码的值，请参阅第 8.1 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919110417459.png" class="" title="image-20240919110417459">

<h3 id="9-2-7-表偏移寄存器（OFFSETS）"><a href="#9-2-7-表偏移寄存器（OFFSETS）" class="headerlink" title="9.2.7 表偏移寄存器（OFFSETS）"></a>9.2.7 表偏移寄存器（OFFSETS）</h3><p>硬件实现可以将配置表放置在 BAR0 MMIO 空间内任何未分配的地址范围内。此寄存器指示这些表的偏移量：组配置、WQ 配置、MSI-X 权限、IMS、性能监控和 IDPT。软件必须使用此寄存器中的值来确定这些表的偏移量，因为偏移量可能会因实现而异。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919110441286.png" class="" title="image-20240919110441286">

<h3 id="9-2-8-通用配置寄存器（GENCFG）"><a href="#9-2-8-通用配置寄存器（GENCFG）" class="headerlink" title="9.2.8 通用配置寄存器（GENCFG）"></a>9.2.8 通用配置寄存器（GENCFG）</h3><p>当设备禁用时，此寄存器是读写的，否则为只读。如果 GENCAP 中的配置支持字段为 0，则它始终为只读。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919110503166.png" class="" title="image-20240919110503166">

<h3 id="9-2-9-通用控制寄存器（GENCTRL）"><a href="#9-2-9-通用控制寄存器（GENCTRL）" class="headerlink" title="9.2.9 通用控制寄存器（GENCTRL）"></a>9.2.9 通用控制寄存器（GENCTRL）</h3><img src="/2024/09/13/Intel-DSA-spec/image-20240919110521775.png" class="" title="image-20240919110521775">

<h3 id="9-2-10-通用状态寄存器（GENSTS）"><a href="#9-2-10-通用状态寄存器（GENSTS）" class="headerlink" title="9.2.10 通用状态寄存器（GENSTS）"></a>9.2.10 通用状态寄存器（GENSTS）</h3><img src="/2024/09/13/Intel-DSA-spec/image-20240919110539006.png" class="" title="image-20240919110539006">

<h3 id="9-2-11-中断原因寄存器（INTCAUSE）"><a href="#9-2-11-中断原因寄存器（INTCAUSE）" class="headerlink" title="9.2.11 中断原因寄存器（INTCAUSE）"></a>9.2.11 中断原因寄存器（INTCAUSE）</h3><p>中断原因寄存器用于指示使用 MSI-X 表中的条目 0 生成中断的原因。对于使用其他 MSI-X 表条目或任何 IMS 条目生成的中断，不存在单独的原因寄存器。在后一种情况下，软件可以根据中断向量或通过读取与原因相关的位置（例如完成记录地址或 WQ 占用寄存器）来识别中断的原因。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919110558930.png" class="" title="image-20240919110558930">

<h3 id="9-2-12-命令寄存器（CMD）"><a href="#9-2-12-命令寄存器（CMD）" class="headerlink" title="9.2.12 命令寄存器（CMD）"></a>9.2.12 命令寄存器（CMD）</h3><p>命令寄存器用于提交管理命令。在写入此寄存器之前，软件必须通过检查命令状态寄存器的 Active 字段来确保先前通过此寄存器提交的任何命令都已完成。提交命令时，命令状态寄存器的 Active 字段设置为 1。命令完成后，Active 字段更改为 0。命令状态寄存器的其他字段指示命令是否成功完成。如果在 Active 为 1 时写入命令寄存器，则写入的值将被丢弃，并在 SWERROR 寄存器中记录错误。读取命令寄存器将返回不可预测的值。</p>
<p>当命令完成时，如果命令寄存器的请求完成中断字段为 1，则中断原因寄存器的命令完成字段设置为 1，并使用 MSI-X 表中的条目 0 生成中断。</p>
<p>命令功能寄存器 (9.2.14) 指示实现支持表 9-5 中列出的哪些命令。如果将未定义或不受支持的命令写入命令寄存器，则命令状态寄存器中会报告错误代码 0x01。</p>
<p>有关提交给命令寄存器的命令的操作的详细信息，请参阅第 3.13.3 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111006252.png" class="" title="image-20240919111006252">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919111023634.png" class="" title="image-20240919111023634">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919111051529.png" class="" title="image-20240919111051529">

<blockquote>
<p>1 本节中的术语“组”不应与第 3.4 节中描述的引擎组相混淆。对于发出 WQ 命令，组仅由 WQ 编号的 7:4 位相同的 WQ 组成</p>
</blockquote>
<p>禁用 WQ、清除 WQ、中止 WQ 和重置 WQ 命令可同时应用于最多 16 个 WQ 的组 1。组号在操作数字段的位 19:16 中指定，对应于 WQ 索引的位 7:4。操作数字段的位 15:0 包含一个位掩码，指示要对组中的哪些 WQ 进行操作。在 WQ 不超过 16 个的实现中，组号始终为 0。例如，要清除 WQ 1、4 和 7，操作数字段应设置为 0x00092。要清除 WQ 21 和 22，操作数字段应设置为 0x10060。无法使用单个命令禁用或清除不同组中的 WQ。</p>
<h3 id="9-2-13-命令状态寄存器（CMDSTATUS）"><a href="#9-2-13-命令状态寄存器（CMDSTATUS）" class="headerlink" title="9.2.13 命令状态寄存器（CMDSTATUS）"></a>9.2.13 命令状态寄存器（CMDSTATUS）</h3><p>命令状态寄存器指示提交给命令寄存器的最后一个命令的状态。</p>
<p>Active 字段指示命令正在进行中。当命令写入命令寄存器时，Active 字段设置为 1。当 Active 字段为 1 时，其他字段的值未指定。当命令完成时，Active 字段设置为 0，该寄存器的其他字段指示命令是否成功完成</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111141229.png" class="" title="image-20240919111141229">

<h3 id="9-2-14-命令功能寄存器（CMDCAP）"><a href="#9-2-14-命令功能寄存器（CMDCAP）" class="headerlink" title="9.2.14 命令功能寄存器（CMDCAP）"></a>9.2.14 命令功能寄存器（CMDCAP）</h3><p>命令功能寄存器指示命令寄存器支持哪些管理命令。此寄存器是一个位掩码，其中每个位对应于命令，其命令代码与位位置相同。例如，此寄存器的位 1 对应于启用设备命令（命令代码 1）。有关命令代码的值，请参阅表 9-5。</p>
<p>仅当 GENCAP 中的命令功能支持字段为 1 时，此寄存器才存在。</p>
<p>如果此寄存器指示支持请求中断句柄命令，则必须使用该命令来获取用于描述符完成的中断句柄。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111214732.png" class="" title="image-20240919111214732">

<p>如果命令功能支持为 0，则此寄存器不存在，并且支持以下命令：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111226654.png" class="" title="image-20240919111226654">

<h3 id="9-2-15-软件错误寄存器（SWERROR）"><a href="#9-2-15-软件错误寄存器（SWERROR）" class="headerlink" title="9.2.15 软件错误寄存器（SWERROR）"></a>9.2.15 软件错误寄存器（SWERROR）</h3><p>此寄存器中可以记录几种类型的错误：</p>
<ul>
<li>• 提交描述符时出错。</li>
<li>• 转换描述符中的完成记录地址时出错。</li>
<li>• 如果描述符中的完成记录地址有效标志为 0，则验证描述符时出错。</li>
<li>• 如果描述符中的完成记录地址有效标志为 0，则处理描述符时出错，例如页面错误。</li>
<li>• 在设备未禁用时对设备配置进行不支持的更改。</li>
</ul>
<p>第 5 章介绍了可能导致这些错误的错误检查的详细信息。</p>
<p>此寄存器中一次只能记录一个错误。记录错误时，Valid 设置为 1。如果发生错误时 Valid 为 1，则 Overflow 设置为 1，并且不记录错误。Valid 和 Overflow 字段通过软件写入 1 来清除。除复位外，它们不能通过硬件清除。当支持时，事件日志可用于报告多个错误而不会溢出（如第 5.9 节所述）。</p>
<p>当 Valid 从 0 变为 1 时，如果 GENCTRL 中的软件错误中断启用字段为 1，则中断原因寄存器的软件错误字段设置为 1，并生成中断。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111342909.png" class="" title="image-20240919111342909">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919111405334.png" class="" title="image-20240919111405334">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919111425525.png" class="" title="image-20240919111425525">

<h3 id="9-2-16-事件日志配置寄存器（EVLCFG）"><a href="#9-2-16-事件日志配置寄存器（EVLCFG）" class="headerlink" title="9.2.16 事件日志配置寄存器（EVLCFG）"></a>9.2.16 事件日志配置寄存器（EVLCFG）</h3><p>事件日志配置寄存器用于配置和管理硬件用来报告多种错误事件的内存区域。第 5.9 节介绍了事件日志的功能细节。事件日志条目的大小由 GENCAP 中的事件日志支持字段指示。</p>
<p>当设备禁用时，此寄存器是可读写的，否则为只读。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111518450.png" class="" title="image-20240919111518450">

<h3 id="9-2-17-事件日志状态寄存器（EVLSTATUS）"><a href="#9-2-17-事件日志状态寄存器（EVLSTATUS）" class="headerlink" title="9.2.17 事件日志状态寄存器（EVLSTATUS）"></a>9.2.17 事件日志状态寄存器（EVLSTATUS）</h3><p>如果 GENCFG 中启用的事件日志为 1，则在成功完成启用设备命令后将清除此寄存器。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111538299.png" class="" title="image-20240919111538299">

<h3 id="9-2-18-域间能力寄存器（IDCAP）"><a href="#9-2-18-域间能力寄存器（IDCAP）" class="headerlink" title="9.2.18 域间能力寄存器（IDCAP）"></a>9.2.18 域间能力寄存器（IDCAP）</h3><p>IDCAP 寄存器描述与设备中的域间操作支持相关的功能。如果 GENCAP 中的域间支持为 1，则此寄存器存在。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111607576.png" class="" title="image-20240919111607576">

<h3 id="9-2-19-域间位图寄存器（IDBR）"><a href="#9-2-19-域间位图寄存器（IDBR）" class="headerlink" title="9.2.19 域间位图寄存器（IDBR）"></a>9.2.19 域间位图寄存器（IDBR）</h3><p>如果 GENCAP 中的域间支持字段为 1，并且 IDCAP 中的类型支持字段中设置了位 1，则域间位图寄存器用于指定用于读取 IDPT 引用的位图的 PASID 和权限。否则，此寄存器被保留。当设备被禁用时，此寄存器是读写的，否则是只读的。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111629911.png" class="" title="image-20240919111629911">

<h3 id="9-2-20-命令参数寄存器（CMDPARAM）"><a href="#9-2-20-命令参数寄存器（CMDPARAM）" class="headerlink" title="9.2.20 命令参数寄存器（CMDPARAM）"></a>9.2.20 命令参数寄存器（CMDPARAM）</h3><p>命令参数寄存器用于指定管理命令的附加参数。</p>
<p>此寄存器的使用取决于发出的具体命令。有关使用 CMDPARAM 寄存器的命令的详细信息，请参阅第 9.2.12 节。硬件只能实现寄存器中由 CMDCAP 支持的命令使用的位。软件不得依赖未实现位的值。</p>
<p>读取未实现的位可能会返回 0，写入未实现的位可能会被丢弃。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111655942.png" class="" title="image-20240919111655942">

<h3 id="9-2-21-虚拟门户（DUMMY）"><a href="#9-2-21-虚拟门户（DUMMY）" class="headerlink" title="9.2.21 虚拟门户（DUMMY）"></a>9.2.21 虚拟门户（DUMMY）</h3><p>虚拟门户的行为类似于未启用的 WQ 的门户。对于页面上的所有地址，写入都会被忽略（对 DMWr 返回 Retry），读取会对所有字节返回 00 或 FF。有关门户的更多信息，请参阅第 9.3 节。有关此寄存器如何用于虚拟化，请参阅第 7.3 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111718412.png" class="" title="image-20240919111718412">

<h3 id="9-2-22-MSI-X-权限表-MSIXPERM"><a href="#9-2-22-MSI-X-权限表-MSIXPERM" class="headerlink" title="9.2.22 MSI-X 权限表 (MSIXPERM)"></a>9.2.22 MSI-X 权限表 (MSIXPERM)</h3><p>MSI-X 权限表是 BAR0 中的一组 4 字节寄存器，其条目数与 MSI-X 表相同。MSI-X 权限表的偏移量由表偏移量寄存器中的 MSI-X 权限偏移量字段给出。条目数由 PCIe 定义的 MSI-X 功能给出。表中的各个寄存器位于 8 字节边界上。</p>
<p>MSI-X 权限表中的每个寄存器对应于 MSI-X 表中的一个条目，并包含与该中断表条目相关的控件。这些控件与 IMS 中的控件相同，但这些字段不能添加到 MSI-X 表本身，因为它是由 PCI-SIG 定义的。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111744301.png" class="" title="image-20240919111744301">

<h3 id="9-2-23-组配置表（GRPCFG）"><a href="#9-2-23-组配置表（GRPCFG）" class="headerlink" title="9.2.23 组配置表（GRPCFG）"></a>9.2.23 组配置表（GRPCFG）</h3><p>组配置表是 BAR0 中的寄存器数组，用于控制工作队列到引擎的映射。组配置表的偏移量由表偏移量寄存器中的组配置偏移量字段给出。组数由 GRPCAP 中的组数字段给出。</p>
<p>软件可以配置所需的组数。超出可用组数的组配置寄存器将被保留，并且可能无法在硬件中实现。</p>
<p>每个活动组包含一个或多个工作队列和一个或多个引擎。任何未使用的组的 WQs 字段和引擎字段都必须等于 0。提交给组中任何 WQ 的描述符都可以由该组中的任何引擎处理。每个活动工作队列都必须位于单个组中。（活动工作队列是相应 WQCFG 寄存器的 WQ 大小字段非零的队列。）任何不在组中的引擎都是非活动的。有关引擎和组的更多信息，请参见第 3.4 节。</p>
<p>每个 GRPCFG 寄存器分为三个子寄存器。</p>
<p>当设备禁用时，这些寄存器是可读写的，否则为只读。如果 GENCAP 中的配置支持字段为 0，则它们始终为只读。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919111831651.png" class="" title="image-20240919111831651">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919111851352.png" class="" title="image-20240919111851352">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919111911459.png" class="" title="image-20240919111911459">

<h3 id="9-2-24-WQ配置表（WQCFG）"><a href="#9-2-24-WQ配置表（WQCFG）" class="headerlink" title="9.2.24 WQ配置表（WQCFG）"></a>9.2.24 WQ配置表（WQCFG）</h3><p>WQ 配置表是 BAR0 中的寄存器数组。WQ 配置表的偏移量由表偏移量寄存器中的 WQ 配置偏移量字段给出。WQ 的数量由 WQCAP 中的 WQ 数量字段给出。每个 WQ 的 WQCFG 寄存器的大小由 WQCAP 中的 WQCFG 大小字段给出。大小为 2 N+5 字节，其中 N 是 WQCFG 大小字段的值。</p>
<p>每个 WQCFG 寄存器分为子寄存器，可以使用对齐的 1、2、4 或 8 字节读取或写入操作进行读取或写入。WQCFG 的字段在不同时间是只读还是可读写，具体取决于设备状态、WQ 状态、GENCAP 中的配置支持字段和 WQ 模式支持字段，如表中所述。在字段为只读时对字段的任何写入都将被忽略。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112002823.png" class="" title="image-20240919112002823">

<p>在启用设备之前，必须设置所有 WQCFG 寄存器的 WQ 大小字段。所有 WQ 大小字段的总和不得大于 WQCAP 中的总 WQ 大小字段。WQ 大小字段为 0 的 WQ 处于非活动状态，无法启用。非活动 WQ 的其他配置字段将被忽略。</p>
<p>启用 WQ 时，将对 WQCFG 寄存器的字段执行一致性检查。有关执行的检查，请参阅第 5.2 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112031251.png" class="" title="image-20240919112031251">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919112052089.png" class="" title="image-20240919112052089">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919112126932.png" class="" title="image-20240919112126932">

<blockquote>
<p>1 本节中的表 9-7 描述了该字段何时为 RW，何时为 RO。</p>
</blockquote>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112146810.png" class="" title="image-20240919112146810">

<blockquote>
<p>1 当 Enable 为 1 时，若要更改 Limit，软件必须先将 0 写入 Enable。然后，可以向 Limit 写入新值，同时将 Enable 重新设置为 1。</p>
</blockquote>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112224989.png" class="" title="image-20240919112224989">

<blockquote>
<p>1 本节中的表 9-7 描述了该字段何时为 RW，何时为 RO。</p>
</blockquote>
<h3 id="9-2-25-性能监控寄存器"><a href="#9-2-25-性能监控寄存器" class="headerlink" title="9.2.25 性能监控寄存器"></a>9.2.25 性能监控寄存器</h3><p>性能监控寄存器是 BAR0 中的一组寄存器，用于发现功能、配置和控制英特尔 DSA 中的性能监控功能。功能寄存器包括全局性能监控功能寄存器 (PERFCAP) 和用于描述每个事件类别 (EVNTCAP) 以及可选的每个计数器 (CNTRCAP) 功能的寄存器。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112327298.png" class="" title="image-20240919112327298">

<h4 id="9-2-25-1-性能监控能力寄存器（PERFCAP）"><a href="#9-2-25-1-性能监控能力寄存器（PERFCAP）" class="headerlink" title="9.2.25.1 性能监控能力寄存器（PERFCAP）"></a>9.2.25.1 性能监控能力寄存器（PERFCAP）</h4><img src="/2024/09/13/Intel-DSA-spec/image-20240919112342413.png" class="" title="image-20240919112342413">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919112351466.png" class="" title="image-20240919112351466">

<h4 id="9-2-25-2-性能监控事件功能寄存器（EVNTCAP）"><a href="#9-2-25-2-性能监控事件功能寄存器（EVNTCAP）" class="headerlink" title="9.2.25.2 性能监控事件功能寄存器（EVNTCAP）"></a>9.2.25.2 性能监控事件功能寄存器（EVNTCAP）</h4><p>每个 EVNTCAP 寄存器对应一个事件类别，并报告该事件类别支持的事件集。EVNTCAP 寄存器的数量与 PERFCAP 中报告的事件类别数量相对应。例如，如果定义的事件类别数量为 5，则将有五个 EVNTCAP 寄存器，即 EVNTCAP_0、EVNTCAP_1 等，每个事件类别一个。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112414461.png" class="" title="image-20240919112414461">

<h4 id="9-2-25-3-性能监控计数器功能寄存器（CNTRCAP）"><a href="#9-2-25-3-性能监控计数器功能寄存器（CNTRCAP）" class="headerlink" title="9.2.25.3 性能监控计数器功能寄存器（CNTRCAP）"></a>9.2.25.3 性能监控计数器功能寄存器（CNTRCAP）</h4><p>CNTRCAP 寄存器报告每个计数器允许的事件类别和事件。对事件类别到计数器的映射没有任何限制的实现不支持这些寄存器。仅当 PERFCAP 中的“每个计数器支持的功能”字段为 1 时，这些寄存器才会存在。</p>
<p>如果存在，这些功能寄存器的数量与 PERFCAP 中报告的性能监控计数器寄存器的数量相对应。每个功能寄存器中指定的值仅适用于相应的计数器，并覆盖 PERFCAP 中指定的值。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112441641.png" class="" title="image-20240919112441641">

<h4 id="9-2-25-4-性能监控复位控制寄存器（PERFRST）"><a href="#9-2-25-4-性能监控复位控制寄存器（PERFRST）" class="headerlink" title="9.2.25.4 性能监控复位控制寄存器（PERFRST）"></a>9.2.25.4 性能监控复位控制寄存器（PERFRST）</h4><p>软件可以使用 PERFRST 寄存器将所有性能监控配置和数据寄存器重置为其默认值。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112500461.png" class="" title="image-20240919112500461">

<h4 id="9-2-25-5-性能监控溢出状态寄存器（OVFSTATUS）"><a href="#9-2-25-5-性能监控溢出状态寄存器（OVFSTATUS）" class="headerlink" title="9.2.25.5 性能监控溢出状态寄存器（OVFSTATUS）"></a>9.2.25.5 性能监控溢出状态寄存器（OVFSTATUS）</h4><p>OVFSTATUS 是一个寄存器，用于指示所有支持的性能监控计数器的状态。PERFCAP 寄存器中报告的计数器数量以外的任何位都将报告为 0，并且应被软件忽略。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112519226.png" class="" title="image-20240919112519226">

<h4 id="9-2-25-6-性能监控冻结寄存器（PERFFRZ）"><a href="#9-2-25-6-性能监控冻结寄存器（PERFFRZ）" class="headerlink" title="9.2.25.6 性能监控冻结寄存器（PERFFRZ）"></a>9.2.25.6 性能监控冻结寄存器（PERFFRZ）</h4><p>PERFFRZ 寄存器可供软件用来控制冻结行为并监控所有性能监控计数器的冻结状态。仅当 PERFCAP 中的计数器冻结支持字段为 1 时，此寄存器才存在。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112538641.png" class="" title="image-20240919112538641">

<h4 id="9-2-25-7-计数器配置寄存器（CNTRCFG）"><a href="#9-2-25-7-计数器配置寄存器（CNTRCFG）" class="headerlink" title="9.2.25.7 计数器配置寄存器（CNTRCFG）"></a>9.2.25.7 计数器配置寄存器（CNTRCFG）</h4><p>CNTRCFG 寄存器指定每个计数器要监视的事件集。它们还控制中断生成行为和溢出时的行为。CNTRCFG 寄存器的数量与 PERFCAP 中指定的计数器寄存器数量相对应。这些寄存器的默认值为 0。启用计数器时，除 Enable 之外的所有字段都是只读的。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112603309.png" class="" title="image-20240919112603309">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919112619601.png" class="" title="image-20240919112619601">

<h4 id="9-2-25-8-滤波器配置寄存器（FLTCFG）"><a href="#9-2-25-8-滤波器配置寄存器（FLTCFG）" class="headerlink" title="9.2.25.8 滤波器配置寄存器（FLTCFG）"></a>9.2.25.8 滤波器配置寄存器（FLTCFG）</h4><p>每个计数器支持一组过滤器配置寄存器，每个过滤器在表 6-2 中定义一个。</p>
<p>软件可以使用要应用于该计数器的过滤器值对一个或多个过滤器配置寄存器进行编程。例如，FLTCFG_WQ_0 选择要监视计数器 0 中的事件的 WQ，FLTCFG_TC_2 选择要监视计数器 2 中的事件的流量类别，依此类推。每个 FLTCFG 寄存器的默认值均为 1，这意味着该过滤器不施加任何约束。表 9-9 显示了与每个计数器关联的过滤器配置寄存器组的寄存器偏移量示例。</p>
<p>当启用相应的计数器时，此寄存器是只读的。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112647434.png" class="" title="image-20240919112647434">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919112658625.png" class="" title="image-20240919112658625">

<h4 id="9-2-25-9-计数器数据寄存器（CNTRDATA）"><a href="#9-2-25-9-计数器数据寄存器（CNTRDATA）" class="headerlink" title="9.2.25.9 计数器数据寄存器（CNTRDATA）"></a>9.2.25.9 计数器数据寄存器（CNTRDATA）</h4><p>每个 CNTRDATA 寄存器都是一个 N 位计数器，用于对配置事件的发生进行计数，其中 N 是 PERFCAP 中计数器宽度字段的值。软件对这些寄存器的读写行为在第 6.3 节中描述。写入后，计数器将继续从写入的值开始递增。冻结操作会导致计数器停止累积进一步的事件并保留冻结时的值。解冻操作允许计数器恢复对后续事件进行计数。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919112756928.png" class="" title="image-20240919112756928">

<h3 id="9-2-26-MSI-X-表"><a href="#9-2-26-MSI-X-表" class="headerlink" title="9.2.26 MSI-X 表"></a>9.2.26 MSI-X 表</h3><p>BAR0；偏移量：由 MSI-X 功能提供；大小：16 字节 × 条目数（2 × 64 位 × 条目数）。有关此表的详细信息，请参阅第 1.2 节中列出的 PCI Express 规范。偏移量和条目数在 MSI-X 功能中。有关如何使用 MSI-X 表的信息，请参阅第 3.7 节。</p>
<h3 id="9-2-27-MSI-X-待处理位阵列"><a href="#9-2-27-MSI-X-待处理位阵列" class="headerlink" title="9.2.27 MSI-X 待处理位阵列"></a>9.2.27 MSI-X 待处理位阵列</h3><p>BAR0；偏移量：由 MSI-X 功能提供；大小：⌈条目数 ÷ 64⌉ × 64 位。（请注意，上式中使用了上取整函数，将除法结果向上舍入为最接近的整数。）有关此表的详细信息，请参阅 1.2 节中列出的 PCI Express 规范。偏移量和条目数在 MSI-X 功能中。</p>
<h3 id="9-2-28-中断消息存储"><a href="#9-2-28-中断消息存储" class="headerlink" title="9.2.28 中断消息存储"></a>9.2.28 中断消息存储</h3><p>如果可扩展 IOV 功能中的中断消息存储支持字段为 1，则中断消息存储除了包含 PCI Express 规范中定义的 MSI-X 表中的中断消息外，还包含中断消息。此表的格式与 MSI-X 表的格式类似，不同之处在于：</p>
<ul>
<li>• 每个条目的待处理位位于控制字段中，而不是单独的待处理位数组中。</li>
<li>• 控制字段中定义了几个额外的控件。</li>
<li>• IMS 表的大小不限于 2048 个条目。（但是，此表的大小可能因不同的 Intel DSA 实现而异，并且可能小于 2048 个条目。）</li>
</ul>
<p>中断消息存储的偏移量由表偏移量寄存器中的 IMS 偏移量字段给出。条目数由 GENCAP 中的中断消息存储大小字段给出。有关如何使用此表的信息，请参阅第 3.7 节。</p>
<p>如果可扩展 IOV 功能中的中断消息存储支持字段为 0，则此表不存在。</p>
<p>消息地址的初始值为 00000000FEE00000h。如果写入 IMS 条目的消息地址字段的值在高 44 位中不包含 00000000FEEh，则忽略写入的值。<br>（保留先前存储的值。）写入消息地址的值的位 1:0 将被忽略。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919113009871.png" class="" title="image-20240919113009871">

<h3 id="9-2-29-域间权限表（IDPT）"><a href="#9-2-29-域间权限表（IDPT）" class="headerlink" title="9.2.29 域间权限表（IDPT）"></a>9.2.29 域间权限表（IDPT）</h3><p>如果 GENCAP 中的域间支持字段为 1，则域间权限表控制工作提交者和备用访问 PASID、相应权限以及允许访问的内存区域的映射。域间权限表的偏移量由表偏移量寄存器中的域间权限表偏移量字段给出。条目数由 IDCAP 中的域间权限表大小字段给出。有关如何使用此表的信息，请参阅第 3.14.1 节。如果 GENCAP 中的域间支持为 0，则此表不存在。表中每个条目的初始值为 0。</p>
<p>每个 32 字节域间权限表条目 (IDPTE) 分为四个 64 位子条目。IDPTE 的字段在不同时间是只读还是读写，具体取决于可用和允许更新字段，如表中所述。当字段为只读状态时，对字段的任何写入都会被忽略。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919113045068.png" class="" title="image-20240919113045068">

<blockquote>
<p>1 当允许更新为 1 时，即使该字段对于 MMIO 写入而言是只读的，也可以使用更新窗口描述符进行更新。</p>
</blockquote>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919113224863.png" class="" title="image-20240919113224863">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919113244601.png" class="" title="image-20240919113244601">

<h2 id="9-3-Portals（BAR2）"><a href="#9-3-Portals（BAR2）" class="headerlink" title="9.3 Portals（BAR2）"></a>9.3 Portals（BAR2）</h2><p>门户用于向设备提交描述符。门户位于 BAR2 指定的地址空间中。每个门户大小为 64 字节，位于单独的 4 KB 页面上。这样，可以使用 CPU 页表和扩展页表将门户独立映射到不同的地址空间。</p>
<p>每个 WQ 有四个门户，如图 9-2 所示。门户地址的位 5:0 必须为 0。位 11:6 被忽略；因此，页面上的任何 64 字节对齐的地址都可以使用相同的效果。</p>
<ul>
<li>向 SWQ 门户提交描述符必须使用 64 字节可延迟内存写入事务 (DMWr) 执行。任何其他对 SWQ 门户的写入操作都将被忽略。</li>
<li>向 DWQ 提交描述符必须使用 64 字节写入操作执行。</li>
</ul>
<p>在 Intel CPU 上，软件应使用 <strong>MOVDIR64B</strong> 指令生成非破坏性的 64 字节写入。对已禁用或专用 WQ 门户的 DMWr 事务将返回重试。</p>
<p><strong>对 DWQ 门户的任何其他写入操作都将被忽略。</strong></p>
<p>对 BAR2 地址空间的任何读取操作都会返回所有字节中的 0x00 或 0xFF。对 BAR 2 地址空间的读取不相对于对设备的任何其他事务排序，并且不能用于确保上游写入操作已完成。有关与门户访问相关的错误检查和报告的更多信息，请参阅第 5.3 节。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919113321434.png" class="" title="image-20240919113321434">

<img src="/2024/09/13/Intel-DSA-spec/image-20240919113340382.png" class="" title="image-20240919113340382">



<h1 id="附录-A-CRC-计算"><a href="#附录-A-CRC-计算" class="headerlink" title="附录 A CRC 计算"></a>附录 A CRC 计算</h1><p>Intel DSA 使用一种方法计算 CRC，该方法产生的结果与以下描述相匹配。</p>
<p>Intel DSA 使用多项式 0x11edc6f41 计算 32 位 CRC，遵循 iSCSI 协议 (RFC 3720) 中的规范。</p>
<p>对于 64 位 CRC，Intel DSA 使用多项式 0x1ad93d23594c93659。</p>
<p>以下描述改编自 RFC 3720。‘w’ 是 CRC 大小，可以是 32 或 64。‘n’ 是数据位数。当传输大小不是 w 位的倍数时，源数据将在末尾用零填充到 w 位的倍数。</p>
<ul>
<li>— 数据位被视为 n-1 度多项式 M(x) 的系数。数据第一个字节的最低有效位（位 0）是最高有效项 (xn-1 ) 的系数，后面是第一个字节的位 1，依此类推，直到最高编号字节 (x0 ) 的位 7。</li>
<li>— 数据的最高有效 w 位被求补。</li>
<li>— 多项式乘以 x ^w^，然后除以 G(x)。生成多项式产生次数为  w - 1 的余数 R(x)。</li>
<li>— R(x) 的系数被视为 w 位序列。</li>
<li>— 位序列被求补，结果为 CRC 值。</li>
<li>— CRC 值的位存储在完成记录的 CRC 值字段中，如下所示：x^w-1^ 系数存储在字段字节 0 的最低有效位（位 0）中，然后是位 1 中的 x ^w-2^ 系数，依此类推，直到 CRC 值字段最高有效字节的最高有效位（位 7）中的 x ^0^ 系数。</li>
</ul>
<p>描述符的 CRC 种子字段或从内存读取的 CRC 种子遵循完成记录中 CRC 值字段描述的相同字节&#x2F;位顺序。</p>
<p>英特尔 DSA 使用与英特尔® 64 和 IA-32 架构软件开发人员手册中描述的 CRC32 指令相同的多项式来计算 CRC。但是，希望交替使用这两种机制的软件必须注意 CRC 算法对 CRC 种子和结果的反转和反射的要求，以获得一致的结果。</p>
<h1 id="附录-B-数据完整性字段-DIF"><a href="#附录-B-数据完整性字段-DIF" class="headerlink" title="附录 B 数据完整性字段 (DIF)"></a>附录 B 数据完整性字段 (DIF)</h1><p>数据完整性字段 (DIF) 提供了一种系统解决方案，用于保护主机和存储设备之间的通信路径，以实现端到端数据完整性。企业级驱动器可以格式化为扇区大小，每个扇区包含额外的 8 个字节信息，可用于存储完整性信息。DIF 是作为在开放标准中使用这些额外字节的一种方式而引入的。</p>
<p>Intel DSA 对以 512B、520B、4096B 或 4104B 块组织的源数据块执行 DIF 计算。它可以检查、剥离、插入或更新源数据的保护标签、应用程序标签和参考标签字段，并将结果写入目标缓冲区。DIX 生成操作可用于从源数据生成保护标签、应用程序标签和参考标签字段，并将它们写入目标地址。</p>
<p>8 个字节的 DIF 信息分为以下几部分：</p>
<ul>
<li>• 16 位保护标签（数据的 CRC，使用多项式 0x18bb7）。</li>
<li>• 16 位应用标签。</li>
<li>• 32 位参考标签。</li>
</ul>
<p>保护标签保护扇区的数据部分。应用标签是不透明的存储信息。<br>参考标签可防止无序和错误定向的写入。标准化保护信息的内容使 I&#x2F;O 路径中的所有节点（包括磁盘本身）能够验证数据块的完整性。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919134157449.png" class="" title="image-20240919134157449">

<p>保护标签、应用标签和参考标签以最高有效字节在最低地址的方式存储在内存中；即采用大端格式。</p>
<h2 id="Reference-Tag"><a href="#Reference-Tag" class="headerlink" title="Reference Tag"></a>Reference Tag</h2><p>引用标记</p>
<p>引用标记由描述符中的引用标记种子字段初始化。标记可以是固定的，也可以是递增的。如果标记是固定的，则描述符中的种子将用于传输中的所有块。如果标记是递增的，则种子将用于传输中的第一个块，并且该值将随着传输中的每个后续块而递增一。如果增加标记值溢出标记的宽度，则它会回绕到 0。最终值将写入完成记录。（最终值是最后一个完成的块之后将用于该块的值。）</p>
<p>对于 DIF 更新操作，描述符中有单独的字段用于源引用标记种子和目标引用标记种子。有单独的标志来控制源和目标标记是固定的还是递增的。源标记字段用于确定源数据中的预期标记值，而目标标记字段用于确定要写入目标的标记值。但是，描述符中有一个标志可以强制将从源读取的引用标记值写入目标。在这种情况下，描述符中的目标标记字段将被忽略。</p>
<h2 id="Application-Tag"><a href="#Application-Tag" class="headerlink" title="Application Tag"></a>Application Tag</h2><p>应用程序标签</p>
<p>应用程序标签从描述符中的应用程序标签种子字段初始化。标签可以是固定的或递增的，最终值写入完成记录，类似于参考标签。应用程序标签掩码在使用前应用于应用程序标签值。标签值中与掩码中的 0 位相对应的位被保留，而标签值中与掩码中的 1 位相对应的位被强制为 0。如果应用程序标签正在递增，则在递增标签值后应用掩码。根据掩码中设置的位，递增标签值的效果可能会被屏蔽，导致相同的标签值用于多个块。为避免这种情况，应用程序标签掩码通常应设置为仅屏蔽高阶位。源应用程序标签掩码可以设置为 0xffff 以禁用应用程序标签检查。</p>
<p>对于 DIF 更新操作，描述符中有单独的字段来确定源和目标应用程序标签值，就像参考标签一样。源应用程序标签掩码和目标应用程序标签掩码也有单独的字段。对于参考标签，描述符中有一个标志，用于强制将从源读取的应用程序标签值写入目标。</p>
<h2 id="Guard-Tag"><a href="#Guard-Tag" class="headerlink" title="Guard Tag"></a>Guard Tag</h2><p>保护标签</p>
<p>保护标签是使用 T10 CRC 多项式根据源数据计算得出的：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919134745366.png" class="" title="image-20240919134745366">

<p>通常写为 0x18bb7</p>
<p>CRC 算法将源数据视为多项式 F(x)，其中源数据的每个位被视为多项式对应项的系数。F(x) 除以 G(x) 可得出余数 R(x)</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919134804392.png" class="" title="image-20240919134804392">

<p>CRC 是通过连接余数 R(x) 的各个项的系数来创建的。</p>
<p>使用以下两种方法之一检查源数据中的 Guard Tag：</p>
<ol>
<li><p>如上所述计算源数据的 CRC，并将其与源 DIF 中的 Guard Tag 进行比较。</p>
</li>
<li><p>将源 DIF 中的 Guard Tag 附加到源数据，计算余数，并检查余数是否为 0。</p>
</li>
</ol>
<p>这两种方法在数学上是等效的。</p>
<p>T10 CRC 种子的默认值为 0。为了使软件能够灵活地使用不同的种子，描述符的 DIF 标志字段中的“反转 CRC 种子”标志使 0xffff 被用作 CRC 种子。在执行 CRC 计算之前，源数据的前 16 位与种子进行异或运算。</p>
<p>反转 CRC 结果标志会导致在比较或存储保护标签之前反转计算的 CRC 值。</p>
<h2 id="B-1-DIF-检查"><a href="#B-1-DIF-检查" class="headerlink" title="B.1 DIF 检查"></a>B.1 DIF 检查</h2><p>DIF 检查操作用于检查源数据中数据完整性字段的有效性。执行 DIF 检查操作时，Intel DSA 对每个源数据块和相关 DIF 执行以下操作：</p>
<ul>
<li>• 可选计算保护标记并将其与源 DIF 值中的保护标记字段进行比较。</li>
<li>• 可选验证源 DIF 值中的应用程序标记和参考标记。</li>
<li>• 根据描述符的源 DIF 标志字段更新下一个数据块的应用程序标记和参考标记。</li>
</ul>
<p>应检查保护标记、应用程序标记或参考标记中的至少一个；否则，此操作不执行任何操作。</p>
<h2 id="B-2-DIF-插入"><a href="#B-2-DIF-插入" class="headerlink" title="B.2 DIF 插入"></a>B.2 DIF 插入</h2><p>当源数据不包含数据完整性字段时，可以使用 DIF 插入操作来添加数据完整性字段。<br>执行 DIF 插入操作时，设备对每个源数据块执行以下操作：</p>
<ul>
<li>• 计算保护标记。</li>
<li>• 将保护标记、应用程序标记和参考标记组合成 DIF 值。</li>
<li>• 将源数据写入目标，并附加 DIF 值。</li>
<li>• 根据描述符的目标 DIF 标志字段，更新下一个数据块的应用程序标记和参考标记。</li>
</ul>
<p>对于 DIF 插入操作，目标缓冲区大小由下式给出：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919135328217.png" class="" title="image-20240919135328217">

<p>其中 TS 是传输大小（源数据大小），BS 是 DIF 块大小。</p>
<h2 id="B-3-DIF-Strip"><a href="#B-3-DIF-Strip" class="headerlink" title="B.3 DIF Strip"></a>B.3 DIF Strip</h2><p>DIF Strip 操作用于从源数据中删除数据完整性字段。英特尔 DSA 可以在删除字段时选择性地检查字段的有效性。执行 DIF Strip 操作时，设备会对每个源数据块和相关的 DIF 执行以下操作：</p>
<ul>
<li>• 可选择计算保护标记并将其与源 DIF 值中的保护标记字段进行比较。</li>
<li>• 可选择验证源 DIF 值中的应用程序标记和参考标记。</li>
<li>• 将源数据（不带 DIF）写入目标。</li>
<li>• 根据描述符的源 DIF 标志字段，更新下一个数据块的应用程序标记和参考标记。</li>
</ul>
<p>对于 DIF Strip 操作，目标缓冲区大小由下式给出：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919135455518.png" class="" title="image-20240919135455518">

<p>其中 TS 是传输大小（源数据大小），BS 是 DIF 块大小</p>
<h2 id="B-4-DIF-更新"><a href="#B-4-DIF-更新" class="headerlink" title="B.4 DIF 更新"></a>B.4 DIF 更新</h2><p>DIF 更新操作用于用新值替换源数据中的数据完整性字段。<br>Intel DSA 可以选择检查源数据中字段的有效性。执行 DIF 更新操作时，设备对每个源数据块和相关 DIF 执行以下操作：</p>
<ul>
<li>• 计算保护标签值。</li>
<li>• 可选择将计算出的保护标签值与源 DIF 值中的保护标签字段进行比较。</li>
<li>• 可选择验证源 DIF 值中的源应用程序标签和源引用标签。</li>
<li>• 将计算出的保护标签、目标应用程序标签和目标引用标签组合成目标 DIF 值。</li>
<li>• 将源数据写入目标，用目标 DIF 值替换源 DIF 值。</li>
<li>• 根据描述符的源 DIF 标志字段，更新下一个数据块的源应用程序标签和源引用标签。</li>
<li>• 根据描述符的目标 DIF 标志字段，更新下一个数据块的目标应用程序标签和目标引用标签。</li>
</ul>
<p>对于 DIF 更新操作，目标缓冲区大小与传输大小相同。</p>
<p>各种 DIF 操作所需的目标缓冲区大小可按下表计算。如果 DIF 操作未完全完成，则可以根据完成记录的“已完成字节数”字段计算写入目标的字节数。</p>
<p>BS &#x3D; DIF 块大小<br>    N &#x3D; 要处理的块数<br>    M &#x3D; 已完成的块数</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919135640458.png" class="" title="image-20240919135640458">

<h2 id="B-5-DIX-生成"><a href="#B-5-DIX-生成" class="headerlink" title="B.5 DIX 生成"></a>B.5 DIX 生成</h2><p>DIX 插入操作用于计算指定源数据的数据完整性字段。执行 DIX 生成操作时，设备对每个源数据块执行以下操作：</p>
<ul>
<li>• 计算保护标签。</li>
<li>• 将保护标签、应用标签和参考标签组合成一个 DIF 值。</li>
<li>• 将 DIF 值写入目标。</li>
<li>• 根据描述符的目标 DIF 标志字段，更新下一个数据块的应用标签和参考标签。</li>
</ul>
<p>对于 DIX 生成操作，目标缓冲区大小由以下公式给出：</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240919135736701.png" class="" title="image-20240919135736701">

<p>其中 TS 是传输大小（源数据大小），BS 是 DIF 块大小。</p>
<h1 id="附录-C-PCIe-配置寄存器"><a href="#附录-C-PCIe-配置寄存器" class="headerlink" title="附录 C PCIe 配置寄存器"></a>附录 C PCIe 配置寄存器</h1><p>本附录提供了英特尔 DSA 1.0 版 PCIe 配置寄存器的详细信息。版本寄存器在 9.2.1 节中描述。</p>
<h1 id="附录-D-性能监控事件"><a href="#附录-D-性能监控事件" class="headerlink" title="附录 D 性能监控事件"></a>附录 D 性能监控事件</h1><h1 id="附录-E-关键架构扩展摘要"><a href="#附录-E-关键架构扩展摘要" class="headerlink" title="附录 E 关键架构扩展摘要"></a>附录 E 关键架构扩展摘要</h1><p>本节列出了英特尔 DSA 规范 2.0 版中引入的关键架构扩展。<br>软件应查阅设备中的功能寄存器（如第 9.2 节所述）以识别实现中是否存在特定功能。</p>
<img src="/2024/09/13/Intel-DSA-spec/image-20240925125819209.png" class="" title="image-20240925125819209">





<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shaohef/p/12820952.html">intel DSA spec 解读</a></li>
<li><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/search.html?ws=related#q=DSA&sort=relevancy&f:@tabfilter=[Developers]">intel 技术手册</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wpgdadatong.com.cn/blog/detail/72700">第四代英特尔至强数据流加速器，优化实时视频传输</a></li>
<li><a target="_blank" rel="noopener" href="https://www.owalle.com/2021/11/05/dsa-overview/">Intel® DSA 综述</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ctyun.cn/developer/article/473663151341637">英特尔Data Streaming Accelerator简介</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011458874/article/details/124898895">英特尔 数据流加速器简介</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wpgdadatong.com/blog/detail/74240">Intel DSA 技術應用</a></li>
<li><a target="_blank" rel="noopener" href="https://lrl52.top/1179/introduction-to-intel-dsa-config-and-test/">Introduction to Intel® DSA Config and Test</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/intel/" rel="tag"># intel</a>
              <a href="/tags/DSA/" rel="tag"># DSA</a>
              <a href="/tags/PCIe/" rel="tag"># PCIe</a>
              <a href="/tags/DMA/" rel="tag"># DMA</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/09/13/win10-server/" rel="prev" title="win10-server">
                  <i class="fa fa-angle-left"></i> win10-server
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/09/24/PCIe/" rel="next" title="PCIe">
                  PCIe <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wu JInlin</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
